var App=function(t){"use strict";var e={},i={init:function(){this.$body=t("body"),this.MOBILE_STRING="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0",this.isAndroid=/(android)/i.test(navigator.userAgent),this.is_iOS=/iPad|iPhone|iPod/i.test(navigator.userAgent),this.initialHeight=window.outerHeight,this.metaViewport=document.querySelector("meta[name=viewport]"),this.behaviors()},behaviors:function(){var e=this;t(window).on("resize",(function(){e.isAndroid&&(e.TMR_RESIZE&&clearTimeout(e.TMR_RESIZE),e.TMR_RESIZE=setTimeout((function(){e.update_meta()}),150))}))},is_mobile:function(){return this.isAndroid||this.is_iOS},is_showed_any_menu:function(){return window[e.G_DATA].SHOWED>0},update_meta:function(){var t=this;this.is_showed_any_menu()&&(window.innerHeight<t.initialHeight/3*2?(t.$body.addClass("android_keyboard_open"),t.metaViewport.setAttribute("content","height="+t.initialHeight+", width=device-width, initial-scale=1.0")):(t.$body.removeClass("android_keyboard_open"),t.metaViewport.setAttribute("content",this.MOBILE_STRING)))},prepare:function(){var e=t("meta[name=viewport]");if(e.length)this.OLD_VIEWPORT=e[0].content.toString();else{this.OLD_VIEWPORT="";var i=document.createElement("meta");i.name="viewport",i.content="",document.getElementsByTagName("head")[0].appendChild(i),e=t("meta[name=viewport]")}},turn_on_mobile:function(e){var i=t("meta[name=viewport]");i[0].content=e?this.MOBILE_STRING:this.OLD_VIEWPORT}},s={get:function(){return"Rand_"+Math.random().toString(36).substring(2,15)+"_"+Math.random().toString(36).substring(2,15)}},n={bhv:function(e){if(e&&e.length){var i=function(t){return t.hasClass("mm2-disabled")};e.forEach((function(e){e.on("mouseover",(function(e){!i(t(this))&&t(this).addClass("hover")})),e.on("mouseout",(function(e){!i(t(this))&&t(this).removeClass(" hover")})),e.on("mousedown",(function(e){!i(t(this))&&t(this).addClass("active")})),e.on("mouseup",(function(e){!i(t(this))&&t(this).removeClass("active ")})),e.on("touchstart",(function(e){!i(t(this))&&t(this).addClass("mobile-active")})),e.on("touchend",(function(e){!i(t(this))&&t(this).removeClass("mobile-active")}))}))}}};const o={formatBytes:(t,e=2)=>{if(0===t)return"0";var i=e<0?0:e,s=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,s)).toFixed(i))+" "+["байт","КБ","МБ","ГБ","ТБ"][s]}};var a={init:function(e){this.$allview=t(e),this.arrViews={},this.stackNames=[],this.viewsCount=0,this.CURRENT_VIEW_NAME="",this.CFG={speed:".6s",transition:".6s cubic-bezier(0.25, 1, 0.5, 1)"},this.$protectLayer=t("<div></div>").css({background:"rgba(0,0,0,0)",width:"100%",height:"100%",position:"absolute",top:0,left:0,zIndex:1e3,display:"none"}),this.$allview.append(this.$protectLayer)},addview:function(t){var e=t._get_view(),i=t._get_name();e.css({transform:"translate3d(100%,0,0)",opacity:0}),this.$allview.append(e),this.stackNames.push(i),this.arrViews[i]={view:t,level:this.viewsCount},this.viewsCount++},get:function(){return this.arrViews},bhv_protect:function(t){var e=this;this.$protectLayer.show(),setTimeout((function(){e.$protectLayer.hide()}),t)},get_name_by_level:function(t){return this.stackNames[t]},get_level_by_name:function(t){return this.arrViews[t].level},get_view_by_level:function(t){return this.get_view_by_name(this.get_name_by_level(t))},get_anim_by_viewname:function(t){return this.arrViews[t].view._get_anim()},get_view_by_name:function(t){return this.arrViews[t].view._get_view()},get_current_view:function(){return this.get_view_by_name(this.CURRENT_VIEW_NAME)},get_current_level:function(){return this.CURRENT_VIEW_NAME?this.get_level_by_name(this.CURRENT_VIEW_NAME):0},is_forward:function(t){return this.get_level_by_name(this.CURRENT_VIEW_NAME)<this.get_level_by_name(t)},move_forward:function(t,e,i){"animLeft"==i?(t&&t.css({transform:"translate3d(-50%,0,0)",transition:"transform "+this.CFG.transition}),e&&e.css({transform:"translate3d(0,0,0)",transition:"transform "+this.CFG.transition,opacity:1})):"zoomOut"==i&&(e.css({transform:"translate3d(0,0,0) scale(1.1)",transition:"0s",opacity:0}),setTimeout((()=>{e.css({transform:"translate3d(0,0,0) scale(1)",transition:".3s",opacity:1})}),50))},move_backward:function(t,e,i){var s=this;"animLeft"==i?(e&&e.css({transform:"translate3d(-50%,0,0)",transition:"all 0s",opacity:1}),setTimeout((()=>{e&&e.css({transform:"translate3d(0,0,0)",transition:"transform "+s.CFG.transition}),t&&t.css({transform:"translate3d(100%,0,0)",opacity:0,transition:"transform "+s.CFG.transition+", opacity 0s "+s.CFG.speed})}),50)):"zoomOut"==i&&(t&&t.css({transform:"translate3d(0,0,0) scale(1.1)",transition:".3s",opacity:0}),setTimeout((()=>{t&&t.css({transform:"translate3d(100%,0,0)",transition:"0s",zIndex:0})}),400))},park_view:function(t){t&&t.css({transform:"translate3d(100%,0,0)",opacity:0,transition:"transform 0s"})},set_current:function(t){if(!this.arrViews[t])return console.log("unknown the name"),!1;if(t==this.CURRENT_VIEW_NAME)return console.log(" the same name"),!1;if(console.log("current view tpl name",t),this.bhv_protect(700),this.CURRENT_VIEW_NAME){const e=this.get_current_view(),i=this.get_view_by_name(t),s=this.get_anim_by_viewname(t);this.is_forward(t)?this.move_forward(e,i,s):this.move_backward(e,i,s),this.CURRENT_VIEW_NAME=t}else{this.CURRENT_VIEW_NAME=t;this.get_current_view().css({transform:"translate3d(0,0,0)",opacity:1})}performance.memory&&console.log("performance.memory",e.CMN.formatBytes(performance.memory.usedJSHeapSize))},go_back:function(){var t=this.get_current_level();if(t>0){this.bhv_protect(700);const e=this.get_current_view(),i=this.get_view_by_level(t-1),s=this.get_name_by_level(t),n=this.get_name_by_level(t-1),o=this.get_anim_by_viewname(s);this.move_backward(e,i,o),this.CURRENT_VIEW_NAME=n}},go_first:function(t){for(var e=this.get_current_level(),i=t?1:0,s=1;s<e+i;s++){var n=this.get_view_by_level(s);this.park_view(n)}var o=this.get_name_by_level(0);t?o!=this.CURRENT_VIEW_NAME&&(this.CURRENT_VIEW_NAME=o,this.get_current_view().css({transform:"translate3d(0,0,0)",transition:"transform 0s",opacity:1})):this.set_current(o)}},r={init:function(t){t=t||"en";this.CURRENT_LANG=t.toLowerCase(),this.ARR_LANGS=["en","ru","it"],this.LANG_CURRENT_INDEX=this.get_index(t),this.LANG_DATA={lng_amount:["Total amount:","Сумма:"],lng_address:["Address:","Адрес:"],lng_tel:["Ph.:","Тел.:"],lng_back:["Back","Назад"],lng_save:["Save","Сохранить"],lng_choose:["Choose","Выбрать"],lng_bookmarks:["Bookmarks","Закладки"],lng_close:["Close","Закрыть"],lng_day_after_tomorrow:["Day after tomorrow","Послезавтра"],lng_now:["Now","Сейчас"],lng_no_items:["no items","нет товаров"],lng_in_an_hour:["In an hour","Через час"],lng_in_two_hours:["In 2 hours","Через 2 часа"],lng_in_three_hours:["In 3 hours","Через 3 часа"],lng_order_comments:["Comments to the order:","Комментарии к заказу:"],lng_send:["Send","Отправить"],lng_more:["More...","Подробнее..."],lng_ordering:["Ordering","Оформление заказа"],lng_shopping_cart:["Your Cart","Корзина"],lng_sending_an_order:["Sending an order","Отправка заказа"],lng_rollup:["Roll-Up","Свернуть"],lng_today:["Today","Сегодня"],lng_tomorrow:["Tomorrow","Завтра"],lng_to_clear:["Clear","Очистить"],lng_to_bookmarks:["To bookmarks","В закладки"],lng_total:["Total:","Итого:"],lng_your_order:["Your order","Ваш заказ"],lng_you_ordered:["You ordered:","Вы заказали:"],lng_flag_spicy:["Spicy","Острое"],lng_flag_hit:["Hit","Хит"],lng_flag_vege:["Vege","Веге"],lng_our_adress:["Our address:","Наш адрес:"],lng_chef_cook:["Chef-cook:","Шеф-повар:"],lng_work_hours:["Work hours:","Часы работы:"],lng_motto:["QR-Menu – simple!","QR-Меню – просто!"],lng_cafe_desc_title:["Welcome!","Добро пожаловать!"],lng_cart_is_off:["The cart disabled <br>by admin","Корзина отключена <br>администратором"],lng_cart_is_empty:["The cart is empty","Корзина пуста"],lng_clear_shopping_cart:["Clear shopping cart","Очистить корзину"],lng_proceed_to_checkout:["Continue to<br>Checkout","Оформить<br>заказ"],lng_pick_up_the_order_myself:["I`ll pick it up<br> myself","Заберу сам"],lng_choosing_delivering:["Choose time and <br>place of delivery","Выбрать время<br>и место доставки"],lng_your_phone:["My phone:","Мой телефон:"],lng_need_user_phone:["Please provide your phone to clarify the details of the order","Внимание, укажите свой телефон для уточнения деталей заказа"],lng_where_to_deliver:["Where to deliver:","Куда доставить:"],lng_need_user_address:["Please specify the delivery address of the order","Внимание, укажите адрес доставки заказа"],lng_date_time_to:["When would you like your order:","Дата и время доставки:"],lng_pick_it_up_at:["I`ll pick up an order:","Заберу заказ:"],lng_your_shopping_cart_is_empty:["There are no products in your shopping cart","В вашей корзине нет товара"],lng_for_total_cost:["for total cost:","на общую сумму:"],lng_in_your_shopping_cart:["In your shopping cart:","В вашей корзине:"],lng_all_months:["January-February-March-April-May-June-July-August-September-October-November-December","Января-Февраля-Марта-Апреля-Мая-Июня-Июля-Августа-Сентября-Октября-Ноября-Декабря"],lng_number_of_your_order:["Your order number:","Номер вашего заказа:"],lng_time_from:["Order created:","Заявка создана:"],lng_time_to:["Order to:","Заказ на:"],lng_near_time:["soon","ближайшее время"],lng_order_sent:["Order sent","Заказ отправлен"],lng_thankful_msg:["The manager will contact you to confirm the order as soon as posible","В ближайшее время наш менеджер свяжется с вами для подтверждения заказа"],lng_thankful_waiter_msg:["Great! Your order has been sent and will be processed soon.","Отлично! Ваш заказ отправлен и скоро будет принят в работу"],lng_menu_is_in_demo_mode_msg:["The menu is in demo mode. The cafe administrator is not waiting a messages at the moment.","Меню находится в демонстрационном режиме. Администратор кафе не ожидает сообщений в данный момент."],lng_menu_is_in_demo_mode_msg_2:["If you are an Administrator, set up Telegram to receive orders.","Если вы Администратор, настройте Телеграм, чтобы получать заказы."],lng_something_wrong:["Something went wrong. Order can not be shipped now. <br>Try later","Что-то пошло не так. Заказ не может быть отправлен сейчас. <br>Попробуйте позже"],lng_wrong_phone:["Order can not be shipped. <br>Check the correctness of the phone you entered, please.","Заказ не может быть отправлен. <br>Проверьте правильность введенного вами телефона."]}},update:function(t){this.LANG_CURRENT_INDEX=this.get_index(t)},get_index(t){for(var e=0,i=this.ARR_LANGS,s=(t=t.toLowerCase(),0);s<i.length;s++)t===i[s]&&(e=s);return e},get_current:function(){return this.CURRENT_LANG},get_lang:function(){return this.ARR_LANGS[this.LANG_CURRENT_INDEX]},get:function(t){t=t.toLowerCase();return this.LANG_DATA[t]?this.LANG_DATA[t][this.LANG_CURRENT_INDEX]:"Unknown"}},_={init:function(){this.CN="mm2-",this._CN="."+this.CN,this.CLASS_CART_SWITCHED_OFF="mm2-cart-switched-off",this.$menu=t(this._CN+"menu"),this.$btnCartFooter=t(this._CN+"btn-basket__text"),this.cart_clear(),this.update_mode()},update_mode:function(){this.is_off()?this.$menu.addClass(this.CLASS_CART_SWITCHED_OFF):this.$menu.removeClass(this.CLASS_CART_SWITCHED_OFF)},add_preorder:function(t){console.log("add_preorder!",t);let e=this.get_total_orders(t.itemId);const i=this.ALL_ORDERS[t.uniq_name];return i?i.count+=t.count:this.ALL_ORDERS[t.uniq_name]=t,this.update_btn_cart(),e+t.count},get:function(t){return this.ALL_ORDERS[t]},get_all:function(){return console.log("get_all",this.ALL_ORDERS),this.ALL_ORDERS},get_total_orders:function(t){let e=0;if(t){for(let i in this.ALL_ORDERS)if(this.ALL_ORDERS.hasOwnProperty(i)){let s=this.ALL_ORDERS[i];s&&s.itemId==t&&(e+=s.count)}}else for(let t in this.ALL_ORDERS)if(this.ALL_ORDERS.hasOwnProperty(t)){let i=this.ALL_ORDERS[t];i&&(e+=i.count)}return e},get_total_price:function(){let t=0;for(let e in this.ALL_ORDERS)if(this.ALL_ORDERS.hasOwnProperty(e)){let i=this.ALL_ORDERS[e];i&&(t+=parseInt(i.price_with_modifiers,10)*i.count)}return t},add_one:function(t){let e=this.ALL_ORDERS[t];e&&(e.count++,this.update_btn_cart())},remove_one:function(t){let e=this.ALL_ORDERS[t];e&&(e.count--,e.count||delete this.ALL_ORDERS[t],this.update_btn_cart())},update_btn_cart:function(){this.get_total_orders()>0?this.$menu.addClass("cart-is-full"):this.$menu.removeClass("cart-is-full"),this.$btnCartFooter.html(this.the_total())},the_total:function(){return`${this.get_total_price()} ${e.CAFE.get("cafe_currency").symbol}`},cart_clear:function(t){this.ALL_ORDERS={},this.update_btn_cart()},is_off:function(){return 1!==parseInt(e.CAFE.get("cart_mode"),10)},is_empty:function(){var t=0,e=this.get_all();for(var i in e)e.hasOwnProperty(i)&&t++;return 0==t},the_items:function(){var t=this.get_total_orders(),i=e.LNG.get_lang();return t?{ru_parse:function(t){var e=parseInt(t.toString().substr(-1),10);return 1==e?t+" товар":e>1&&e<5?t+" товара":t+" товаров"},en_parse:function(t){return 1==parseInt(t.toString().substr(-1),10)?t+" item":t+" items"},it_parse:function(t){return 1==parseInt(t.toString().substr(-1),10)?t+" item":t+" items"}}[i+"_parse"](t):e.LNG.get("lng_no_items")}};const h={init:function(t,e){return this.ITEM_DATA=t,this.onUpdate=e.onUpdate,this.CN="mm2-",this._CN="."+this.CN,this.reset(),this.build(),this},reset:function(){this.VARS={price:0,originalPrice:0,sizeGroupId:"",sizeName:"",volume:"",units:""}},get_ui:function(){return[this.$arr_btns.mobile,this.$arr_btns.desktop]},get:function(){return this.VARS},get_all:function(){return this.ITEM_DATA.iiko_sizes_parsed},set_current_vars:function(t){this.VARS=t},build:function(){var t=this;const e=this.get_all(),i={create_btns:s=>{for(var n=0;n<e.length;n++){const o=e[n],a="true"==o.isDefault?" active":"",r=$("<div></div>",{class:this.CN+"item-size-btn "+a}),_=o.price||0,h=o.originalPrice||0,l=o.sizeGroupId||"",c=o.sizeName||"",d=o.portionWeightGrams||0,u=i.units_to_strings(o.measureUnitType),m=o.sizeId||"",f=o.sizeCode||"";r.html(`${c}<br>${d} ${u}`),function(e,i,s,n,o,a){e.on("touchend click",(function(r){t.change_current_size({$btn:e,index:i,price:s,originalPrice:n,sizeGroupId:o,sizeName:a,volume:d,units:u,sizeId:m,sizeCode:f}),r.originalEvent.cancelable&&r.preventDefault()}))}(r,n,_,h,l,c),"true"==o.isDefault&&this.set_current_vars({price:_,originalPrice:h,sizeGroupId:l,sizeName:c,volume:d,units:u,sizeId:m,sizeCode:f}),s.append(r)}},units_to_strings:t=>({MILLILITER:"мл",KILOGRAM:"кг",LITER:"л",GRAM:"г","ПОРЦ":"порц"}[t]||"")};if(this.$arr_btns={mobile:$("<div></div>"),desktop:$("<div></div>")},e)if(e.length>1)i.create_btns(this.$arr_btns.mobile),i.create_btns(this.$arr_btns.desktop);else{const t=e[0],s=t.price,n=t.originalPrice,o=t.sizeGroupId,a=t.portionWeightGrams,r=i.units_to_strings(t.measureUnitType),_=t.sizeName,h=t.sizeId||"",l=t.sizeCode||"";this.set_current_vars({price:s,originalPrice:n,sizeGroupId:o,sizeName:_,volume:a,units:r,sizeId:h,sizeCode:l})}else this.reset()},change_current_size:function(t){this.set_current_vars(t),this.onUpdate&&this.onUpdate(t),t.$btn.addClass("active").siblings().removeClass("active")}},l={init:function(t){return this.item_data=t,this.MODIFIERS=[],this.OBJ_MODIFIERS={},this.arr_usr_chosen=[],this.total_modif_price=0,this.MODIF_SCROLLED=!1,this.HAS_GROUPS_MODE=!0,this.$m_list_all=$('<div class="all-modifs-list"></div>'),this._init_modif_with_groups(),this._build_list_ui_with_groups(),this.behavior(),this},get_by_id:function(t=null){return t?this.OBJ_MODIFIERS[t]:null},get:function(t=null){return this.MODIFIERS},get_ui:function(){return this.$m_list_all},get_cost:function(){return this.total_modif_price},get_selected:function(){return this.arr_usr_chosen},reset:function(){const t=this.$MODIFIERS_ROWS;t&&t.length&&t.each(((t,e)=>{$(e).hasClass("chosen-by-default")?$(e).addClass("chosen"):$(e).removeClass("chosen")}))},recalc:function(){return this._do_recalc_with_groups()},on_change:function(t){this.on_change=t},behavior:function(){this.$m_list_all.on("touchstart",(t=>{this.MODIF_SCROLLED=!1})),this.$m_list_all.on("touchmove",(t=>{this.MODIF_SCROLLED=!0}))},_init_modif_with_groups:function(){let t=this.item_data.iiko_modifiers_parsed;this.MODIFIERS=[...t];this.OBJ_MODIFIERS=(t=>{const e={};for(let i in t){let s=t[i].items;if(s&&s.length)for(let t in s){let i=s[t];e[i.modifierId]=i}}return e})(this.MODIFIERS),console.log(" ====== this.MODIFIERS ====== ",this.MODIFIERS),console.log(" ====== this.OBJ_MODIFIERS ====== ",this.OBJ_MODIFIERS)},_do_recalc_with_groups:function(){const t=()=>{const t=[];let e=0;return this.get()&&this.$MODIFIERS_ROWS&&this.$MODIFIERS_ROWS.length?(this.$MODIFIERS_ROWS.each(((i,s)=>{if($(s).hasClass("chosen")){const i=$(s).data("modifier-id"),n=this.get_by_id(i);n&&(t.push(n),e+=parseInt(n.price,10))}})),[t,e]):[t,0]};let[e,i]=t();return this.arr_usr_chosen=e,this.total_modif_price=parseInt(i,10),{arr_usr_chosen:this.arr_usr_chosen,total_modif_price:this.total_modif_price}},_build_list_ui_with_groups:function(){let t=this.get();if(!t.length)return;const i=t=>{if(!t.items||!t.items.length)return null;let e=t.modifierGroupId??"",i=t.name??"–",s=parseInt(t.restrictions.maxQuantity,10),n=!1;t.restrictions&&(n=1==s&&t.items.length>1);let o=$(`<div class="modif-group-wrapper" ${`data-group-id="${e}" \n\t\t\t\t\tdata-group-name="${i}" \n\t\t\t\t\tdata-max-quantity="${s}" \n\t\t\t\t\tdata-radio-mode="${n}"`}>${`<div class="modifiers-group-name">${i} ${s>1?`( до ${s} )`:""}</div>`}</div>`);console.log("g",t);let a=$("<ul></ul>");const r=n?"type-radio":"",_=n?"mode-radio":"";let h=0;for(let e in t.items){let i=t.items[e],s="",o="";parseInt(i.restrictions.byDefault,10)>0&&(s="chosen",o="chosen-by-default");const l=i.price>0?"+ "+i.price+" руб.":"";a.append([`<li class="btn-modifier ${_} ${s} ${o}" data-modifier-id="${i.modifierId}">`,`<div class="m-check ${r}"><span></span></div>`,`<div class="m-title">${i.name}</div>`,`<div class="m-price">${l}</div>`,"</li>"].join("")),h++,n&&h==t.items.length&&"chosen"!==s&&(console.log(`m_counter = ${h}, g.items.length = ${t.items.length}, chosen!='chosen', ${"chosen"!==s}`),a.find("li:first").addClass("chosen").addClass("chosen-by-default"))}return o.append(a),o},s=t=>{const i={toggleCheckbox:t=>{t.hasClass("chosen")?t.removeClass("chosen"):i.canEncrease(t)&&t.addClass("chosen")},toggleRadioButton:t=>{t.siblings().removeClass("chosen"),t.addClass("chosen")},canEncrease:t=>{const e=t.siblings().filter(".chosen").length,i=parseInt(t.closest(".modif-group-wrapper").data("max-quantity"),10);return!(e>=i)||(console.log("countChosen",e,"maxQuantity",i),!1)}};t.on("touchend click",(t=>{if(!this.MODIF_SCROLLED){const e=$(t.currentTarget);e.hasClass("mode-radio")?i.toggleRadioButton(e):i.toggleCheckbox(e),this.on_change&&this.on_change()}t.originalEvent.cancelable&&t.preventDefault()})),e.MOBILE_BUTTONS.bhv([t])};for(let e=0;e<t.length;e++){const s=i(t[e]);s&&this.$m_list_all.prepend(s)}this.$MODIFIERS_ROWS=this.$m_list_all.find("li"),s(this.$MODIFIERS_ROWS)}},c={init:function(t,e){return this.item_data=t,this.opt=e,this.on_update_size=this.opt.on_update_size,this.on_update_total_in_cart=this.opt.on_update_total_in_cart,this.MODIF_PANEL=this.opt.modifiers_panel,this.TOTAL_ADD_TO_CART=1,this._prepare(),this},get:function(){return this.item_data},has_modifiers:function(){return""!==this.item_data.iiko_modifiers},has_sizes:function(){return this.item_data.iiko_sizes_parsed&&this.item_data.iiko_sizes_parsed.length>1},get_preorder:function(t){const e=this.IIKO_SIZER.get(),i=this.calc_order_uniq_name(`iiko-order-${this.item_data.id}`),s=this.IIKO_MODIFIERS.get_selected(),n=this.IIKO_MODIFIERS.get_cost(),o=this.get_price(),a=o+n;return{itemId:this.item_data.id,uniq_name:i,price:o,price_with_modifiers:a,count:t,volume:e.volume,units:e.units,item_data:this.item_data,sizeName:e.sizeName,sizeId:e.sizeId||"",sizeCode:e.sizeCode||"",originalPrice:e.originalPrice||"",sizeGroupId:e.sizeGroupId||"",chosen_modifiers:s}},get_price:function(){const t=this.IIKO_SIZER.get();return parseInt(t.price,10)},sizer_get_vars:function(){return this.IIKO_SIZER.get()},get_ui_price_buttons:function(){return this.IIKO_SIZER.get_ui()},_prepare:function(){""!==this.item_data.iiko_sizes&&(this.item_data.iiko_sizes_parsed=JSON.parse(this.item_data.iiko_sizes)),this.item_data.iiko_modifiers?this.item_data.iiko_modifiers_parsed=JSON.parse(this.item_data.iiko_modifiers):this.item_data.iiko_modifiers_parsed=[],this.IIKO_SIZER=$.extend({},h),this.IIKO_SIZER.init(this.item_data,{onUpdate:this.on_update_size}),this.IIKO_MODIFIERS=$.extend({},l),this.IIKO_MODIFIERS.init(this.item_data),this.IIKO_MODIFIERS.on_change((()=>{this.update_modif_panel_ui()})),this.has_modifiers()&&this.MODIF_PANEL&&(this.MODIF_PANEL.add(this.IIKO_MODIFIERS),this.MODIF_PANEL.on_pressed_cart((()=>{const t=this.get_preorder(this.TOTAL_ADD_TO_CART);let i=e.CART.add_preorder(t);this.on_update_total_in_cart&&this.on_update_total_in_cart(i),this.MODIF_PANEL.close()})),this.MODIF_PANEL.on_pressed_plus((()=>{this.TOTAL_ADD_TO_CART++,this.update_modif_panel_ui()})),this.MODIF_PANEL.on_pressed_minus((()=>{this.TOTAL_ADD_TO_CART-1>0?(this.TOTAL_ADD_TO_CART--,this.update_modif_panel_ui()):this.MODIF_PANEL.close()})),this.update_modif_panel_ui())},calc_order_uniq_name:function(t){if(this.has_sizes()||this.IIKO_MODIFIERS.get_selected().length>0){return`${t}-${Math.floor(Date.now()*Math.random()/1e3).toString()}`}return t},update_modif_panel_ui(){let t=this.get_price();const{arr_usr_chosen:e,total_modif_price:i}=this.IIKO_MODIFIERS.recalc();e.length>0&&(t+=i),this.MODIF_PANEL.show_price(t,this.TOTAL_ADD_TO_CART)}};var d={init:function(t,e){return this.ITEM_DATA=t,this.onUpdate=e.onUpdate,this.CN="mm2-",this._CN="."+this.CN,this.reset(),this.build(),this},reset:function(){this.VARS={price:0,sizeName:"",volume:"",units:""}},get_ui:function(){return[this.$arr_btns.mobile,this.$arr_btns.desktop]},get:function(){return this.VARS},get_all:function(){return this.ITEM_DATA.sizes_parsed},set_current_vars:function(t){this.VARS=t},build:function(){var t=this;const e=this.get_all(),i=i=>{for(var s=0;s<e.length;s++){const n=e[s],o=0==s?" active":"",a=$("<div></div>",{class:this.CN+"item-size-btn "+o}),r=n.price||0,_=n.volume||0,h=n.units||"г",l="";a.html(`${_} ${h}`),function(e,i,s,n,o,a){e.on("touchend click",(function(r){t.change_current_size({$btn:e,index:i,price:s,sizeName:n,volume:o,units:a}),r.originalEvent.cancelable&&r.preventDefault()}))}(a,s,r,l,_,h),0==s&&this.set_current_vars({price:r,sizeName:l,volume:_,units:h}),i.append(a)}};if(this.$arr_btns={mobile:$("<div></div>"),desktop:$("<div></div>")},e)if(e.length>1)i(this.$arr_btns.mobile),i(this.$arr_btns.desktop);else{const t=e[0],i=t.price,s=t.volume,n=t.units,o="";this.set_current_vars({price:i,sizeName:o,volume:s,units:n})}else this.reset()},change_current_size:function(t){this.set_current_vars(t),this.onUpdate&&this.onUpdate(t),t.$btn.addClass("active").siblings().removeClass("active")}};const u={init:function(t,e){return this.item_data=t,this.opt=e,this.on_update_size=this.opt.on_update_size,this.on_update_total_in_cart=this.opt.on_update_total_in_cart,this.TOTAL_ADD_TO_CART=1,this._prepare(),this},get:function(){return this.item_data},has_modifiers:function(){return!1},has_sizes:function(){return this.item_data.sizes_parsed&&this.item_data.sizes_parsed.length>1},get_preorder:function(t){const e=this.CHEFS_SIZER.get(),i=this.calc_order_uniq_name(`chefs-order-${this.item_data.id}`),s=this.get_price();return{itemId:this.item_data.id,uniq_name:i,price:s,count:t,volume:e.volume,units:e.units,item_data:this.item_data,sizeName:e.sizeName,chosen_modifiers:""}},get_price:function(){const t=this.CHEFS_SIZER.get();return parseInt(t.price,10)},sizer_get_vars:function(){return this.CHEFS_SIZER.get()},get_ui_price_buttons:function(){return this.CHEFS_SIZER.get_ui()},_prepare:function(){""!==this.item_data.sizes&&(this.item_data.sizes_parsed=JSON.parse(this.item_data.sizes)),this.CHEFS_SIZER=$.extend({},d),this.CHEFS_SIZER.init(this.item_data,{onUpdate:this.on_update_size})},calc_order_uniq_name:function(t){if(this.has_sizes()){return`${t}-${Math.floor(Date.now()*Math.random()/1e3).toString()}`}return t}};var m={init:function(t,e){return this.$item=t,this.CN="mm2-",this._CN="."+this.CN,this.opt=e,this.CLASS_SHOWED_MODIFIERS="showed-modifiers",this.$modif_panel_space=this.$item.find(this._CN+"item-modifiers-panel__tops-space"),this.$modif_panel_list_wrapper=this.$item.find(this._CN+"item-modifiers-panel__list-wrapper"),this.$modif_panel_footer=this.$item.find(this._CN+"item-modifiers-panel__footer"),this.$modif_btn_cart=this.$modif_panel_footer.find(".btn-cart"),this.$modif_btn_plus=this.$modif_panel_footer.find(".btn-plus"),this.$modif_btn_minus=this.$modif_panel_footer.find(".btn-minus"),this.$modif_total_in_cart=this.$modif_panel_footer.find(".total-in-cart"),this.MODIFIERS_LIST_SHOWING_NOW=!1,this.behavior(),this},behavior:function(){e.MOBILE_BUTTONS.bhv([this.$modif_btn_cart,this.$modif_btn_plus,this.$modif_btn_minus]),this.$modif_btn_cart.on("touchend click",(t=>{this.on_pressed_cart&&this.on_pressed_cart(),t.originalEvent.cancelable&&t.preventDefault()})),this.$modif_btn_minus.on("touchend click",(t=>{this.on_pressed_minus&&this.on_pressed_minus(),t.originalEvent.cancelable&&t.preventDefault()})),this.$modif_btn_plus.on("touchend click",(t=>{this.on_pressed_plus&&this.on_pressed_plus(),t.originalEvent.cancelable&&t.preventDefault()})),this.$modif_panel_space.on("touchend click touchmove",(t=>{this.close()}))},close:function(){this.$item.removeClass(this.CLASS_SHOWED_MODIFIERS),this.opt&&this.opt.on_close&&this.opt.on_close()},open:function(){this.$item.addClass(this.CLASS_SHOWED_MODIFIERS),this.opt&&this.opt.on_open&&this.opt.on_open()},add:function(t){this.MODIFIERS_LIST=t,this.$modif_panel_list_wrapper.append(this.MODIFIERS_LIST.get_ui())},show_price:function(t,e){let i=t*e+" руб.";i=(this.MODIFIERS_LIST?this.MODIFIERS_LIST.get_selected().length:0)>0?`В корзину<br>${i}`:`Без опций<br>${i}`,this.$modif_btn_cart.html(i),this.$modif_total_in_cart.html(e.toString())},reset:function(){this.MODIFIERS_LIST&&this.MODIFIERS_LIST.reset()},on_pressed_cart:function(t){this.on_pressed_cart=t},on_pressed_plus:function(t){this.on_pressed_plus=t},on_pressed_minus:function(t){this.on_pressed_minus=t}};t.fn.swipe=function(e){var i,s,n,o=t.extend({preventDefault:!0,enableMouse:!0,distance:100,fastSwipe:!0,onTouch:function(t){},onMove:function(t){},onSwipe:function(t){},onEnd:function(){}},e||{});return this.each((function(){var e,a,r,_,h=t(this),l=!1,c={touchStart:function(t){if(!(t.targetTouches.length>1)){n=!1;var s=t.targetTouches[0];r=s.pageX,_=s.pageY,e=s.pageX,a=s.pageY,i=new Date,o.onTouch({clientX:s.clientX,clientY:s.clientY,pageX:s.pageX,pageY:s.pageY,screenX:s.screenX,screenY:s.screenY})}},mouseDown:function(t){n=!1,l=!0,r=t.pageX,_=t.pageY,e=t.pageX,a=t.pageY,i=new Date,o.onTouch({clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,screenX:t.screenX,screenY:t.screenY}),o.preventDefault&&t.preventDefault()},mouseMove:function(t){l&&(o.onMove({deltaX:t.pageX-e,deltaY:t.pageY-a,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,screenX:t.screenX,screenY:t.screenY}),e=t.pageX,a=t.pageY),o.fastSwipe&&!n&&c.testSwipe(),o.preventDefault&&t.preventDefault()},moveEnd:function(t){l&&(l=!1,!n&&c.testSwipe()),o.preventDefault&&t.preventDefault(),o.onEnd()},touchEnd:function(t){l=!1,!n&&c.testSwipe(),o.onEnd()},touchMove:function(t){if(!(t.targetTouches.length>1)){var i=t.targetTouches[0];o.onMove({deltaX:i.pageX-e,deltaY:i.pageY-a,clientX:i.clientX,clientY:i.clientY,pageX:i.pageX,pageY:i.pageY,screenX:i.screenX,screenY:i.screenY,evt:t}),e=i.pageX,a=i.pageY,o.preventDefault&&t.preventDefault(),o.fastSwipe&&!n&&c.testSwipe()}},testSwipe:function(){var t=e-r,h=a-_;if(s=Math.abs(new Date-i)/1e3,Math.abs(t)>=Math.abs(h)){if(Math.abs(t)>=o.distance){n=!0;var l=t>=0?"right":"left";o.onSwipe({direction:l,distance:Math.abs(t),speed:Math.abs(t)/s,time:s})}}else if(Math.abs(h)>=o.distance){n=!0;l=h>=0?"down":"up";o.onSwipe({direction:l,distance:Math.abs(h),speed:Math.abs(h)/s,time:s})}},touchCancel:function(t){}};o.enableMouse&&(h.mousedown((function(t){1==((t=t||window.event).keyCode||t.which)&&c.mouseDown(t)})),h.mouseup(c.moveEnd),t("body").mouseup(c.moveEnd),h.mousemove(c.mouseMove)),this.addEventListener("touchstart",c.touchStart),this.addEventListener("touchmove",c.touchMove),this.addEventListener("touchend",c.touchEnd),this.addEventListener("touchcancel",c.touchCancel)}))};var f={init:function(i,s,n){return this.NOW_IN_VIEWPORT=!1,this.objParent=i,this.$elParent=i.get_element(),this.item_data=s,this.INDEX=n,this.CN="mm2-",this._CN="."+this.CN,this.CART_OFF=e.CART.is_off(),this.CLASS_DISABLED=this.CN+"disabled",this.$tpl=t("#mm2-templates "+this._CN+"item"),this.$item=this.$tpl.clone(),this.$item.css({transform:"translateX("+100*this.INDEX+"%)"}),""==this.item_data.image_url&&this.$item.addClass("has-no-image"),this.$btnAddToCart=this.$item.find(this._CN+"item-btn-addtocart"),this.$totalInCart=this.$item.find(this._CN+"item-btn-addtocart__count"),this.$itemData=this.$item.find(this._CN+"item-data"),this.$itemFlags=this.$item.find(this._CN+"item-flags2"),this.$itemImageContainer=this.$item.find(this._CN+"item-image"),this.$itemDataContainer=this.$item.find(this._CN+"item-data-container"),this.$descr=this.$item.find(this._CN+"item-description"),this.$bhvPortrait=this.$item.find(this._CN+"item-bhv-portrait"),this.$bhvLandscape=this.$item.find(this._CN+"item-bhv-landscape"),this.CLASS_PLAY_ADDTOCART=this.CN+"play-addtocart",this.CLASS_LARGE_IMAGE=this.CN+"show-large-image",this.CLASS_FULL_DESCRIPTION=this.CN+"show-full-description",this.CLASS_IMAGE_READY_TO_ZOOM=this.CN+"image-ready-to-zoom",this.STARTSCROLL=0,this.DESCR_SCROLLED=!1,this.CART_OFF&&this.$btnAddToCart.addClass(this.CLASS_DISABLED),this.$item_price=this.$item.find(this._CN+"item-price span"),this.$item_volume=this.$item.find(this._CN+"item-volume"),this.$item_volume2=this.$item.find(this._CN+"item-volume2"),this.$item_btns_sizes_wrapper_mobile=this.$item.find(this._CN+"item-btns-sizes-mobile"),this.$item_btns_sizes_wrapper_desktop=this.$item.find(this._CN+"item-btns-sizes-desktop"),this.MODIF_PANEL=t.extend({},m),this.MODIF_PANEL.init(this.$item,{on_open:()=>{this.objParent.hide_bhv_btns(!0)},on_close:()=>{this.objParent.hide_bhv_btns(!1)}}),this.behavior(),this.IIKO_MODE=e.CAFE.is_iiko_mode(),this.IIKO_MODE?this.init_model_item(c):this.init_model_item(u),this.insert_data(),this.update_lng(),this},render:function(){this.NOW_IN_VIEWPORT||(this.NOW_IN_VIEWPORT=!0,this.$elParent.append(this.$item),this.update_layout(),console.log("render ",this.item_data.title),this.load_image(this.get().image_url))},unmount:function(){this.NOW_IN_VIEWPORT&&(this.NOW_IN_VIEWPORT=!1,this.$item.detach(),console.log("unmount ",this.item_data.title),this.cancel_loading_image())},get_view:function(){return this.$item},update_lng:function(){this.get_view().find("[lang]").each((function(i){t(this).html(e.LNG.get(t(this).attr("lang")))}))},get:function(){return this.item_data},get_element:function(){return this.$item},init_model_item:function(e){if(this.MODEL_ITEM=t.extend({},e),this.MODEL_ITEM.init(this.item_data,{modifiers_panel:this.MODIF_PANEL,on_update_size:t=>{this.update_price_and_volume(t)},on_update_total_in_cart:t=>{this.update_cart_btn(t),this.play_smile_animation()}}),this.MODEL_ITEM.has_sizes()){const[t,e]=this.MODEL_ITEM.get_ui_price_buttons();this.$item.addClass("item-sized"),this.$item_btns_sizes_wrapper_mobile.prepend(t),this.$item_btns_sizes_wrapper_desktop.prepend(e)}},add_item_to_cart:function(){if(this.MODEL_ITEM.has_modifiers())this.MODIF_PANEL.reset(),this.MODIF_PANEL.show_price(this.MODEL_ITEM.get_price(),1),this.MODIF_PANEL.open();else{const t=this.MODEL_ITEM.get_preorder(1);let i=e.CART.add_preorder(t);this.update_cart_btn(i),this.play_smile_animation()}},play_smile_animation:function(){this.$item.removeClass(this.CLASS_PLAY_ADDTOCART),setTimeout((()=>{this.$item.addClass(this.CLASS_PLAY_ADDTOCART)}),60)},insert_data:function(){var t=this.item_data;this.$item.attr({id:t.id}),t.mode_spicy=parseInt(t.mode_spicy,10),t.mode_hit=parseInt(t.mode_hit,10),t.mode_vege=parseInt(t.mode_vege,10);var i=0;t.mode_spicy&&i++,t.mode_hit&&i++,t.mode_vege&&i++;var s="";switch(i){case 1:s="item-has-one-flag";break;case 2:s="item-has-two-flags";break;case 3:s="item-has-three-flags"}(t.mode_spicy||t.mode_hit||t.mode_vege)&&this.$item.addClass(this.CN+"item-has-flags"),s&&this.$item.addClass(this.CN+s),t.mode_spicy&&this.$item.addClass(this.CN+"item-has-flag-spicy"),t.mode_hit&&this.$item.addClass(this.CN+"item-has-flag-hit"),t.mode_vege&&this.$item.addClass(this.CN+"item-has-flag-vege");var n=e.CART.get_total_orders(t.id);this.update_cart_btn(n),this.$item.find(this._CN+"item-title").html(t.title),this.$item.find(this._CN+"item-about").html(t.description),this.update_price_and_volume(this.MODEL_ITEM.sizer_get_vars())},update_cart_btn:function(t){this.$totalInCart.html(t),t?this.$btnAddToCart.addClass("this-cart-full"):this.$btnAddToCart.removeClass("this-cart-full")},update_price_and_volume:function(t){var i=e.CAFE.get("cafe_currency").symbol;this.$item_price.html(t.price+" "+i);const s=`${t.sizeName?`${t.sizeName}<br>`:""} ${t.volume} ${t.units}`;this.$item_volume.html(s),this.$item_volume2.html(s)},is_portrait:function(){return t(window).height()>t(window).width()-1},calc_data_size:function(){return{width:this.$itemImageContainer.width(),height:this.$itemImageContainer.height()}},calc_offset_vertical:function(){var t=this.calc_data_size();if(this.is_portrait()){var e=Math.round(t.height/100*35),i=this.has_class_large()?0:-e;return this.has_class_description()&&(i=-t.height),{left:0,top:i}}return{left:0,top:0}},calc_offset_size_btns:function(t){var e=this.calc_data_size();if(this.is_portrait()){var i=Math.round(e.height/100*61),s=Math.round(e.height/100*26),n=this.has_class_large()?-s:-i;return this.has_class_description()&&(n=-e.height-s),{posY:n}}return{posY:0}},update_item_data_container:function(){var t=this.calc_offset_vertical(),e=this.calc_offset_size_btns(t);this.$descr.scrollTop(0),this.$itemDataContainer.css({transform:"translate("+t.left+"px,"+t.top+"px)"}),this.$item_btns_sizes_wrapper_mobile.css({transform:"translate(0, "+e.posY+"px)"})},image_now_loading:function(){this.$item.addClass("mm2-image-loading")},image_end_loading:function(){this.$item.removeClass("mm2-image-loading")},calc_image_bounds:function(){if(!this.IMAGE&&!this.IMAGE.width)return!1;var t=this.IMAGE,e=0,i=0,s=this.calc_data_size();this.is_portrait()?e=this.calc_offset_vertical().top:i=this.has_class_large()?0:-Math.round(.4*s.width);var n=s.width+i,o=s.height+e,a=n/o>t.width/t.height?n/t.width:o/t.height,r=Math.round((t.width*a-n)/2)+i;return{top:-(Math.round((t.height*a-o)/2)+e),left:-r,scale:a}},has_class_large:function(){return this.$item.hasClass(this.CLASS_LARGE_IMAGE)},has_class_description:function(){return this.$item.hasClass(this.CLASS_FULL_DESCRIPTION)},cancel_loading_image:function(){this.AJX_IMG_LOADING&&(this.AJX_IMG_LOADING.abort(),this.AJX_IMG_LOADING=null)},load_image:function(i){!this.IMAGE&&i&&(this.image_now_loading(),this.AJX_IMG_LOADING=t.ajax({url:i,method:"GET",cache:!0,xhrFields:{responseType:"blob"},success:t=>{this.TOTAL_BYTES_LOADED=t.size,console.log("Загружено:",e.CMN.formatBytes(t.size),i);const s=new Image;s.onload=()=>{this.insert_image(s)},s.src=URL.createObjectURL(t)},error:(t,e,i)=>{"abort"===i?console.error("Загрузка отменена"):console.error("Ошибка загружки изображения:",i)}}))},insert_image:function(e){this.IMAGE=e,this.image_end_loading();var i=this.calc_image_bounds();this.$image=t(e).css({position:"absolute",opacity:0,"transform-origin":"top left",transform:"translate("+i.left+"px,"+i.top+"px) scale("+i.scale+")"}),this.$itemImageContainer.html(this.$image),setTimeout((()=>{this.$image.css({opacity:1,transition:"opacity 1s,transform .5s"}),this.$item.addClass(this.CLASS_IMAGE_READY_TO_ZOOM)}),100)},update_image:function(t){var e=t?"0s":".5s";if(this.IMAGE&&this.IMAGE.width){var i=this.calc_image_bounds();this.$image&&this.$image.css({transform:"translate("+i.left+"px,"+i.top+"px) scale("+i.scale+")",transition:e})}},update_layout:function(t){this.update_item_data_container(t),this.update_image(t)},on_resize:function(){var t=this;this.TMR_RESIZE&&clearTimeout(this.TMR_RESIZE),this.TMR_RESIZE=setTimeout((function(){t.update_item_data_container(),t.update_image()}),200)},behavior:function(){var i=this;e.MOBILE_BUTTONS.bhv([this.$btnAddToCart]);var s=t=>{if(!this.is_portrait())return!1;"up"===t.direction||"down"===t.direction?this.bhv_portrait_touched(t.direction):"left"===t.direction?this.objParent.try_next():"right"===t.direction&&this.objParent.try_prev()};this.$bhvPortrait.swipe({onSwipe:t=>{s(t)},distance:40,enableMouse:!1}),this.$bhvPortrait.on("click",(function(e){console.log(e);var s=e.originalEvent,n=i.calc_offset_vertical();switch(i.get_vertical_pos()){case 0:const e=t(this).height()-s.offsetY<Math.abs(n.top)?"up":"down";i.bhv_portrait_touched(e);break;case 1:i.bhv_portrait_touched("up");break;case 2:i.bhv_portrait_touched("down")}})),t(window).on("resize",(function(){i.on_resize(),i.update_item_data_container()})),this.$bhvLandscape.on("click",(function(t){return i.bhv_landscape_touched(),!1})),this.$btnAddToCart.on("touchend click",(function(){return!i.CART_OFF&&i.add_item_to_cart(),!1}))},get_vertical_pos:function(){return this.has_class_large()?1:this.has_class_description()?2:0},bhv_landscape_touched:function(){this.has_class_large()?this.$item.removeClass(this.CLASS_LARGE_IMAGE):this.$item.addClass(this.CLASS_LARGE_IMAGE),this.update_image()},bhv_portrait_touched:function(t){if("down"==t)switch(this.get_vertical_pos()){case 0:this.portrait_show_large_image();break;case 2:this.portrait_close_descr()}else if("up"==t)switch(this.get_vertical_pos()){case 1:this.portrait_close_large_image();break;case 0:this.portrait_show_descr()}},portrait_close_large_image:function(t){this.$item.removeClass(this.CLASS_LARGE_IMAGE),this.update_layout(t)},portrait_show_large_image:function(t){this.$item.addClass(this.CLASS_LARGE_IMAGE),this.update_layout(t)},portrait_close_descr:function(){this.$item.removeClass(this.CLASS_FULL_DESCRIPTION),this.update_layout()},portrait_show_descr:function(){this.$item.addClass(this.CLASS_FULL_DESCRIPTION),this.update_layout()},close_modifiers_panel:function(){this.MODIF_PANEL.close()}},p={init:function(e){if(!e.G_DATA||!e.$link||!e.CHEFS_URL)return!1;this.G_DATA=e.G_DATA,this.$link=e.$link,this.CHEFS_URL=e.CHEFS_URL,this.$body=t("body"),window[this.G_DATA].ALLITEMS={},window[this.G_DATA].ARRITEMS={},this.CLASS_MENU_IS_SHOWED="chefsmenu-is-showed",this.CLASS_READY_TO_USE="ready-to-use",this.CLASS_IIKO_MODE="menu-iiko-mode",this.CLASS_CHEFSMENU_MODE="menu-chefsmenu-mode",this.CLASS_SHOW_PRELOAD="chefsmenu-show-preload",this.CLASS_CAFE_IS_IN_ARCHIVE="chefsmenu-cafe-is-in-archive",this.UNIQ_CAFE=this.$link.attr("data-cafe"),this.NO_CLOSE=this.$link.attr("noclose"),this.AUTOLOAD=this.$link.attr("autoload"),this.onMenuReady=e.onReady,this.load_style_asynq().then((t=>{this.pre_build_asynq().then((t=>{this.$link.on("click",(()=>(window[this.G_DATA].SAVED_BODY_POS=window.pageYOffset,this.show({cafe:this.UNIQ_CAFE}),!1))),this.AUTOLOAD&&setTimeout((()=>{this.show({cafe:this.UNIQ_CAFE})}),200),this.init_views()})).catch((t=>{console.log("err",t)}))})).catch((t=>{console.log("err",t)}))},init_views:function(){var t=this,i="#mm2-templates";e.LNG.init("ru"),e.MENU_ICONS.init(),e.UVIEWS.init(".mm2-all-views"),e.UVIEWS.addview(e.VIEW_ALLMENU.init({name:"the-allmenu",template:i+" .view-allmenu",chefsmenu:t,noclose:this.NO_CLOSE,anim:"animLeft"})),e.UVIEWS.addview(e.VIEW_ALLITEMS.init({name:"the-allitems",template:i+" .view-items",chefsmenu:t,noclose:this.NO_CLOSE,anim:"animLeft"})),e.UVIEWS.addview(e.VIEW_TABLE_CHANGE.init({name:"view-table-change",template:i+" .view-table-change",chefsmenu:t,noclose:this.NO_CLOSE,anim:"animLeft"})),e.UVIEWS.addview(e.VIEW_CART.init({name:"the-showcart",template:i+" .view-showcart",chefsmenu:t,noclose:this.NO_CLOSE,anim:"animLeft"})),e.UVIEWS.addview(e.VIEW_CHOOSING_MODE.init({name:"the-choosing-mode",template:i+" .view-choosing-mode",chefsmenu:t,noclose:this.NO_CLOSE,anim:"animLeft"})),e.UVIEWS.addview(e.VIEW_ORDERING.init({name:"the-ordering",template:i+" .view-ordering",chefsmenu:t,noclose:this.NO_CLOSE,anim:"animLeft"})),e.UVIEWS.addview(e.VIEW_ORDER_OK.init({name:"the-order-ok",template:i+" .view-order-ok",chefsmenu:t,noclose:this.NO_CLOSE,anim:"animLeft"})),e.UVIEWS.addview(e.VIEW_ORDER_CANCEL.init({name:"the-order-cancel",template:i+" .view-order-cancel",chefsmenu:t,noclose:this.NO_CLOSE,anim:"animLeft"})),e.TABINDEX.init(),this.onMenuReady&&this.onMenuReady()},set_allitems_for_menu:function(t,e){return window[this.G_DATA].ALLITEMS[t.id]=e},get_allitems_for_menu:function(t){return window[this.G_DATA].ALLITEMS[t.id]},get_cafe:function(){return window[this.G_DATA].ALLCAFE[this.get_uniq_name()]},get_allmenu:function(){return window[this.G_DATA].ALLMENU[this.get_uniq_name()]},get_uniq_name:function(){return this.CAFE_UNIQ_NAME},get_url_to_images:function(){return window[this.G_DATA].URL_TO_IMAGES},show:function(t){var i=this;window[i.G_DATA].SHOWED++,this.CAFE_UNIQ_NAME=t.cafe,i.$body.addClass(i.CLASS_MENU_IS_SHOWED),i.$body.addClass(i.CLASS_SHOW_PRELOAD),i.$menu.show(),setTimeout((function(){i.now_loading()}),50);var s=function(t){var e=window[i.G_DATA],s="light-lemon";t=t||s;if(!e.CURRSKIN.label||e.CURRSKIN.label!==t){e.CURRSKIN.link&&i.detach_style(e.CURRSKIN.link);var n=e.ALLSKINS[t]||e.ALLSKINS[s],o=e.MAINSTYLE;for(var a in n)n.hasOwnProperty(a)&&(r=new RegExp("%\\["+a+"\\]%","gi"),o=o.replace(r,n[a]));a="skin-label";var r=new RegExp("%\\["+a+"\\]%","gi");o=o.replace(r,t),e.CURRSKIN.label=t,e.CURRSKIN.link=i.append_style(o)}};this.load_all_menu({onReady:function(){var t=i.get_cafe(),n=t.skin_label;s(n);const o=e.UVIEWS.get();if(t.lang.toLowerCase()!==e.LNG.get_current()){e.LNG.update(t.lang);for(let t in o)if(o.hasOwnProperty(t)){o[t].view._update_lng()}}i.show_win({skin:t.skin,onReady:function(){e.CAFE.init(t),e.VIEW_ALLMENU.update(i.get_allmenu()),e.CART.init(),e.UVIEWS.go_first("fast");const s=e.CAFE.is_iiko_mode()?i.CLASS_IIKO_MODE:i.CLASS_CHEFSMENU_MODE;i.$menu.addClass(s),e.CAFE.has_delivery(),i.$menu.addClass("cafe-has-delivery"),setTimeout((function(){i.$body.removeClass(i.CLASS_SHOW_PRELOAD),i.$menu.addClass(i.CLASS_READY_TO_USE)}),50),setTimeout((function(){i.end_loading()}),300)}})}})},show_win:function(t){t&&t.onReady&&t.onReady()},now_loading:function(){this.LOADING=!0,this.$menu&&this.$menu.addClass("now-loading")},end_loading:function(){this.LOADING=!1,this.$menu&&this.$menu.removeClass("now-loading")},is_loading_now:function(){return this.LOADING},pre_build_asynq:function(){return new Promise(((i,s)=>{const n=this,o={loadApp:function(a){n.AJAX=t.ajax({url:a+"?callback=?",jsonpCallback:e.CALLBACK_RANDOM.get(),dataType:"jsonp",method:"POST",success:function(e){window[n.G_DATA].WAS_BUILT||o.appendToBody(e[0].app),n.$menu=t("."+window[n.G_DATA].PRE+"menu"),i(e)},error:function(t){s(t)}})},appendToBody:function(e){t("body").append(e),window[n.G_DATA].WAS_BUILT=!0}};window[n.G_DATA].WAS_BUILT?(n.$menu=t("."+window[n.G_DATA].PRE+"menu"),i("ok")):o.loadApp(GLB_APP_URL+"pbl/views/pbl.php")}))},detach_style:function(t){t.remove()},append_style:function(t){var e=document.createElement("style");return e.type="text/css",e.styleSheet?e.styleSheet.cssText=t:e.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(e)},load_style_asynq:function(){return new Promise(((i,s)=>{const n=this,o=GLB_APP_URL+"pbl/css/style.php",a=function(t){let e={},s=t.skins["all-skins"];for(let t=0;t<s.length;t++)e[s[t].label]=s[t].params;window[n.G_DATA].ALLSKINS=e,window[n.G_DATA].MAINSTYLE=t["main-style"],n.append_style(t["head-style"]),i()};null!==window[n.G_DATA].ALLSKINS?i("ok"):this.AJAX=t.ajax({url:o+"?callback=?",jsonpCallback:e.CALLBACK_RANDOM.get(),dataType:"jsonp",data:{},method:"POST",success:function(t){a(t)},error:function(t){s(t)}})}))},load_all_menu:function(i){var s=this,n=GLB_APP_URL+"pbl/lib/pbl.get_all_menu.php",o=this.get_uniq_name(),a=window[s.G_DATA].ALLMENU[o],r=function(t){for(var e={},i=0;i<t.length;i++)e[t[i].id]=t[i];return e.arr=t,e},_={cafe:o};console.log("data",_),a?i.onReady&&i.onReady():this.AJAX=t.ajax({url:n+"?callback=?",jsonpCallback:e.CALLBACK_RANDOM.get(),dataType:"jsonp",method:"POST",data:_,success:function(t){if(t.error)console.log("error",t.error),s.close_menu_win(),s.goto404();else if(1==t.cafe.cafe_status)s.close_menu_win(),s.gotoArchive();else{var e=r(t.menu);window[s.G_DATA].ALLMENU[o]=e,window[s.G_DATA].ALLCAFE[o]=t.cafe,setTimeout((function(){i.onReady&&i.onReady()}),500)}},error:function(t){console.log("err response",t),s.goto404()}})},goto404:function(){location.href=this.CHEFS_URL.server+"cafe/"},gotoArchive:function(){this.$body.addClass(this.CLASS_CAFE_IS_IN_ARCHIVE)},close_menu_win:function(){var t=this;setTimeout((function(){window[t.G_DATA].SHOWED--,t.$body.removeClass(t.CLASS_MENU_IS_SHOWED),t.$body.removeClass(t.CLASS_SHOW_PRELOAD),t.$menu&&t.$menu.removeClass(t.CLASS_READY_TO_USE),t.$menu&&t.$menu.hide();var e=window[t.G_DATA].SAVED_BODY_POS;e&&window.scroll(0,e),window[t.G_DATA].SAVED_BODY_POS=0}),300)}},g={init:function(){return this.$allinputs=t("input,textarea"),this.clear(),this},clear:function(){this.$allinputs.attr("tabindex","-1")}},E={init:function(e){this.parent=e,this._CN=e._CN,this.$table_mode_protect=t("body").find(this._CN+"protect-table-mode"),this.$table_mode_protect__message=this.$table_mode_protect.find(this._CN+"protect-table-mode__message"),this.$table_mode_protect__btn_ok=this.$table_mode_protect.find(this._CN+"protect-table-mode__button-ok"),this.ORDER_TO_TABLE_MODE=t("body").hasClass("mode-orderto-table"),this.TABLE_NUMBER=-1,this.btnTableNumber=this.parent.$view.find(this._CN+"header__table-number"),this.btnTableNumber_number=this.parent.$view.find(this._CN+"header__table-number_number"),this.parent._update_lng()},update:function(){let t=`${CHEFS_URL.server}cafe/${e.CAFE.get().uniq_name}/`;if(this.ORDER_TO_TABLE_MODE)if(this.check_table_number()){this.btnTableNumber_number.html(this.TABLE_NUMBER);let e=`<p>Вы открыли меню для столика №&nbsp;${this.TABLE_NUMBER}, предназначенное для работы внутри заведения</p>\n                        <p>Для перехода Меню в обычный режим, с&nbsp;возможностью сделать заказ на доставку или самовывоз, нажмите ОК</p>`;this.$table_mode_protect__message.html(e),this.$table_mode_protect__btn_ok.on("click",(()=>{location.href=t})),this.behavior()}else{let e="<p>В адресе Меню для заказа в стол возможно ошибка!</p>\n                        <p>Меню перейдет в обычный режим, с&nbsp;возможностью сделать заказ на доставку или самовывоз.</p>";this.parent._show_modal_win(e,{onClose:()=>{location.href=t}})}},check_table_number:function(){let i=t("body").data("table-uniq"),s=e.CAFE.get().tables_uniq_names,n=!1;if(i&&s){s=JSON.parse(s);for(let t in s)if(s.hasOwnProperty(t)&&i===s[t]){n=!0;let t=i.split("-");this.TABLE_NUMBER=t[0];break}}return n},get_table_number:function(){return this.TABLE_NUMBER},is_table_mode:function(){return this.ORDER_TO_TABLE_MODE},behavior:function(){}},b={_init:function(e){this.name=e.name,this.level=e.level,this.$view=t(e.template).clone(),this.chefsmenu=e.chefsmenu,this.noclose=e.noclose,this.animName=e.anim,this.CN="mm2-",this._CN="."+this.CN,this.$tpl=t("#mm2-templates"),this.$tplCartRow=t("#mm2-templates .mm2-cart-row"),this.$content=this.$view.find(".std-content"),this.$modal=t("body").find(this._CN+"modal-win"),this.$modalTitle=this.$modal.find(this._CN+"modal-win__title"),this.$modalMessage=this.$modal.find(this._CN+"modal-win__message"),this.$modalBtnOk=this.$modal.find(this._CN+"modal-win__button-ok"),this.NEED_TO_SAVE=!1,this.VIEW_SCROLLED=!1,this._update_lng()},_behavior:function(i){var s=this;e.MOBILE_BUTTONS.bhv(i),this.noclose&&this.$btnClose.hide(),t(window).on("touchstart",(function(){s.VIEW_SCROLLED=!1})).on("touchmove",(function(){s.VIEW_SCROLLED=!0})),this.$btnClose.on("touchend click",(function(){return s._close_menu(),!1}))},_show_modal_win:function(t,e){this.$modal.removeClass("visible"),this.$modal.show(),this.$modalMessage.html(t),this.$modalBtnOk.on("click",(t=>{this.$modal.removeClass("visible"),setTimeout((()=>{this.$modal.hide()}),600),e&&e.onClose&&e.onClose(),t.originalEvent.cancelable&&t.preventDefault()})),setTimeout((()=>{this.$modal.addClass("visible")}),100)},_content_hide:function(){this.$view.addClass(this.CN+"content-hidden")},_content_show:function(){this.$view.removeClass(this.CN+"content-hidden")},_update_tabindex:function(){e.TABINDEX.clear(),this.$view.find("input, textarea").each((function(e){t(this).attr("tabindex",e)}))},_update_lng:function(i){return(i=i||this._get_view()).find("[lang]").each((function(i){t(this).html(e.LNG.get(t(this).attr("lang")))})),i},_get_name:function(){return this.name},_get_view:function(){return this.$view},_get_anim:function(){return this.animName},_close_menu:function(){this.noclose?e.UVIEWS.go_first():this.chefsmenu.close_menu_win()},_need2save:function(t){this.NEED_TO_SAVE=t,t?this.$view&&this.$view.addClass("need-to-save"):this.$view&&this.$view.removeClass("need-to-save")}},C={init:function(t){return this._init(t),this.$headerTitle=this.$view.find(this._CN+"allmenu-header-title"),this.$headerPhone=this.$view.find(this._CN+"header-phone"),this.$btnBasket=this.$view.find(this._CN+"btn-basket"),this.$btnClose=this.$view.find(this._CN+"btn-close-menu"),this.$btnBack=this.$view.find(this._CN+"btn-back, "+this._CN+"std-header-btn-back, "+this._CN+"btn-close-items"),this.$menuListContainer=this.$view.find(this._CN+"allmenu-list2"),this.$tplMenuItem=this.$tpl.find(this._CN+"allmenu-row"),this.$cafeDescription=this.$view.find(this._CN+"cafe-description"),this.$btnSlideUpAbout=this.$view.find(this._CN+"btn-slideup"),this.$btnsLangContainer=this.$view.find(this._CN+"langs__buttons"),this.CLASS_SHOWED_ABOUT=this.CN+"allmenu-about-showed",this.LIST_SCROLLED=!1,e.MENU_TABLE_MODE.init(this),this.behavior(),this},update:function(i){var s=this;e.MENU_TABLE_MODE.update(),console.log("allmenu",i),console.log("GLB.MENU_ICONS",e.MENU_ICONS),this.build_langs_ui(),this.all_menu=i;var n=function(){var i=t("<ul></ul>");i.on("touchstart",(function(){s.LIST_SCROLLED=!1})),i.on("touchmove",(function(){s.LIST_SCROLLED=!0}));for(var n=0;n<s.all_menu.arr.length;n++){var o=s.all_menu.arr[n];o.visible>0&&function(t){var n=s.$tplMenuItem.clone();n.find(s._CN+"allmenu-row__title span").html(o.title).end(),n.find(s._CN+"allmenu-row__icon").addClass(s.CN+"icon-"+e.MENU_ICONS.get(o.id_icon)),n.find("a").attr({"data-id-menu":t}).on("touchend click",(function(i){if(!s.LIST_SCROLLED){var n=s.get_menu_by_id(t);e.VIEW_ALLITEMS.update(n),s.chefsmenu.now_loading(),e.UVIEWS.set_current("the-allitems")}i.originalEvent.cancelable&&i.preventDefault(),i.stopPropagation()})),i.append(n)}(o.id)}i.find("li").each((function(e){t(this).css({transition:".3s "+.1*e+"s transform"})})),s.$menuListContainer.html(i),setTimeout((function(){s.$menuListContainer.addClass(s.CN+"allmenu-list-showed")}),10)};const o=e.CAFE.get("cafe_title");this.$headerTitle.find(this._CN+"allmenu-header-title__text").html(o);var a=e.CAFE.get("cafe_phone");if(""!==a?this.$headerPhone.find(this._CN+"header-phone__text").html(a):this.$headerPhone.hide(),a){var r=a.replace(/[-() ]/g,"");this.$headerPhone.on("touchend click",(function(){return location.href="tel:"+r,!1}))}var _=this.$cafeDescription,h=e.CAFE.get("cafe_address"),l=this.CN+"cafe-description__br",c=e.CAFE.get("cafe_description").replace(/\n/g,"<div class='"+l+"'></div>"),d=e.CAFE.get("chief_cook"),u=""!==e.CAFE.get("work_hours")?e.CAFE.get("work_hours"):"Не указаны";(_=this._update_lng(_)).find(this._CN+"cafe-description-address").html(e.LNG.get("lng_our_adress")+" <strong>"+h+"</strong>"),_.find(this._CN+"cafe-description-chief").html(e.LNG.get("lng_chef_cook")+" <strong>"+d+"</strong>"),_.find(this._CN+"cafe-description-workhours").html(e.LNG.get("lng_work_hours")+" <strong>"+u+"</strong>"),_.find(this._CN+"cafe-description-about").html(c),""===d&&_.find(this._CN+"cafe-description-chief").hide(),this.$menuListContainer.html(""),n()},get_menu_by_id:function(t){return this.all_menu[t]},build_langs_ui:function(){const i=this;this.$view.removeClass("multilang-mode");const s=e.CAFE.get(),n=!!s.extra_langs&&JSON.parse(s.extra_langs);if(!n)return;this.$view.addClass("multilang-mode"),this.$btnsLangContainer.html("");const o=[],a=[];for(let t in n)a.push(t);a.unshift("ru");for(let e in a){let i=a[e],s=t(`<div data-user-lang="${i}" ${"ru"===i?'class="current"':""}><span>${i}</span></div>`);this.$btnsLangContainer.append(s),o.push(s)}this.$btnsLangContainer.find("div").on("touchend click",(function(e){const s=t(this).data("user-lang");i.set_user_language(s),e.cancelable&&e.preventDefault()})),this._behavior(o)},set_user_language:function(t){console.log("lng",t)},behavior:function(){var t=this,i=[this.$btnBasket,this.$btnBack,this.$btnClose,this.$headerTitle,this.$btnSlideUpAbout];this._behavior(i),this.$headerTitle.on("touchend click",(function(e){t.$view.toggleClass(t.CLASS_SHOWED_ABOUT),e.originalEvent.cancelable&&e.preventDefault()})),this.$btnSlideUpAbout.on("touchend click",(function(e){t.$view.removeClass(t.CLASS_SHOWED_ABOUT),e.originalEvent.cancelable&&e.preventDefault()})),this.$btnBasket.on("touchend click",(function(t){e.VIEW_CART.update(),e.UVIEWS.set_current("the-showcart"),t.originalEvent.cancelable&&t.preventDefault()}))}},v={init:function(t){return this._init(t),this.$headerIcon=this.$view.find(this._CN+"std-header-icon"),this.$headerTitle=this.$view.find(this._CN+"std-header-title"),this.$btnBasket=this.$view.find(this._CN+"btn-basket"),this.$btnClose=this.$view.find(this._CN+"btn-close-menu"),this.$btnBack=this.$view.find(this._CN+"btn-back, "+this._CN+"std-header-btn-back, "+this._CN+"btn-close-items"),this.$btnNextItem=this.$view.find(this._CN+"item-btn-next"),this.$btnPrevItem=this.$view.find(this._CN+"item-btn-prev"),this.$page_counter=this.$view.find(this._CN+"footer-item-pagecounter span"),this.$itemsContainer=this.$view.find(this._CN+"allitems-container"),this.$bhv=this.$view.find(this._CN+"bhv"),this.TOTAL_ITEMS=0,this.ALL_ITEMS={},this.ITEMS={},this.CURRENT=0,this.SAFE_NUMBER=5,this.behavior(),this},update:function(t){this.MENU=t,this.upade_header(),this._content_hide();var i=this.chefsmenu.get_allitems_for_menu(this.MENU);console.log("allitems",i);var s=()=>{const t=(new TextEncoder).encode(JSON.stringify(this.ALL_ITEMS)).length;console.log(`Размер объекта this.ALL_ITEMS: ${e.CMN.formatBytes(t)} байт`),console.log("start items build"),this.$itemsContainer.html(""),this.CURRENT=0,this.build_instances_async().then((t=>{this.ITEMS=t,this.render_actual_range(),this.go_to(this.CURRENT,"fast"),this.update_tpl_page_counter(),this.hide_bhv_btns(!1),this._content_show(),setTimeout((()=>{this.chefsmenu.end_loading()}),100)}))},n=function(t){for(var e={},i=0;i<t.length;i++)e[t[i].id]=t[i];return e.arr=t,e};i?(console.log("items already loaded"),this.ALL_ITEMS=i,this.TOTAL_ITEMS=this.ALL_ITEMS.arr.length,setTimeout((()=>{s()}),600)):setTimeout((()=>{console.log("start items loading"),this.load_items_async().then((t=>{console.log("arr_items loaded",t),this.ALL_ITEMS=n(t),this.TOTAL_ITEMS=t.length,this.chefsmenu.set_allitems_for_menu(this.MENU,this.ALL_ITEMS),console.log("created all_items object",this.ALL_ITEMS),s()})).catch((t=>{console.log("error loading items",t)}))}),400)},upade_header:function(){for(var t in this.$headerTitle.find("span").html(this.MENU.title),e.MENU_ICONS.get())this.$headerIcon.removeClass(this.CN+"icon-"+e.MENU_ICONS.get(t));this.$headerIcon.addClass(this.CN+"icon-"+e.MENU_ICONS.get(this.MENU.id_icon))},render_actual_range:function(){const t=this.calc_actual_range();for(let e=0;e<this.ALL_ITEMS.arr.length;e++){let i=this.ALL_ITEMS.arr[e].id;e>=t.start&&e<=t.end?this.ITEMS[i].render():this.ITEMS[i].unmount()}},calc_actual_range:function(){let t=this.CURRENT,e=this.get_total(),i=this.SAFE_NUMBER;if(e<=2*i+1){let i={start:0,end:e};return console.log("range = 0 to total: ",i,`curr: ${t}`),i}{const s={start:t-i,end:t+i};if(s.start<0&&(s.end+=Math.abs(t-i),s.start=0),s.end>e){let t=s.start-Math.abs(e-s.end);t>=0&&(s.start=t),s.end=e}return console.log("calculated new range",s,`curr: ${t}`),s}},get_menu_data:function(){return this.MENU},get_total:function(){return this.TOTAL_ITEMS},get_all_items:function(t){return void 0!==t?this.ALL_ITEMS[t]:this.ALL_ITEMS},hide_bhv_btns:function(t){t?this.$bhv.hide():this.$bhv.show()},behavior:function(){var t=[this.$btnBasket,this.$btnBack,this.$btnClose,this.$btnNextItem,this.$btnPrevItem];this._behavior(t),this.$btnBasket.on("touchend click",(t=>{e.VIEW_CART.update(),e.UVIEWS.set_current("the-showcart"),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnBack.on("touchend click",(t=>{this.cancel_all_loadings_async().then((()=>{this.cut_tail_before_go_back_async().then((()=>{setTimeout((()=>{e.UVIEWS.go_back()}),0)}))})),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnNextItem.on("touchend click",(t=>{this.try_next(),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnPrevItem.on("touchend click",(t=>{this.try_prev(),t.originalEvent.cancelable&&t.preventDefault()}))},update_btns:function(){0==this.CURRENT?(this.$view.removeClass("items-last-page"),this.$view.addClass("items-first-page")):this.CURRENT==this.TOTAL_ITEMS-1?(this.$view.addClass("items-last-page"),this.$view.removeClass("items-first-page")):(this.$view.removeClass("items-last-page"),this.$view.removeClass("items-first-page"))},get_instances:function(t){const e=[];for(let i=0;i<t.length;i++)this.ITEMS[t[i].id]&&e.push(this.ITEMS[t[i].id]);return e},get_items_from_range:function(t){return this.get_all_items().arr.slice(t.start,t.end)},load_items_async:function(){return new Promise(((i,s)=>{var n=GLB_APP_URL+"pbl/lib/pbl.get_all_items.php",o={menu:this.MENU.id};this.AJX_ITEMS=t.ajax({url:n+"?callback=?",jsonpCallback:e.CALLBACK_RANDOM.get(),dataType:"jsonp",method:"POST",data:o,success:t=>{i(t)},error:t=>{console.log("err response",t),s("ошибка загрузки")}})}))},build_instances_async:function(){return new Promise(((i,s)=>{const n={};var o=this.get_all_items().arr;if(this.get_total())for(var a=0;a<o.length;a++){var r=t.extend({},e.ITEM);n[o[a].id]=r.init(this,o[a],a)}i(n)}))},cancel_all_loadings_async:function(){return new Promise(((t,e)=>{console.log("- отменили загрузку позиций"),this.AJX_ITEMS&&this.AJX_ITEMS.abort(),console.log("- отменили загрузку изображений"),this.ARR_NEED_TO_LOAD_IMAGE=[],this.AJX_IMG_LOADING&&this.AJX_IMG_LOADING.abort(),t()}))},cut_tail_before_go_back_async:function(){return new Promise(((t,e)=>{console.log("cutting the tail...");var i=this.ALL_ITEMS.arr[this.CURRENT].id;for(let t in this.ITEMS){let e=this.ITEMS[t];i!==e.get().id&&e.unmount()}t()}))},get_element:function(){return this.$itemsContainer},all_items_show_large_images:function(){var t=this.ALL_ITEMS.arr;if(!t.length)return!1;for(var e=0;e<t.length;e++){var i=e!==this.CURRENT,s=t[e].id,n=this.ITEMS[s];n&&n.portrait_show_large_image(i)}},all_items_close_large_images:function(){var t=this.ALL_ITEMS.arr;if(!t.length)return!1;for(var e=0;e<t.length;e++){var i=e!==this.CURRENT,s=t[e].id,n=this.ITEMS[s];n&&n.portrait_close_large_image(i)}},current_item_close_modifiers:function(){var t=this.ALL_ITEMS.arr[this.CURRENT].id,e=this.ITEMS[t];e&&e.close_modifiers_panel()},current_item_close_description:function(){var t=this.ALL_ITEMS.arr[this.CURRENT].id,e=this.ITEMS[t];e&&e.portrait_close_descr()},try_next:function(){if(!this.get_total())return!1;this.current_item_close_description(),this.current_item_close_modifiers(),this.CURRENT<this.get_total()-1?(this.CURRENT+=1,this.render_actual_range(),this.go_to(this.CURRENT)):this.show_cant_next()},try_prev:function(){if(!this.get_total())return!1;this.current_item_close_description(),this.current_item_close_modifiers(),this.CURRENT>0?(this.CURRENT-=1,this.render_actual_range(),this.go_to(this.CURRENT)):this.show_cant_prev()},go_to:function(t,e){var i=e?"0s":"0.5s";this.$itemsContainer.css({transform:"translateX(-"+100*t+"%)",transition:i}),this.update_tpl_page_counter(),this.update_btns()},pages_move:function(t,e){this.$itemsContainer.css({transform:"translateX("+t+")",transition:"transform "+e})},show_cant_prev:function(){var t=this;this.pages_move("3%","0.1s"),setTimeout((function(){t.pages_move("0%","0.5s")}),100)},show_cant_next:function(){var t=this,e=100*(this.get_total()-1);this.pages_move(-(e+3)+"%","0.1s"),setTimeout((function(){t.pages_move(-e+"%","0.5s")}),100)},update_tpl_page_counter:function(){this.$page_counter.html(this.CURRENT+1+"/"+this.get_total())}};const A={send_async:function(t,i){return new Promise(((s,n)=>{console.log("order, pickupself  ==== ",t,i);const o=GLB_APP_URL+"pbl/lib/pbl.send_order_for_delivery.php",a={id_cafe:t.id_cafe,order:t,pickupself:i};$.ajax({url:o+"?callback=?",jsonpCallback:e.CALLBACK_RANDOM.get(),dataType:"jsonp",method:"POST",data:a,error:t=>{n(t)}}).then((t=>{t&&!t.error?s(t):n(t)}))}))},send_to_table_async:function(t,i){return new Promise(((s,n)=>{console.log("order, table_number  ==== ",t,i);const o=GLB_APP_URL+"pbl/lib/pbl.send_order_to_table.php",a={id_cafe:e.CAFE.get().id,order:t,table_number:i};console.log("data",a);$.ajax({url:o+"?callback=?",data:a,dataType:"jsonp",method:"POST",error:t=>{n(t)}}).then((t=>{t&&!t.error?s(t):n(t)}))}))}};var I={init:function(t){return this._init(t),this.CLASS_EMPTY=this.CN+"cart-isempty",this.READY_TO_ORDERING=!1,this.$totalValue=this.$view.find(this._CN+"cart-total .value"),this.$btnBasket=this.$view.find(this._CN+"btn-basket"),this.$btnClose=this.$view.find(this._CN+"btn-close-menu"),this.$btnBack=this.$view.find(this._CN+"btn-back, "+this._CN+"std-header-btn-back, "+this._CN+"btn-close-items"),this.$btnClearCart=this.$view.find(this._CN+"btn-clear, "+this._CN+"header-btn-clear"),this.$btnOrdering=this.$view.find(this._CN+"btn-ordering"),this.$itemsContainer=this.$view.find(this._CN+"cart-allitems"),this.update_ui(),this.clear_cart_container(),this.behavior(),this},behavior:function(){var t=[this.$btnBasket,this.$btnBack,this.$btnClose,this.$btnClearCart,this.$btnOrdering];this._behavior(t),this.$btnClearCart.on("touchend click",(t=>{this.clear_cart(),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnBack.on("touchend click",(t=>{e.UVIEWS.go_first(),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnOrdering.on("touchend click",(t=>{e.CAFE.iiko_api_key,this.READY_TO_ORDERING&&!this.chefsmenu.is_loading_now()&&(e.MENU_TABLE_MODE.is_table_mode()?(this.chefsmenu.now_loading(),this.send_order_to_table()):this.send_order_to_delivery()),t.originalEvent.cancelable&&t.preventDefault()}))},send_order_to_table:function(){const i=(s=new Date).getDate()+"-"+(s.getMonth()+1)+"-"+s.getFullYear()+" "+s.getHours()+":"+s.getMinutes();var s;const n=e.CART.get_total_price(),o={id_cafe:e.CAFE.get("id"),order_time_sent:i,order_time_need:i,order_total_price:n,order_user_comment:""},a=e.CART.get_all();console.log("==== order_items ====",a);const r=t.extend(o,{order_items:a}),_=e.MENU_TABLE_MODE.get_table_number();this.ORDER_SENDER=t.extend({},A),this.ORDER_SENDER.send_to_table_async(r,_).then((t=>{console.log("--vars--",t),r.short_number=t.short_number,r.demo_mode=t.demo_mode,r.notg_mode=!!t.notg_mode,this.chefsmenu.end_loading(),e.VIEW_ORDER_OK.update(r,{table_number:_}),e.UVIEWS.set_current("the-order-ok")})).catch((t=>{this._show_modal_win("Заказ не получается отправить. \n            \tОбратитесь к администратору кафе."),console.log("err",t),setTimeout((()=>{this.chefsmenu.end_loading()}),300)}))},send_order_to_delivery:function(){const t=e.CAFE.has_delivery();console.log("!! has_delivery = ",t),e.CAFE.has_delivery()?(e.VIEW_CHOOSING_MODE.update(),e.UVIEWS.set_current("the-choosing-mode")):(e.VIEW_ORDERING.update({pickupMode:!0}),e.UVIEWS.set_current("the-ordering"))},clear_cart:function(){e.CART.cart_clear(),e.VIEW_ORDERING.update({clear:!0}),this.update("clear")},clear_cart_container:function(){this.$itemsContainer.html(""),e.CART.get_total_orders()?this.$content.removeClass(this.CLASS_EMPTY):this.$content.addClass(this.CLASS_EMPTY)},update:function(t){var i=this;const s=e.CART.get_all(),n=e.CAFE.is_iiko_mode(),o=e.CAFE.get("cafe_currency").symbol;let a=e.CART.get_total_price();a>0?this.$btnOrdering.removeClass(i.CN+"btn-disabled"):this.$btnOrdering.addClass(i.CN+"btn-disabled"),a>0?this.$btnClearCart.removeClass(i.CN+"btn-disabled"):this.$btnClearCart.addClass(i.CN+"btn-disabled"),this.READY_TO_ORDERING=a>0;const r={buildAll:()=>{this.ALL_ROWS={};for(let t in s)if(s.hasOwnProperty(t)){let e=s[t];e&&r.buildRow(e)}setTimeout((()=>{var t=0;for(var e in this.ALL_ROWS)if(this.ALL_ROWS.hasOwnProperty(e)){var i=.2*t+.5+"s";this.ALL_ROWS[e].css({opacity:1,transform:"translateX(0)",transition:i}),t++}}),300)},buildRow:t=>{const s=t.item_data.title,a=t.count,r=t.price_with_modifiers,_=t.uniq_name,h=`${t.volume} ${t.units}`,l=n?`${t.sizeName} / ${h}`:h,c=a+" x "+r+" "+o,d=t.chosen_modifiers;let u="";if(n&&d&&d.length)for(let t in d){u+="+ "+d[t].name+"<br>"}let m=this.$tplCartRow.clone().css({opacity:0,transform:"translateX(50px)"});m.find(this._CN+"cart-title__item").html(s),m.find(this._CN+"cart-title__volume").html(l),n&&m.find(this._CN+"cart-title__modifiers").html(u),m.find(this._CN+"cart-quantity").html(c),function(t){let s=m.find(i._CN+"cart-more").on("touchend click",(function(){return i.add_to_cart(t),!1})),n=m.find(i._CN+"cart-less").on("touchend click",(function(){return i.remove_from_cart(t),!1}));s&&n&&e.MOBILE_BUTTONS.bhv([s,n])}(_),this.$itemsContainer.append(m),this.ALL_ROWS[_]=m},updateRow:t=>{const i=s[t];if(i){const s=i.count+" x "+i.price_with_modifiers+" "+e.CAFE.get_currency().symbol;this.ALL_ROWS[t].find(this._CN+"cart-quantity").html(s)}else e.CART.is_empty()?this.update("clear"):(this.ALL_ROWS[t].css({opacity:0,transform:"translateX(-50px)",transition:"0.3s"}),setTimeout((()=>{this.ALL_ROWS[t].remove()}),300))}};if(t)if("clear"!==t)r.updateRow(t);else{let t=0;for(let e in this.ALL_ROWS)if(this.ALL_ROWS.hasOwnProperty(e)){let i=.2*t+.5+"s";this.ALL_ROWS[e]&&this.ALL_ROWS[e].css({opacity:0,transform:"translateX(-50px)",transition:i}),t++}setTimeout((()=>{this.clear_cart_container()}),500)}else this.clear_cart_container(),r.buildAll();this.$totalValue.html(e.CART.the_total())},add_to_cart:function(t){e.CART.add_one(t),this.update(t)},remove_from_cart:function(t){e.CART.remove_one(t),this.update(t)},update_ui:function(){const t=""!==e.CAFE.iiko_api_key&&e.MENU_TABLE_MODE.is_table_mode()?"Отправить<br>заказ":"Оформить<br>заказ";this.$btnOrdering.html(`<span>${t}</span>`)}},S={init:function(t){return this._init(t),this.$btnBasket=this.$view.find(this._CN+"btn-basket"),this.$btnClose=this.$view.find(this._CN+"btn-close-menu"),this.$btnBack=this.$view.find(this._CN+"btn-back, "+this._CN+"std-header-btn-back, "+this._CN+"btn-close-items"),this.$btnInPickUp=this.$view.find(this._CN+"btn-choosing-pick-up"),this.$btnDelivering=this.$view.find(this._CN+"btn-choosing-delivering"),this.behavior(),this},update:function(){this._update_tabindex()},behavior:function(){var t=[this.$btnInPickUp,this.$btnBack,this.$btnDelivering];this._behavior(t),this.$btnBack.on("touchend click",(t=>{e.UVIEWS.go_back(),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnInPickUp.on("touchend click",(t=>{e.VIEW_ORDERING.update({pickupMode:!0}),e.UVIEWS.set_current("the-ordering"),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnDelivering.on("touchend click",(t=>{this.chefsmenu.is_loading_now()||(this.chefsmenu.now_loading(),e.VIEW_ORDERING.update(),e.UVIEWS.set_current("the-ordering")),t.originalEvent.cancelable&&t.preventDefault()}))}},N={load_async_for:function(t){return new Promise(((e,i)=>{this._get_token_async().then((s=>{this._load_with_token_async(t,s).then((t=>{e(t)})).catch((t=>{i(t)}))})).catch((t=>{i(t)}))}))},_load_with_token_async:function(e,i){return new Promise(((s,n)=>{const o=GLB_APP_URL+"pbl/lib/iiko/iiko_get_streets_for_delivery.php",a={id_cafe:e,token:i};t.ajax({url:o+"?callback=?",data:a,dataType:"jsonp",method:"POST",error:t=>{n(t)}}).then((t=>{t&&!t.error?s(t):n(t)}))}))},_get_token_async:function(){return new Promise(((i,s)=>{const n=GLB_APP_URL+"pbl/lib/iiko/get_token_for_cafe_pbl.php";let o=this._get_token_localy();if(o)return void i(o);const a={id_cafe:e.CAFE.get().id};console.log("data----,url",a,n);t.ajax({url:n+"?callback=?",data:a,dataType:"jsonp",method:"POST",error:t=>{s(t)}}).then((t=>{t&&t.token?(o=t.token,this._save_token_localy(o),i(o)):s(t)}))}))},_get_token_localy:function(){var t=e._IIKO_TOKEN,i=e._IIKO_TOKEN_DATE;if(t&&i){var s=((new Date).getTime()-i)/36e5;return console.log("duration",s),!s||s>.5?(console.log("token too old, and will be get new"),!1):t}return console.log("unknown token, will be get new"),!1},_save_token_localy:function(t){e._IIKO_TOKEN=t,e._IIKO_TOKEN_DATE=(new Date).getTime()}},w={init:function(t){return this._init(t),this.TIME_FORMAT=24,this.CLASS_24FORMAT=this.CN+"timeformat-24",this.CLASS_DISABLED=this.CN+"ordering-disabled",this.CLASS_USERTIME_MODE=this.CN+"ordering-usertime-mode",this.CLASS_CURRENT=this.CN+"ordering-select-current",this.CLASS_INPUT_ERROR=this.CN+"input-error",this.$btnBasket=this.$view.find(this._CN+"btn-basket"),this.$btnClose=this.$view.find(this._CN+"btn-close-menu"),this.$btnBack=this.$view.find(this._CN+"btn-back, "+this._CN+"std-header-btn-back, "+this._CN+"btn-close-items"),this.$btnSend=this.$view.find(this._CN+"btn-send"),this.$inputs=this.$view.find("input, textarea"),this.errMessage1=this.$view.find(this._CN+"ordering-message-1"),this.errMessage2=this.$view.find(this._CN+"ordering-message-2"),this.$allParams=this.$view.find(this._CN+"ordering-params"),this.$userComments=this.$view.find(this._CN+"ordering-comment"),this.$btnDate=this.$view.find(this._CN+"ordering-select-date"),this.$btnDateSelect=this.$view.find(this._CN+"ordering-select-date select"),this.$btnTime=this.$view.find(this._CN+"ordering-select-time"),this.$btnTimeSelect=this.$view.find(this._CN+"ordering-select-time select"),this.$btnUsertime=this.$view.find(this._CN+"ordering-select-usertime"),this.$btnUsertimeSelect=this.$view.find(this._CN+"ordering-select-usertime select"),this.$btnTimeSwitch=this.$view.find(this._CN+"ordering-select-switch"),this.$cart_result_message=this.$view.find(this._CN+"cart-result"),this.$fields=this.$view.find(this._CN+"ordering-field, "+this._CN+"ordering-select-usertime"),this.$section_user_address=this.$view.find(this._CN+"ordering-params__user_address"),this.$section_date_time_to=this.$view.find(this._CN+"date-time-to"),this.$section_pick_it_up_at=this.$view.find(this._CN+"pick-it-up-at").hide(),this.$ordering_mode=this.$view.find(this._CN+"ordering-mode"),this.PICKUPSELF_MODE=!1,this.STREETS_LIST=[],this.build_times_select(),this.behavior(),this},update:function(t){if(console.log("VIEW ORDERING!",t),this._update_tabindex(),this._show_attention(!1,!1),this.IIKO_MODE=e.CAFE.is_iiko_mode(),t&&t.pickupMode?(this.PICKUPSELF_MODE=!0,this.$section_user_address.hide(),this.$section_date_time_to.hide(),this.$section_pick_it_up_at.show(),this.$ordering_mode.html("Я заберу заказ сам")):(this.PICKUPSELF_MODE=!1,this.$section_user_address.show(),this.$section_date_time_to.show(),this.$section_pick_it_up_at.hide(),this.$ordering_mode.html("Заказ на доставку")),t&&t.clear){this.$allParams.find("[name=u_phone]").val(""),this.$allParams.find("[name=u_address]").val(""),this.$userComments.val("");var i="<p>"+e.LNG.get("lng_your_shopping_cart_is_empty")+"</p>";this.chefsmenu.end_loading()}else{i=["<p>"+e.LNG.get("lng_for_total_cost")+"<br><span>"+e.CART.the_total()+"</span></p>"].join("\n");const t=e.CAFE.is_iiko_mode();this.STREETS_LIST.length||this.PICKUPSELF_MODE||!t?this.chefsmenu.end_loading():(console.log("start loading streets"),this.load_iiko_cities_async().then((t=>{this.STREETS_LIST=t,this.$view.find(this._CN+"streets"),console.log("streets",t);const e={spelling:function(t,e,i=""){let s=0,n=i;this.foo=e,n+=t.substr(s,1),this.say(n),setTimeout((()=>{s<t.length-1&&(s++,this.spelling(t.substr(1),e,n))}),10)},say:function(t){this.foo&&this.foo(t)}},i=new autoComplete({selector:"input[name=u_street]",placeHolder:"...",data:{src:t,cache:!0},resultItem:{highlight:!0},events:{input:{selection:t=>{console.log("!!",t);const s=t.detail.selection.value;e.spelling(s,(t=>{i.input.value=t}))}}}});setTimeout((()=>{this.chefsmenu.end_loading()}),300)})).catch((t=>{this._show_modal_win("Невозможно загрузить список улиц. \n\t\t            \tОбратитесь к администратору кафе."),console.log("err",t),setTimeout((()=>{this.chefsmenu.end_loading()}),300)})))}this.$cart_result_message.html(i)},build_times_select:function(){24==this.TIME_FORMAT&&this.$allParams.addClass(this.CLASS_24FORMAT);this.$btnUsertimeSelect.html(function(t){for(var e="",i=24==t,s=1;s<t+1;s++){var n=i?s-1:s;e+="<option>"+n+":00</option>",e+="<option>"+n+":30</option>"}return e}(this.TIME_FORMAT))},get_usertime_mode:function(){return this.$allParams.hasClass(this.CLASS_USERTIME_MODE)},set_usertime_mode:function(t){t?this.$allParams.addClass(this.CLASS_USERTIME_MODE):this.$allParams.removeClass(this.CLASS_USERTIME_MODE)},set_date_default:function(){this.$btnDateSelect[0].selectedIndex=0},set_time_default:function(){this.$btnTimeSelect[0].selectedIndex=0},set_usertime_default:function(){var t=24==this.TIME_FORMAT?24:0;this.$btnUsertimeSelect[0].selectedIndex=t},behavior:function(){var i=this,s=[this.$btnBasket,this.$btnBack,this.$btnClose,this.$btnSend];this._behavior(s),this.$fields.each((function(){var e=t(this);e.find("input, textarea, select").on("click",(function(){i.$fields.removeClass("focused"),e.addClass("focused")}))}));var n=()=>{e.CAFE.has_delivery()?e.UVIEWS.go_back():e.UVIEWS.set_current("the-showcart")};this.$btnBack.on("touchend click",(t=>{this.$inputs.is(":focus")?(this.$inputs.blur(),setTimeout((()=>{n()}),500)):n(),this.$fields.removeClass("focused"),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnSend.on("touchend click",(t=>{this.chefsmenu.is_loading_now()||(this.chefsmenu.now_loading(),this.$inputs.is(":focus")?(this.$inputs.blur(),setTimeout((()=>{this.checkup_user_inputs()}),500)):this.checkup_user_inputs(),this.$fields.removeClass("focused")),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnTimeSwitch.on("touchend click",(t=>{this.get_usertime_mode()?(this.set_date_default(),this.set_usertime_default(),this.set_usertime_mode(!1)):(this.set_time_default(),this.set_usertime_default(),this.set_usertime_mode(!0)),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnDateSelect.on("change",(t=>{console.log("this.$btnDateSelect.val()",this.$btnDateSelect.val()),this.$btnDateSelect.val()>0?this.get_usertime_mode()||(this.set_usertime_default(),this.set_usertime_mode(!0)):(this.set_time_default(),this.set_usertime_default(),this.set_usertime_mode(!1)),t.originalEvent.cancelable&&t.preventDefault()}))},_show_attention:function(t,e){t?this.errMessage1.addClass(this.CLASS_INPUT_ERROR):this.errMessage1.removeClass(this.CLASS_INPUT_ERROR),e?this.errMessage2.addClass(this.CLASS_INPUT_ERROR):this.errMessage2.removeClass(this.CLASS_INPUT_ERROR)},checkup_user_inputs:function(){this._show_attention(!1,!1);const t=this.$allParams.find("[name=u_phone]").val(),i=this.get_user_address();if(!this.checkup_user_address_and_phone(t,i))return;const s=e.CAFE.get("id"),n=e.CAFE.get("cafe_currency"),o=e.CART.get_total_price(),[a,r]=this.get_user_time_info(),_={id_cafe:s,order_currency:n,order_total_price:o,order_user_phone:t,order_time_need:r,order_time_sent:a,order_user_full_address:i,order_user_comment:this.$userComments.val()};console.log("order_params = ",_),this.do_order_send(_)},flash_inputs_errors:function(){this.$allParams.animate({scrollTop:0},300),this.errMessage1.addClass("flashed"),this.errMessage2.addClass("flashed"),setTimeout((()=>{this.errMessage1.removeClass("flashed"),this.errMessage2.removeClass("flashed")}),300)},checkup_user_address_and_phone:function(t,e){if(this.PICKUPSELF_MODE){if(!t)return this._show_attention(!t,!1),this.flash_inputs_errors(),setTimeout((()=>{this.chefsmenu.end_loading()}),500),!1}else{let i=this.IIKO_MODE?!e.u_street||!e.u_house:!e.description;if(!t||i)return this._show_attention(!t,i),this.flash_inputs_errors(),setTimeout((()=>{this.chefsmenu.end_loading()}),500),!1}return!0},get_user_address:function(){return this.IIKO_MODE?{description:"",u_street:this.$allParams.find("[name=u_street]").val(),u_house:this.$allParams.find("[name=u_house]").val(),u_flat:this.$allParams.find("[name=u_flat]").val(),u_entrance:this.$allParams.find("[name=u_entrance]").val(),u_floor:this.$allParams.find("[name=u_floor]").val()}:{description:this.$allParams.find("[name=u_address]").val(),u_street:"",u_house:"",u_flat:"",u_entrance:"",u_floor:""}},get_user_time_info:function(){const t=this;var e={getTimeto:function(){return t.get_usertime_mode()?{usertimemode:!0,timeSelected:t.$btnUsertimeSelect.find("option:selected").text()}:{usertimemode:!1,hourOffset:parseInt(t.$btnTimeSelect.val(),10)}},getDateAndTimeto:function(i){var s=new Date,n=parseInt(t.$btnDateSelect.val(),10);if(n)o=e.parseSelectedTime(i),a=new Date(s.getFullYear(),s.getMonth(),s.getDate()+n,o.hours,o.minutes);else if(i.usertimemode)var o=e.parseSelectedTime(i),a=new Date(s.getFullYear(),s.getMonth(),s.getDate(),o.hours,o.minutes);else var a=new Date(s.getFullYear(),s.getMonth(),s.getDate(),s.getHours()+i.hourOffset,s.getMinutes());return a},parseSelectedTime:function(t){var i=t.timeSelected.split(":"),s={hours:parseInt(i[0],10),minutes:parseInt(i[1],10),pm:t.pm};return e.to24(s)},to24:function(t){var e={hours:0,minutes:t.minutes};return t.pm?(e.hours=t.hours<12?t.hours+12:t.hours,e):(e.hours=t.hours<12?t.hours:0,e)},dateExport:function(t){return t.getDate()+"-"+(t.getMonth()+1)+"-"+t.getFullYear()+" "+t.getHours()+":"+t.getMinutes()}};const i=e.getDateAndTimeto(e.getTimeto()),s=e.dateExport(i);return[e.dateExport(new Date),s]},is_phone_number:function(t){var e=t.match(/\d/g);return!(!e||11!=e.length)},do_order_send:function(i){const s=e.CART.get_all(),n=t.extend(i,{order_items:s});this.ORDER_SENDER=t.extend({},A),this.ORDER_SENDER.send_async(n,this.PICKUPSELF_MODE).then((t=>{console.log("--vars--",t),n.short_number=t.short_number,n.demo_mode=t.demo_mode,n.notg_mode=!!t.notg_mode;const i=this.PICKUPSELF_MODE;e.VIEW_ORDER_OK.update(n,{pickupself_mode:i}),e.UVIEWS.set_current("the-order-ok")})).catch((t=>{this._show_modal_win("Заказ не получается отправить. \n            \tОбратитесь к администратору кафе."),console.log("err",t),setTimeout((()=>{this.chefsmenu.end_loading()}),1e3)}))},load_iiko_cities_async:function(){return new Promise(((i,s)=>{t.extend({},N).load_async_for(e.CAFE.get().id).then((t=>{t.streets?i(t.streets):s(t)})).catch((t=>{s(t)}))}))}};const T={check_if_order_taken_async:function(t,e){return new Promise(((i,s)=>{const n=60*SITE_CFG.order_forgotten_delay*1e3;console.log(`total_times = ${SITE_CFG.order_forgotten_delay} min = ${n/1e3} sec`);let o=0;const a=setInterval((()=>{console.log("start checking the order status"),o++,this.check_order_status_async(t,e).then((t=>{console.log("result",t),console.log("result.order_status",t.order_status),"taken"==t.order_status||"sentout"==t.order_status?(clearInterval(a),i(t)):console.log(`order is waiting now... ${5e3*o/1e3} s из ${60*SITE_CFG.order_forgotten_delay} s`)})).catch((t=>{clearInterval(a),s(t)}))}),5e3);setTimeout((()=>{clearInterval(a),s("timeout")}),n)}))},check_order_status_async:function(t,e){return new Promise(((i,s)=>{const n=GLB_APP_URL+"pbl/lib/pbl.check_order_status.php",o={short_number:t,cafe_uniq_name:e};$.ajax({url:n+"?callback=?",data:o,dataType:"jsonp",method:"POST",error:t=>{s(t)}}).then((t=>{t&&!t.error?i(t):s(t)}))}))}};var L={init:function(e){return this._init(e),this.$headerPhone=this.$view.find(this._CN+"header-phone"),this.$btnBasket=this.$view.find(this._CN+"btn-basket"),this.$btnClose=this.$view.find(this._CN+"btn-close-menu"),this.$btnBack=this.$view.find(this._CN+"btn-back, "+this._CN+"std-header-btn-back, "+this._CN+"btn-close-items"),this.$msgReport=this.$view.find(this._CN+"order-ok-report-main"),this.$msgDemo=this.$view.find(this._CN+"order-ok-demo-message"),this.$msgNotFoundTgUsers=this.$view.find(this._CN+"order-ok-notg-message"),this.$msgManager=this.$view.find(this._CN+"order-ok-operator-message"),this.$msgOrderSentDelivery=this.$view.find(this._CN+"order-ok-report-delivery"),this.$msgCartList=this.$view.find(this._CN+"order-ok-cart-list"),this.$totalCost=this.$view.find(this._CN+"order-ok-total-cost"),this.$tplOrderedItem=t("#mm2-templates "+this._CN+"ordered-item"),this.$operator_message=this.$view.find(this._CN+"order-ok-operator-message"),this.$progressbar=this.$view.find(this._CN+"order-wating-progress-bar"),this.behavior(),this},behavior:function(){var t=[this.$btnBasket,this.$btnBack,this.$btnClose];this._behavior(t),this.$btnBack.on("touchend click",(function(){return e.UVIEWS.go_first(),!1}))},update:function(t,i){this.set_operator_message_to_start(),this.progress_bar_restart(),this.TABLE_MODE=!(!i||!i.table_number),this.IIKO_MODE=e.CAFE.is_iiko_mode(),this.PICKUPSELF_MODE=!(!i||!i.pickupself_mode),this.order=t,this.update_template_part_common(),!this.TABLE_MODE&&this.update_template_part_delivery(),this.build_ordered_list(this.order.order_items),e.CART.cart_clear(),e.VIEW_ORDERING.update({clear:!0}),this.order.demo_mode||this.order.notg_mode||this.check_the_order_status(this.order.short_number,e.CAFE.get("uniq_name")),this.chefsmenu.end_loading()},update_template_part_common(){this.order.demo_mode?(this.$msgDemo.show(),this.$msgManager.hide()):this.order.notg_mode?(this.$msgDemo.hide(),this.$msgNotFoundTgUsers.show(),this.$msgManager.hide()):(this.$msgDemo.hide(),this.$msgNotFoundTgUsers.hide(),this.$msgManager.show());var t=e.CAFE.get("cafe_phone");if(""!==t?this.$headerPhone.find(this._CN+"header-phone__text").html(t):this.$headerPhone.hide(),t){var i=t.replace(/[-() ]/g,"");this.$headerPhone.on("touchend click",(function(){return location.href="tel:"+i,!1}))}var s=["<h2>"+e.LNG.get("lng_number_of_your_order")+"</h2>","<h3>"+this.order.short_number+"</h3>"].join("\n");this.$msgReport.html(s)},update_template_part_delivery:function(){var t=this.order.order_time_need===this.order.order_time_sent?e.LNG.get("lng_near_time"):this.formatLngTime(this.order.order_time_need);let i="";const s=this.order.order_user_full_address;if(this.IIKO_MODE){const t=s.u_entrance?`, подъезд ${s.u_entrance}`:"",e=s.u_floor?`, эт. ${s.u_floor}`:"",n=s.u_flat?`, кв. ${s.u_flat}`:"";i=`ул. ${s.u_street}, д. ${s.u_house}${n}${e}${t}.`}else i=s.description;let n=this.PICKUPSELF_MODE?"<span>Доставка: </span> Заберу сам.<br>":`<span>${e.LNG.get("lng_address")}</span> ${i}<br>`;var o=e.CAFE.get("cafe_currency").symbol,a=["<p>","<span>"+e.LNG.get("lng_time_from")+"</span> "+this.formatLngTime(this.order.order_time_sent)+"<br>","<span>"+e.LNG.get("lng_time_to")+"</span> "+t+"<br>","<span>"+e.LNG.get("lng_amount")+"</span> "+this.order.order_total_price+" "+o+"<br>","<span>"+e.LNG.get("lng_tel")+"</span> "+this.order.order_user_phone+"<br>",n,"<br>"+this.order.order_user_comment,"</p>"].join("\n");this.$msgOrderSentDelivery.html(a)},set_operator_message_to_start:function(){this.$operator_message.removeClass("bright");this.$operator_message.find("span").html("Отлично! Ваш заказ отправлен и скоро будет принят в работу")},set_operator_message_to:function(t){this.$operator_message.addClass("bright"),this.$operator_message.find("span").html(t)},progress_bar_to_end:function(){this.statusbarIsStopped=!0;this.$progressbar.find("div").css({width:"100%",transition:"1s"})},progress_bar_restart:function(){this.$progressbar.show();const t=this.$progressbar.find("div");t.css({width:"0%",transition:"0s"});const e=60*SITE_CFG.order_forgotten_delay;this.statusbarIsStopped=!1;const i={animateProgressBar:(t,e)=>{let s=performance.now(),n=1e3*t;this.statusbarIsStopped=!1,requestAnimationFrame(i.update.bind(this,e,s,n))},update:(t,e,s)=>{if(this.statusbarIsStopped)return;let n=performance.now()-e,o=Math.min(n/s,1);t.style.width=100*o+"%",o<1?requestAnimationFrame(i.update.bind(this,t,e,s)):this.timeout_for_taking_the_order()}};console.log("overTime = ",e),i.animateProgressBar(e,t[0])},formatLngTime:function(t,i){var s=t.split(" "),n=s[0].split("-"),o=e.LNG.get("lng_all_months").split("-"),a=i?" "+n[2]:"";return n[0]+" "+o[parseInt(n[1],10)-1]+a+", "+s[1]},build_ordered_list:function(i){const s=e.CAFE.get("cafe_currency").symbol,n=e.CAFE.is_iiko_mode(),o={buildArrRows:e=>{const i=t("<ul></ul>");for(let s in e)if(e.hasOwnProperty(s)){let n=e[s];if(n){let e=t("<li></li>"),s=o.buildRow(n);e.append(s),i.append(e)}}return i},buildRow:t=>{const e=t.item_data.title,i=t.count,o=t.price_with_modifiers,a=`${t.volume} ${t.units}`,r=n?`${t.sizeName} / ${a}`:a,_=t.chosen_modifiers;let h="";if(n&&_&&_.length)for(let t in _){h+="+ "+_[t].name+"<br>"}const l=i+" x "+o+" "+s,c=this.$tplOrderedItem.clone();return c.find(this._CN+"ordered-title__item").html(e),c.find(this._CN+"ordered-title__volume").html(r),n&&c.find(this._CN+"ordered-title__modifiers").html(h),c.find(this._CN+"ordered-quantity").html(l),c}},a=o.buildArrRows(i);this.$msgCartList.html(a);const r="Итого: "+e.CART.get_total_price()+" "+s;this.$totalCost.html(r)},check_the_order_status:function(e,i){this.ORDER_CHECKER=t.extend({},T),this.ORDER_CHECKER.check_if_order_taken_async(e,i).then((t=>{console.log("--vars--",t),"taken"===t.order_status&&this.show_successful_message(t.order_manager_name)})).catch((t=>{console.log("err",t)}))},timeout_for_taking_the_order:function(){this.statusbarIsStopped=!0,this.show_fail_message()},show_fail_message(){this.progress_bar_to_end(),this.set_operator_message_to("Внимание! <br>Заказ не взяли в работу.<br> Обратитесь к администратору!")},show_successful_message(t){this.progress_bar_to_end(),this.set_operator_message_to(`Заказ в работе! <br> Ваш официант – ${t}`)}},R={init:function(t){return this._init(t),this.$btnBasket=this.$view.find(this._CN+"btn-basket"),this.$btnClose=this.$view.find(this._CN+"btn-close-menu"),this.$btnBack=this.$view.find(this._CN+"btn-back, "+this._CN+"std-header-btn-back, "+this._CN+"btn-close-items"),this.$msgCancelReport=this.$view.find(this._CN+"order-cancel-message"),this.behavior(),this},behavior:function(){var t=[this.$btnBasket,this.$btnBack,this.$btnClose];this._behavior(t),this.$btnBack.on("touchend click",(function(){return e.UVIEWS.set_current("the-ordering"),!1}))},update:function(t){this.$msgCancelReport.html(t),this.chefsmenu.end_loading()}},O={init:function(t){return this._init(t),this.$btnBasket=this.$view.find(this._CN+"btn-basket"),this.$btnClose=this.$view.find(this._CN+"btn-close-menu"),this.$btnBack=this.$view.find(this._CN+"btn-back, "+this._CN+"std-header-btn-back, "+this._CN+"btn-close-items"),this.$btnSave=this.$view.find(this._CN+"btn-save"),this.$table_list=this.$view.find(this._CN+"alltables-list"),this.behavior(),this},update:function(t){this._need2save(!1),this.CURRENT_TABLE=parseInt(t,10),this.CHOSEN_TABLE=-1;let i=e.CAFE.get().tables_uniq_names;i=JSON.parse(i);let s=e.CAFE.get().iiko_tables;if(s=JSON.parse(s),!s||!i)return!1;this.build(s,i,t)},build:function(e,i,s){let n="";for(let t in e)if(e.hasOwnProperty(t)){let o=e[t],a=o.tables;if(a.length)for(let t in a)if(a.hasOwnProperty(t)){let e=a[t];n+=`<li class="${parseInt(e.number,10)===parseInt(s,10)?"current":""} ${i["table-"+e.number]?"":"disabled"}" data-table-number="${e.number}">\n\t\t\t\t\t\t\t\t<span>№-${e.number}<span>\n\t\t\t\t\t\t\t\t<span>${o.section_name}: ${e.name}</span>\n\t\t\t\t\t\t\t\t</li>`}}n=`<ul>${n}</ul>`,this.$table_list.html(n),this.$table_list.find("li").each(((e,i)=>{t(i).on("touchstart",(e=>{t(i).addClass("active")})),t(i).on("touchend",(e=>{t(i).removeClass("active"),this.VIEW_SCROLLED||t(i).hasClass("current")||t(i).hasClass("disabled")||(t(i).siblings().removeClass("current"),t(i).addClass("current"),this.check_if_need2save(t(i).data("table-number"))),e.originalEvent.cancelable&&e.preventDefault()}))}))},check_if_need2save:function(t){this.CHOSEN_TABLE=parseInt(t,10);let e=this.CHOSEN_TABLE!==this.CURRENT_TABLE;this._need2save(e)},behavior:function(){const t=[this.$btnBasket,this.$btnBack,this.$btnClose];this._behavior(t),this.$btnBack.on("touchend click",(t=>{e.UVIEWS.go_first(),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnSave.on("touchend click",(t=>{this.save(),t.originalEvent.cancelable&&t.preventDefault()}))},save:function(){if(console.log("new save",this.CHOSEN_TABLE),this.CHOSEN_TABLE<1)return!1;let t=e.CAFE.get().tables_uniq_names;if(!t)return!1;t=JSON.parse(t);let i=t["table-"+this.CHOSEN_TABLE];if(!i)return!1;const s=e.CAFE.get("uniq_name"),n=`${SITE_CFG.home_page}cafe/${s}/table/${i}`;location.href=n}};return e.META_VIEWPORT=i,e.CALLBACK_RANDOM=s,e.MOBILE_BUTTONS=n,e.CMN=o,e.UVIEWS=a,e.CAFE={init:function(t){this.OBJ_CAFE=t},get:function(t){return t?"cafe_currency"===t?this.get_currency():this.OBJ_CAFE[t]:this.OBJ_CAFE},get_status:function(){return this.OBJ_CAFE.cafe_status},has_delivery:function(){return this.OBJ_CAFE.has_delivery>0},get_currency:function(){var t=this.OBJ_CAFE.cafe_currency,e={RUB:"руб.",USD:"$",EUR:"€",JPY:"¥",GBP:"£",KRW:"₩"}[t.toUpperCase()];return e?{code:t,symbol:e}:{code:"USD",symbol:"$"}},is_iiko_mode:function(){return""!==this.get().iiko_api_key}},e.LNG=r,e.MENU_ICONS={init:function(){this.arrIcons=["main_dishes","soups","salade","chicken","fish","steak","seafood","bbq","kebabs","pasta","pizza","sushi_and_rolls","dumpling","asian_food","sandwiches","slicing","canapes","fast_food","ice_cream","fruits","pancakes","bakery","cakes","childrens_menu","tea","coffee","juice_and_water","cocktails","beer","alcohol","khachapuri_1","khachapuri_2","khinkali","chebureki","pita_1","pita_2","pita_3","salade_1","risotto_1","risotto_2","fastfood_1","fastfood_2","fastfood_3","fastfood_4"]},get:function(t){return t?this.arrIcons[t]?this.arrIcons[t]:"":this.arrIcons}},e.CART=_,e.ITEM=f,e.CHEFSMENU=p,e.TABINDEX=g,e.MENU_TABLE_MODE=E,e.VIEW_ALLMENU=t.extend(C,b),e.VIEW_ALLITEMS=t.extend(v,b),e.VIEW_CART=t.extend(I,b),e.VIEW_ORDERING=t.extend(w,b),e.VIEW_CHOOSING_MODE=t.extend(S,b),e.VIEW_ORDER_OK=t.extend(L,b),e.VIEW_ORDER_CANCEL=t.extend(R,b),e.VIEW_TABLE_CHANGE=t.extend(O,b),e.G_DATA="CHEFSMENUGLOBALDATA",function(t){e.META_VIEWPORT.init();var i=e.META_VIEWPORT.is_mobile(),s=t(".chefsmenu-link");if(s.length){window[e.G_DATA]||(window[e.G_DATA]={WAS_BUILT:!1,PRE:"mm2-",SHOWED:0,ALLCAFE:{},ALLMENU:{},ALLITEMS:{},ALLSKINS:null,MAINSTYLE:"",CURRSKIN:{id:null,link:null},EXT_MODE:i});var n={prepare_menu:function(i,s){t.extend({},p).init({G_DATA:e.G_DATA,$link:i,CHEFS_URL:CHEFS_URL,onReady:s})}};n.prepare_menu(s.eq(0),(function(){s.length>1&&s.each((function(e){e&&n.prepare_menu(t(this),!1)}))}))}}(jQuery)}(jQuery);
