var App=function(){"use strict";var t={},e={init:function(t){this.LANG_CURRENT=this.get_index(t),this.AUTO_LNG_COUNT=0,this.LANG_DATA={lng_change:["-","Изменить"],lng_choose:["-","Выбрать"],lng_add:["-","Добавить"],lng_back:["-","Назад"],lng_rotate:["-","Повернуть"],lng_title:["-","Название"],lng_thank:["-","Спасибо"],lng_description:["-","Описание"],lng_price:["-","Стоимость"],lng_volume:["-","Объем"],lng_update:["-","Обновление!"],lng_save:["-","Сохранить"],lng_send:["-","Отправить"],lng_error:["-","Ошибка!"],lng_currency:["-","Валюта"],lng_symbol:["-","Символ"],lng_attention:["-","Внимание!"],lng_close:["-","Закрыть"],lng_ok:["-","ОК"],lng_cancel:["-","Отмена"],lng_edit:["-","Редактировать"],lng_hello:["-","Привет"],lng_delete:["-","Удалить"],lng_customize:["-","Настройки"],lng_help:["-","Помощь"],lng_flag_new:["-","Новинка"],lng_flag_hit:["-","Хит"],lng_flag_vege:["-","Веге"],lng_public_skin:["-","Оформление меню"],lng_public_skin_light:["-","Светлое оформление"],lng_public_skin_dark:["-","Темное оформление"],lng_untitled:["-","Без названия"],lng_something_wrong:["-","Неожиданная ошибка"],ico_main_dishes:["-","Основные блюда"],ico_soups:["Soup","Супы"],ico_salade:["Salade","Салаты"],ico_chicken:["Chicken","Птица"],ico_fish:["Fish","Рыба"],ico_steak:["Steak","Стейк"],ico_seafood:["Seafood","Морепродукты"],ico_bbq:["BBQ","Блюда на гриле"],ico_kebabs:["Kebabs","Шашлыки"],ico_pasta:["Pasta","Паста"],ico_pizza:["Pizza","Пицца"],ico_sushi_and_rolls:["Sushi and Rolls","Суши и Роллы"],ico_dumpling:["Dumpling","Дамплинги"],ico_asian_food:["Asian food","Азиатская кухня"],ico_sandwiches:["Sandwiches","Бутерброды"],ico_slicing:["Slicing","Нарезки"],ico_canapes:["Canape","Фуршет, канапе","Canape"],ico_fast_food:["Fast food","Бургеры, хот-доги"],ico_ice_cream:["Ice cream","Мороженое"],ico_fruits:["Fruits","Фрукты"],ico_pancakes:["Pancakes","Блины"],ico_bakery:["Bakery","Выпечка"],ico_cakes:["Cakes","Торты"],ico_childrens_menu:["Children`s menu","Детское меню"],ico_tea:["Tea","Чай"],ico_coffee:["Coffee","Кофе"],ico_juice_and_water:["Juice and water","Сок и вода"],ico_cocktails:["Cocktails","Коктейли"],ico_beer:["Beer","Пиво"],ico_alcohol:["Alcohol","Алкоголь"],lng_view_customize_all__change_cafe_info:["-","Здесь вы можете указать информацию о кафе: название, телефон и т.д."],lng_view_customize_all__change_cafe_info_btn:["-","Информация о кафе"],lng_view_customize_all__menu_link:["-","Здесь вы можете скачать QR-код и поделиться ссылкой на ваше меню"],lng_view_customize_all__menu_link_btn:["-","Ссылка и QR-code"],lng_view_customize_all__change_pass:["-","Здесь вы можете изменить пароль для входа в эту панель управления:"],lng_view_customize_all__change_pass_btn:["-","Изменить пароль"],lng_view_customize_all__change_subdomain:["-","Выберите для вашего меню запоминающийся адрес:"],lng_view_customize_all__change_subdomain_btn:["-","Выбрать адрес"],lng_view_customize_all__get_contract:["-","Чтобы снять все ограничения тестового периода:"],lng_view_customize_all__get_contract_btn:["-","Снять ограничения"],lng_view_customize_all__customize_interface:["-","Чтобы изменить валюту, тему и другие настройки интерфейса"],lng_view_customize_all__customize_interface_btn:["-","Настроить интерфейс"],lng_view_customizing_cart__view_title:["-","Настройка Корзины"],lng_view_customizing_cart__cart_mode:["-","Выберите режим корзины на сайте"],lng_view_customize_all__change_cart_settings:["-","Здесь вы можете настроить получение заказов от Посетителей"],lng_view_customize_all__change_cart_settings_btn:["-","Настроить Корзину"],lng_view_customize_all__code_for_embed:["-","Здесь вы можете получить код для вставки меню на ваш собственный сайт"],lng_view_customize_all__code_for_embed_btn:["-","Код для встраивания"],lng_view_customize_all__app_version:["-","Версия: <span>[app-version]</span>"],lng_view_customize_all__acc_exit:["-","Выйти из аккаунта"],lng_view_customize_all__main_customizing:["-","Главные настройки"],lng_view_change_password__title:["-","Изменение пароля"],lng_view_change_password__new_pass:["-","Новый пароль"],lng_view_change_password__text1:["-",["-","После этого перейдите на вашу почту и <strong>подтвердите</strong> смену пароля."].join("")],lng_view_change_subdomain__title:["-","Изменение поддомена"],lng_view_change_subdomain__text1:["-","Адрес вашего меню:"],lng_view_change_subdomain__text2:["-",["<p>Чтобы выбрать дополнительный, более запоминающийся адрес. ","Напишите вместо <strong>yourname</strong> любое слово:</p>"].join("")],lng_view_change_subdomain__text3:["-","<p>Чтобы изменить его, напишите вместо <strong>yourname</strong> любое слово:</p>"],lng_view_change_subdomain__text4:["-",["<p>Соблюдайте простые условия:</p><p>","1. Минимальное количество символов – 3.<br>","2. Максимальное количество символов – 10.<br>","3. Разрешенные символы: все символы латинского алфавита, тире и цифры.<br>","4. Имя должно начинаться с буквы или цифры.</p>"].join("")],lng_view_change_subdomain__text5:["-","На заметку"],lng_view_change_subdomain__text6:["-","У вашего меню есть также постоянный неизменный адрес, полученный при регистрации:"],lng_view_iiko_customization__title:["-","Настройка iiko"],lng_view_iiko_adding_api_key__title:["-","Подключение iiko"],lng_view_cafe_link__view_title:["-","Ссылка и QR-code"],lng_view_cafe_link__hard_link:["-","Адрес вашего меню:"],lng_view_cafe_link__qrcode:["-","Получите на почту и распечатайте этот QR-код вашего меню. Ваши посетители смогут за пару секунд открыть ваше меню у себя на телефоне."],lng_view_cafe_link__tutor:["-","Вместе с qr-кодом вам на почту придет простая инструкция по применению."],lng_view_cafe_link__btn_get_qrcode:["-","Получить <nobr>QR-code</nobr>"],lng_view_customizing_cafe__about:["-","<nobr>О кафе</nobr>"],lng_view_customizing_cafe__title:["-","Название кафе:"],lng_view_customizing_cafe__address:["-","Адрес:"],lng_view_customizing_cafe__cook:["-","Шеф повар:"],lng_view_customizing_cafe__phone:["-","Телефон:"],lng_view_customizing_cafe__work_hours:["-","Часы работы:"],lng_view_customizing_cafe__description:["-","Краткое описание"],lng_view_get_contract__remove_limits:["-","Снять ограничения:"],lng_view_get_contract__connect:["-","Подключиться"],lng_view_get_code__code_for_embed:["-","Код для встраивания"],lng_view_get_code__text1:["-",["<p>У вашего меню есть свой постоянный адрес. Однако, вы возможно захотите встроить это меню на свой собственный сайт.</p>","<p>Сделать это очень просто.</p>","<p>Для сайтов на основе <strong>WordPress</strong> достаточно установить <strong>бесплатный плагин</strong> и в любом месте страницы ввести уникальный код вашего меню:</p>"].join("")],lng_view_get_code__text2:["-",["<p>Для всех остальных сайтов подключить меню также просто.</p>","<p>Получите код и простую <strong>универсальную инструкцию</strong> подключения на почту, а также ссылку на плагин для WordPress.</p>"].join("")],btn_get_code:["-","Получить код"],lng_view_customize_interface__view_title:["-","Настройка интерфейса"],lng_view_customize_interface__select_lng:["-","Выберите язык интерфейса"],lng_customize:["-","Эти настройки повлияют только на интерфейс админки"],lng_view_customize_interface__cart_mode:["-","Выберите режим корзины на сайте"],lng_light_skin:["-","Светлое оформление"],lng_dark_skin:["-","Темное оформление"],lng_view_edit_menu__edit:["-","Редактирование раздела"],lng_view_edit_menu__add:["-","Добавление раздела"],lng_required_field:["-","Введите название раздела"],lng_view_edit_item__menu_section:["-","Здесь вы можете изменить раздел в котором находится это блюдо:"],lng_item_edit:["-","Редактирование блюда"],lng_item_add:["-","Добавление блюда"],lng_tochoose_image:["-","Выберите изображение:"],lng_tochange_image:["-","Заменить изображение:"],lng_required_item_title:["-","Введите название блюда"],lng_view_edit_item__error_add:["-","<p>Невозможно добавить блюдо сейчас.</p><p>Попробуйте позже или сообщите в поддержку.</p>"],lng_view_edit_item__error_edit:["-","<p>Невозможно сохранить блюдо сейчас.</p><p>Попробуйте позже или сообщите в поддержку.</p>"],lng_view_item_image_change__title:["-","Замена изображения"],lng_no_title:["-","Без названия"],lng_no_description:["-","Нет описания"],lng_view_all_items__is_empty:["-","Этот раздел пока пустой.<br>Добавьте сюда блюдо."],lng_replacing_parent_section:["-","Выбор раздела меню"],lng_choose_parent_menu:["-","Выберите раздел, в котором будет находиться это блюдо"],lng_view_all_menu_control__settings:["-","Настройки"],lng_limits_total_section__test:["-","<p>Количество разделов ограничено тестовым режимом.</p><p>Откройте «Помощь», чтобы ознакомиться со всеми возможностями и ограничениями сервиса.</p>"],lng_limits_total_section__full:["-","<p>Добавление нового раздела ограничено.</p><p>Откройте «Помощь», чтобы ознакомиться со всеми возможностями и ограничениями сервиса.</p>"],lng_limits_items_in_section__test:["-","<p>Количество блюд в разделе ограничено тестовым режимом.</p><p>Откройте «Помощь», чтобы ознакомиться со всеми возможностями и ограничениями сервиса.</p>"],lng_limits_items_in_section__full:["-","<p>Количество блюд в разделе ограничено.</p><p>Откройте «Помощь», чтобы ознакомиться со всеми возможностями и ограничениями сервиса.</p>"],lng_view_replacing_parent_section__view_title:["-","Выбор раздела"],lng_view_cafe_description__view_title:["-","Краткое описание"],lng_view_cafe_description__about:["-","О кафе:"],lng_view_main_help__send_question:["-","Отправить вопрос"],lng_view_main_help__links:["-","Здесь собраны ссылки на видео с ответами на различные вопросы по управлению вашим меню."],lng_view_main_help__have_questions:["-","Остались вопросы? Напишите нам прямо здесь. Мы ответим на вашу почту [email]:"],lng_confirm_delete:["-","Подтвердите удаление"],lng_select_action:["-","Выберите действие для"],lng_del_menu:["-","Удаление меню"],lng_del_cafe:["-","Удаление кафе"],lng_no_one_cafe:["-","Для начала добавьте кафе"],lng_limit_adding_cafe:["-","На данный момент для одного аккаунта возможно добавить только три кафе"],lng_err_add_menu:["-","Ошибка добавления меню"],lng_min_cafe:["-","Необходимо оставить как минимум одно кафе. Вы всегда можете изменить его."],lng_min_menu:["-","Необходимо оставить как минимум  один раздел. Вы всегда можете изменить его"],lng_load_large_image:["-","Загрузка большого изображения"],lng_min_pass_length:["-","Минимальная длина пароля - 6 символов"],lng_passwords_donot_match:["-","Новый пароль не должен совпадать с текущим паролем"],lng_some_err:["-","Ой, что-то не так"],lng_unknown_user:["-","Неизвестный пользователь"],lng_unknown_data:["-","Неизвестное значение"],lng_err_password:["-","Неправильно введен текущий пароль"],lng_pass_too_short:["-","Пароль слишком короткий"],lng_cannot_save:["-","Невозможно сохранить сейчас"],lng_not_specified_cafe:["-","Не указано кафе"],lng_unknown_cafe:["-","Неизвестное кафе"],lng_external:["-","Открыть сайт кафе"],err_code_106:["-","Изображение слишком мало. Рекомендуется не менее 2Mpx (1600x1200px)"],err_code_107:["-","Изображение слишком велико. Рекомендуется не больше 16Mpx"]}},update:function(t){this.LANG_CURRENT=this.get_index(t)},get_index:function(t){for(var e=0,i=["en","ru"],n=(t=t.toLowerCase(),0);n<i.length;n++)t===i[n]&&(e=n);return e},get:function(t){if("object"==typeof t&&t.length>0)return t[this.LANG_CURRENT];t=t.toLowerCase();return this.LANG_DATA[t]?this.LANG_DATA[t][this.LANG_CURRENT]:"Unknown"},add:function(t){this.AUTO_LNG_COUNT++;var e="auto_lang_"+this.AUTO_LNG_COUNT;return this.LANG_DATA[e]=t,'<div lang="'+e+'">'+t[this.LANG_CURRENT]+"</div>"}},i={init:function(e){this.iconsData=[{title:"main_dishes"},{title:"soups"},{title:"salade"},{title:"chicken"},{title:"fish"},{title:"steak"},{title:"seafood"},{title:"bbq"},{title:"kebabs"},{title:"pasta"},{title:"pizza"},{title:"sushi_and_rolls"},{title:"dumpling"},{title:"asian_food"},{title:"sandwiches"},{title:"slicing"},{title:"canapes"},{title:"fast_food"},{title:"ice_cream"},{title:"fruits"},{title:"pancakes"},{title:"bakery"},{title:"cakes"},{title:"childrens_menu"},{title:"tea"},{title:"coffee"},{title:"juice_and_water"},{title:"cocktails"},{title:"beer"},{title:"alcohol"}],this.arrData=[];for(var i=0;i<this.iconsData.length;i++)this.arrData.push({title:t.LNG.get("ico_"+this.iconsData[i].title),className:"ico-"+this.iconsData[i].title})},get:function(t){return void 0!==t?this.arrData[t]?this.arrData[t]:{title:"Unknown",className:""}:this.arrData},get_total:function(){return this.arrData.length}},n={init:function(t){this.arrCurrency={USD:"$",RUB:"&#8381",EUR:"€"}},get_all:function(){return this.arrCurrency},get_by_code:function(t){return this.arrCurrency[t]},get_current:function(){return this.get_by_code(t.THE_CAFE.get().cafe_currency)}},s={init:function(){return this.CAFE=!1,this.MODE="chefsmenu",this},load:function(t){var e=this;this.AJAX=$.ajax({url:"adm/lib/lib.get_cafe_info.php?callback=?",data:{},dataType:"jsonp",method:"POST",success:function(i){i&&!i.error?(e.CAFE=i.cafe,e._update_mode(),t.onReady&&t.onReady(i.cafe)):console.log(i.error)},error:function(t){console.log("err load cafe info",t)}})},_update_mode:function(){""!=this.CAFE.iiko_api_key?this.MODE="iiko":this.MODE="chefsmenu"},is_iiko_mode:function(){return"iiko"==this.MODE},update:function(t){this.CAFE=t},set:function(t){for(var e in t)this.CAFE[e]=t[e]},get:function(t){return t?this.CAFE[t]:this.CAFE},get_link:function(t){if(-1==["url","name","full"].indexOf(t=t||"full"))return"";if(!this.get("subdomain"))return this.get_link_tech(t);var e=CFG.http+this.get("subdomain")+"."+CFG.www_url,i=this.get("subdomain")+"."+CFG.www_url,n='<a href="'+e+'">'+i+"<a>";switch(t){case"full":return n;case"url":return e;case"name":return i}},get_link_tech:function(t){if(-1==["url","name","full"].indexOf(t=t||"full"))return"";var e=CFG.http+CFG.www_url+"/cafe/"+this.get("uniq_name"),i=CFG.www_url+"/cafe/"+this.get("uniq_name"),n='<a href="'+e+'">'+i+"<a>";switch(t){case"url":return e;case"name":return i;case"full":return n}}},o={init:function(){return this.$allinputs=$("input,textarea"),this.clear(),this},clear:function(){this.$allinputs.attr("tabindex","-1")}},a={init:function(){return this.$body=$("body"),console.log("navigator.userAgent",navigator.userAgent),this.is_Android=/(android)/i.test(navigator.userAgent),this.is_iOS=/iPad|iPhone|iPod|Mac OS/i.test(navigator.userAgent),this.add_class_to_body(),this},add_class_to_body:function(){this.is_Android&&this.$body.addClass("is_android"),this.is_iOS&&this.$body.addClass("is_ios")},is_android:function(){return this.is_Android},is_ios:function(){return this.is_iOS}},_={init:function(){return this.ARR=[],this},update:function(t){this.ARR=t},add:function(t){this.ARR.push(t)},get:function(){return this.ARR},get_arr_id:function(){var t=[];return $.each(this.ARR,(function(){t.push(this.id)})),t},get_by_id:function(t){if(!this.ARR.length||!t)return!1;for(var e=!1,i=0;i<this.ARR.length;i++)if(parseInt(this.ARR[i].id,10)==parseInt(t,10)){e=this.ARR[i];break}return e},get_index_by_id:function(t){if(!this.ARR.length||!t)return-1;for(var e=-1,i=0;i<this.ARR.length;i++)if(parseInt(this.ARR[i].id,10)==parseInt(t,10)){e=i;break}return e}},r={init:function(){return this.ARR={},this},update:function(t,e){this.ARR[t]=e,console.log("this.ARR",this.ARR)},add:function(t,e){if(!this.ARR[t]||!e)return!1;this.ARR[t].push(e)},get:function(t){return!!t&&(this.ARR[t]?this.ARR[t]:[])},get_arr_id:function(t){if(!t||!this.ARR[t])return!1;var e=[];return $.each(this.ARR[t],(function(){e.push(this.id)})),e},replace_item:function(t,e){if(!(t&&this.ARR[t]&&e&&e.id))return!1;for(var i=!1,n=0;n<this.ARR[t].length;n++)if(console.log("id=id",this.ARR[t][n].id,e.id),parseInt(this.ARR[t][n].id,10)==parseInt(e.id,10)){i=this.ARR[t][n]=e;console.log("this.ARR[id_menu]["+n+"]",this.ARR[t][n]);break}return i}},l={init:function(){return this._input_names={"cafe-title":50,"chief-cook":300,"cafe-address":300,"cafe-phone":100,"work-hours":300,"cafe-description":3e3,"new-subdomain":50,"iiko-api-key":50,"new-password":100,"item-title":300,"item-description":500,"item-volume":100,"item-price":10,"menu-title":50,"help-user-ask":3e3},this},get:function(t){try{return this._input_names[t]}catch{return 0}}},h={init:function(t){this.$allviews=$(t.viewsParent),this.arrViews={},this.arrHistory=[],this.addMiddleLayer(),this.CURRENT_VIEW="",this.DBLTAP_DELAY=600,this.DBLTAP=!1,this.PAUSE_BEFORE_ANIM_CURRENT=50,this.ANI={left:{transition:".6s cubic-bezier(0.23, 1, 0.32, 1)",transition2:".3s cubic-bezier(0.23, 1, 0.32, 1)",delay:700},zoom:{transition:".3s",delay:400},modal:{transition:".3s",delay:400}}},getArrViews:function(){return this.arrViews},addView:function(t){this.$allviews.append(t.$view),this.arrViews[t.name]=t,this.parkView(t)},getCurrentName:function(){return this.CURRENT_VIEW},setCurrent:function(t){if(this.preventDoubleTap())return!1;if(this.CURRENT_VIEW==t)return!1;var e=this.arrViews[t];this.arrHistory.length?(this.arrHistory.push(t),this.showViewAnimation(t)):(this.arrHistory.push(t),e.$view.css({transform:"translate3d(0,0,0)",zIndex:100})),this.CURRENT_VIEW=t},jumpTo:function(t){if(this.toStart(),this.CURRENT_VIEW==t)return!1;this.arrHistory.push(t);var e=this.arrViews[t],i=10*this.arrHistory.length+100,n=this.getParent();this.TMR&&clearTimeout(this.TMR),e.$view.css({transform:"translate3d(0,0,0)",transition:"0s",zIndex:i}),n&&n.$view.css({transform:"translate3d(-50%,0,0)",transition:"0s"}),this.CURRENT_VIEW=t},goBack:function(){var t=this;if(console.log("BACK!"),this.preventDoubleTap())return!1;var e=this.getParent(),i=this.arrHistory.pop(),n=this.arrViews[i];switch(this.getAnimMethod(n)){case"animLeft":n.$view.css({transform:"translate3d(120%,0,0)",transition:t.ANI.left.transition}),e&&e.$view.css({transform:"translate3d(0,0,0)",transition:t.ANI.left.transition2}),this.TMR&&clearTimeout(this.TMR),this.TMR=setTimeout((function(){n.$view.css({zIndex:0})}),t.ANI.left.delay);break;case"zoomOut":n.$view.css({transform:"translate3d(0,0,0) scale(1.1)",transition:t.ANI.zoom.transition,opacity:0}),this.TMR&&clearTimeout(this.TMR),this.TMR=setTimeout((function(){n.$view.css({transform:"translate3d(120%,0,0)",transition:"0s",zIndex:0})}),t.ANI.zoom.delay)}this.CURRENT_VIEW=e.name},toStart:function(){var t=this.arrHistory[0];for(var e in this.arrHistory){var i=this.arrViews[this.arrHistory[e]];this.parkView(i)}this.arrHistory=[],this.modalMessageShowed&&this.hideModalMessage(),this.modalConfirmShowed&&this.hideModalConfirm(),this.actionSheetShowed&&this.hideActionSheet(),this.setCurrent(t)},preventDoubleTap:function(){var t=this;if(this.DBLTAP)return console.log("prevent double tap"),!0;this.DBLTAP=!0,setTimeout((function(){t.DBLTAP=!1}),t.DBLTAP_DELAY)},parkView:function(t){t.$view.css({transform:"translate3d(120%,0,0)",transition:"0s",zIndex:0})},getAnimMethod:function(t){var e=t.anim;return e=void 0===e?"animLeft":e},showViewAnimation:function(t){var e=this,i=this.arrViews[t],n=this.getAnimMethod(i),s=10*this.arrHistory.length+100,o=this.getParent();i.$view.css({zIndex:s}),this.TMR&&clearTimeout(this.TMR),this.TMR=setTimeout((function(){switch(n){case"animLeft":i.$view.css({transform:"translate3d(100%,0,0)",transition:"0s"}),setTimeout((function(){i.$view.css({transform:"translate3d(0,0,0)",transition:e.ANI.left.transition}),o&&o.$view.css({transform:"translate3d(-50%,0,0)",transition:e.ANI.left.transition})}),100);break;case"zoomOut":i.$view.css({transform:"translate3d(0,0,0) scale(1.1)",transition:"0s",opacity:0}),setTimeout((function(){i.$view.css({transform:"translate3d(0,0,0) scale(1)",transition:e.ANI.zoom.transition,opacity:1})}),50)}}),this.PAUSE_BEFORE_ANIM_CURRENT)},getParent:function(){if(this.arrHistory.length>1){var t=this.arrHistory[this.arrHistory.length-2];return this.arrViews[t]}return!1},addMiddleLayer:function(){this.$middleLayer=$('<div class="middle-layer"></div>'),this.$allviews.append(this.$middleLayer)},modalMessage:function(e){t.VIEW_MODAL_MESSAGE.update(e),this.modalConfirmShowed&&this.hideModalConfirm(),this.actionSheetShowed&&this.hideActionSheet(),this.modalMessageShowed=!0,this.showModal("view-modal-message")},hideModalMessage:function(){this.hideModal("view-modal-message"),this.modalMessageShowed=!1},modalConfirm:function(e){t.VIEW_MODAL_CONFIRM.update(e),this.modalMessageShowed&&this.hideModalMessage(),this.actionSheetShowed&&this.hideActionSheet(),this.modalConfirmShowed=!0,this.showModal("view-modal-confirm")},hideModalConfirm:function(){this.hideModal("view-modal-confirm"),this.modalConfirmShowed=!1},hideModal:function(t){this.$middleLayer.hide();var e=this.arrViews[t];e.$view.css({transform:"translate3d(0,0,0) scale(1.1)",transition:this.ANI.modal.transition,opacity:0}),setTimeout((function(){e.$view.css({transform:"translate3d(120%,0,0)",transition:"0s"})}),this.ANI.modal.delay)},showModal:function(t){var e=this,i=this.arrViews[t];i.$view.css({transform:"translate3d(0,0,0) scale(1.1)",transition:"0s",opacity:0,zIndex:1100}),setTimeout((function(){i.$view.css({transform:"translate3d(0,0,0) scale(1)",opacity:1,transition:e.ANI.modal.transition})}),10)},actionSheet:function(e,i,n){this.modalConfirmShowed&&this.hideModalConfirm(),this.modalMessageShowed&&this.hideModalMessage(),this.actionSheetShowed=!0;var s=this.arrViews["view-action-sheet"];s.$view.css({transform:"translate3d(0,0,0)",transition:"0s",zIndex:1100}),s.$view.find(".action-sheet-menu").addClass("shown"),t.VIEW_ACTION_SHEET.update(e,i,n)},hideActionSheet:function(){this.actionSheetShowed=!1;var t=this.arrViews["view-action-sheet"];t.$view.find(".action-sheet-menu").removeClass("shown"),setTimeout((function(){t.$view.css({transform:"translate3d(120%,0,0)",transition:"0s"})}),this.ANI.modal.delay)}},c={_init:function(t){this.name=t.name,this.anim=t.anim,this.$view=$(t.template).clone(),this.$viewTitle=this.$view.find(".view-header-title"),this.$viewTitleText=this.$view.find(".view-header-title_text"),this.$viewTitleIcon=this.$view.find(".view-header-title_icon"),this.$page=this.$view.find(".app-view-page"),this.$pageContainer=this.$view.find(".app-view-page-container"),this.$footerBts=this.$view.find(".app-view-footer .button"),this.$footer=this.$view.find(".app-view-footer"),this.$form=this.$view.find(".std-form"),this.$inputs=this.$view.find("input, textarea"),this.$textareas=this.$view.find("textarea"),this.$btnMainHelp=this.$view.find(".view-header-buttons__button_help"),this.LOADING=!1,this.NEED_TO_SAVE=!1,this.AJAX=!1,this.VIEW_SCROLLED=!1,this._update_lng(),this._update_inputs_length(),$.fixIOSscroll(this.$pageContainer)},_behavior:function(){var e=this;$(window).on("touchstart",(function(){e.VIEW_SCROLLED=!1})).on("touchmove",(function(){e.VIEW_SCROLLED=!0})),this.$footerBts.on("touchstart",(function(){$(this).addClass("active")})),this.$footerBts.on("touchend",(function(){return $(this).removeClass("active"),!1})),this.$footer.on("touchend",(function(t){return t.preventDefault(),!1})),this.$inputs.on("contextmenu",(function(){console.log("input contextmenu")})),this.$textareas.on("keyup",(function(){e._textareas_update($(this))})),this.$btnMainHelp.on("touchend",(function(){return e._blur({onBlur:function(){e.LOADING||(t.VIEW_MAIN_HELP.update(),t.VIEWS.setCurrent(t.VIEW_MAIN_HELP.name))}}),!1}))},_textareas_update:function(t){var e="length-limit-reached",i=function(t){var i,n,s,o=t.attr("maxlength");i=t[0].value.match(/./g),n=t[0].value.match(/\n/g),(s=(i=i?i.length:0)+(n=n?n.length:0))==o||s>o?(t.removeClass(e),setTimeout((function(){t.addClass(e)}),10)):t.removeClass(e);var a=t.outerHeight(),_=Math.ceil(t[0].scrollHeight);a<_&&t.css({height:_+20})};t&&t.length?i(t):this.$textareas.each((function(){i($(this))}))},_blur:function(e){var i=this.$inputs.is(":focus");this.$inputs.blur(),t.DEVICE.is_android()&&i?setTimeout((function(){e&&e.onBlur&&e.onBlur()}),500):e&&e.onBlur&&e.onBlur()},_go_back:function(){t.VIEWS.goBack(),this._page_hide()},_update_lng:function(e){return(e=e||this.$view).find("[lang]").each((function(e){$(this).html(t.LNG.get($(this).attr("lang")))})),e},_page_to_top:function(){this.$pageContainer&&this.$pageContainer.scrollTop(0)},_page_hide:function(){this.$page&&this.$page.addClass("hidden")},_page_show:function(){this.$page&&this.$page.removeClass("hidden"),this._textareas_update()},_now_loading:function(){this.LOADING=!0,this.$view&&this.$view.addClass("now-loading")},_end_loading:function(){this.LOADING=!1,this.$view&&this.$view.removeClass("now-loading")},_reset:function(){this.$inputs.val(""),this.$inputs.css({height:"auto"})},_update:function(){console.log("update: "+this.name)},_update_inputs_length:function(){this.$inputs.length&&this.$inputs.each((function(){var e=$(this).attr("name");if("file"!==$(this).attr("type")){var i=t.INPUTS_LENGTH.get(e);$(this).attr({maxlength:i})}}))},_update_title:function(t){this.$viewTitleText&&this.$viewTitleText.html(t)},_need2save:function(t){this.NEED_TO_SAVE=t,t?this.$view&&this.$view.addClass("need-to-save"):this.$view&&this.$view.removeClass("need-to-save")},_update_tabindex:function(){t.TABINDEX.clear(),this.$view.find("input, textarea").each((function(t){$(this).attr("tabindex",t)}))},_update_app:function(e){var i=this;t.VIEWS.modalMessage({title:t.LNG.get("lng_update"),message:"Панель Управления обновилась до версии <nobr>"+e+".</nobr> Нажмите Ок, чтобы ее перезапустить",btn_title:t.LNG.get("lng_ok"),on_close:function(){i._now_loading(),location.reload()}})},_update_app_as_status_changed:function(e){var i=this,n="";switch(e=parseInt(e,10)){case 1:n=["<p>Статуc вашего Меню изменился на <nobr>«В архиве»</nobr>.</p>","<p>Возможная причина – закончился годовой Контракт.</p>"].join(" ");break;case 2:n=["<p>Статуc вашего Меню изменился на <nobr>«Договор»</nobr>.</p>","<p>Вам открыты все возможности Сервиса.</p>"].join(" ");break;default:n="<p>Статуc вашего Меню изменился на <nobr>«Тестовый период»</nobr>.</p>"}t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:[n,"<p>Нажмите Ок, чтобы перезапустить Панель Управления</p>"].join(" "),btn_title:t.LNG.get("lng_ok"),on_close:function(){i._now_loading(),location.reload()}})},_reload_by_err:function(){var e=this;t.VIEWS.modalMessage({title:t.LNG.get("lng_update"),message:"Обновились настройки сервиса. Нажмите Ок для перезагрузки программы.",btn_title:t.LNG.get("lng_ok"),on_close:function(){e._now_loading(),location.reload()}})}},d={init:function(t){return this._init(t),this.CURRENT_CAFE="",this.ID_USER="",this.$btnMenuHomeUrl=this.$view.find(".view-header-buttons__button_home"),this.$btnMainSite=this.$view.find(".view-header-title_icon"),this.$btnAdd=this.$view.find(".add"),this.$btnSave=this.$view.find(".save"),this.$btnCustomize=this.$view.find(".customize"),this.$btnIikoReload=this.$view.find(".app-view-integration-btn"),this.$btnAdd.hide(),this._need2save(!1),this.behavior(),console.log(this),this},now_loading:function(){this._now_loading(),this.MENU_LIST&&this.MENU_LIST.stopBehaviors()},end_loading:function(){this._end_loading(),this.MENU_LIST&&this.MENU_LIST.startBehaviors()},behavior:function(){var e=this;this._behavior(),this.$btnCustomize.on("touchend",(function(){return e._blur({onBlur:function(){e.LOADING||(t.VIEW_CUSTOMIZE_ALL.update(),t.VIEWS.setCurrent(t.VIEW_CUSTOMIZE_ALL.name))}}),!1})),this.$btnMenuHomeUrl.on("touchend",(function(){var e=t.THE_CAFE.get().uniq_name.toLowerCase();return window.open("/cafe/"+e,"_blank"),!1})),this.$btnMainSite.on("touchend",(function(){location.href=CFG.http+CFG.www_url})),this.$btnAdd.on("touchend",(function(){return e.LOADING||(e.MENU_LIST&&e.MENU_LIST.closeAll(),e.save_before((function(){setTimeout((function(){e.end_loading()}),100),e.check_limit_sections({onReady:function(){e.edit_menu(!1)}})}))),!1})),this.$btnSave.on("touchend",(function(){return!e.LOADING&&e.NEED_TO_SAVE&&e.save(),!1})),this.$btnIikoReload.on("touchstart",(function(){$(this).addClass("active")})),this.$btnIikoReload.on("touchend",(function(){return $(this).removeClass("active"),!1})),this.$btnIikoReload.on("touchend",(()=>(this.LOADING?console.log("try later, please"):this.reload_iiko_menu(),!1)))},reload_iiko_menu:function(){const e=this,i=t.THE_CAFE.get(),n={reload_iiko_menu:()=>{e.now_loading(),e._page_hide();let s=i.iiko_extmenus;s=!!s&&JSON.parse(s),s||(this.error_message(),setTimeout((()=>{this.end_loading(),this._page_show()}),200));const o=s.current_extmenu_id;t.IIKO_LOADER.init().load_extmenu_asynq(o).then((e=>{const[i,s,o]=e;if(!i||!s)return this.error_message(),setTimeout((()=>{this.end_loading(),this._page_show()}),200),!1;if(console.log("roughMenu",i),i&&s&&o){const e=t.IIKO_EXT_MENU_PARSER.parse(i);console.log("newMenu",e),n.update_iiko_menu(e,s)}else{let e="У вас сейчас актуальное меню. \n\t\t\t\t\t\t\tОбновлять не требуется.";t.VIEWS.modalMessage({title:t.LNG.get("lng_ok"),message:e,btn_title:t.LNG.get("lng_close"),on_close:function(){}}),setTimeout((()=>{this.end_loading(),this._page_show()}),200)}})).catch((t=>{this.error_message(),setTimeout((()=>{this.end_loading(),this._page_show()}),200),console.log("err load iiko ext menu",t)}))},update_iiko_menu:(n,s)=>{const o={id_cafe:i.id,newMenu:n,roughMenuHash:s,onReady:function(){console.log("Menu was updated!"),setTimeout((()=>{e.update(e.ID_USER)}),300)},onError:function(t){console.log("errMsg",t);e.error_message("<p>Не удалось обновить существующее меню, \n\t\t\t\t\t\tпопробуйте позже или обратитесь к разработчику</p>"),e.end_loading(),e._page_show()}};t.IIKO_UPDATER.init(o)}};t.VIEWS.modalConfirm({title:t.LNG.get("lng_attention"),ask:"<p>Меню из iiko заменит текущее меню в ChefsMenu. \n\t\t\tПри этом, поля, заполненные вами здесь, \n\t\t\tсохранятся в новом меню.</p>",action:function(){n.reload_iiko_menu()},cancel:function(){console.log("cancel reloading")},buttons:[t.LNG.get("lng_ok"),t.LNG.get("lng_cancel")]})},update_iiko_mode:function(){t.THE_CAFE.is_iiko_mode()?($("body").addClass("iiko-mode"),$("body").removeClass("chefsmenu-mode")):($("body").addClass("chefsmenu-mode"),$("body").removeClass("iiko-mode"))},update:function(e){var i=this;this._update(),this.ID_USER=e;if(!e)return function(){var t=["<p>Неизвестный пользователь.</p>","<p>Зайдите позже или обратитесь к администратору</p>"].join(" ");i.error_message(t)}(),void setTimeout((function(){location.href="/"}),1500);this._page_hide(),this.now_loading(),t.THE_CAFE.load({onReady:function(e){i.CAFE=e,i.ID_CAFE=e.id,i._update_title(e.cafe_title),i.update_iiko_mode(),i.load_menu_by_cafe(e.id,{onReady:function(e){t.MENU.update(e),i._need2save(!1),i.build({onReady:function(){}})}})}})},load_menu_by_cafe:function(t,e){var i=this;console.log("LOAD_MENU_BY_CAFE"),this.AJAX=$.ajax({url:"adm/lib/lib.get_all_menu.php?callback=?",dataType:"jsonp",method:"POST",data:{id_cafe:t},success:function(t){t["cafe-rev"];var i=t["all-menu"];e.onReady&&e.onReady(i)},error:function(t){i.error_message("Не удалось загрузить Меню. Попробуйте позже или обратитесь к администратору"),console.log("err load all menu",t)}})},build:function(e){var i=this;!t.THE_CAFE.is_iiko_mode()&&this.$btnAdd.show();var n=function(t,e){e.startRemove(t,{onReady:function(){i.save_before((function(){setTimeout((function(){i.delete_menu(t,{onSuccess:function(t){e.endRemove(t),setTimeout((function(){i.end_loading()}),1e3)},onError:function(t){e.cancelRemoving(t),i.error_message("Не удалось удалить Меню. Попробуйте позже или обратитесь к администратору"),i.end_loading()}})}),600)}),"leaveLoader")}})},s={left:[{title:"Delete",btnClass:"btn-delete",btnAction:function(e,s){i.get().length<2?(t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:t.LNG.get("lng_min_menu"),btn_title:t.LNG.get("lng_close")}),s.cancelRemoving(e)):t.VIEWS.modalConfirm({title:t.LNG.get("lng_attention"),ask:"Вы уверены, что хотите удалить раздел со всеми блюдами?",action:function(){n(e,s)},cancel:function(){console.log("cancel deleting"),i.MENU_LIST&&i.MENU_LIST.closeAll()},buttons:[t.LNG.get("lng_delete"),t.LNG.get("lng_cancel")]})}}],right:[{title:"Edit",btnClass:"btn-edit",btnAction:function(t,e){i.MENU_LIST&&i.MENU_LIST.closeAll(),setTimeout((function(){i.save_before((function(){setTimeout((function(){i.end_loading()}),100),i.edit_menu(t)}))}),300)}}]};this._page_hide(),this.MENU_LIST=$.repos51({$parent:i.$view.find(".app-view-page-container"),ALLROWS:t.MENU.get(),BUTTONS:s,onTouchend:function(e){console.log("SAVE_BEFORE"),i.save_before((function(){t.VIEW_ALL_ITEMS.update(e),t.VIEWS.setCurrent(t.VIEW_ALL_ITEMS.name),i.end_loading()}))},need2save:function(t){i._need2save(t)},getRowIcon:function(e){return t.MENU_ICONS.get(e)},onReady:function(){i._page_show()}}),setTimeout((function(){e.onReady&&e.onReady(),i.end_loading()}),300)},get:function(e){return e?t.MENU.get_by_id(e):t.MENU.get()},get_index_by_id:function(e){return t.MENU.get_index_by_id(e)},save_before:function(t){this.NEED_TO_SAVE?this.save(t):t&&t()},save:function(e,i){var n=this;if(n.NEED_TO_SAVE){this.now_loading();var s={id_cafe:this.ID_CAFE,arrpos:t.MENU.get_arr_id()};this.AJAX=$.ajax({url:"adm/lib/lib.save_menu_pos.php?callback=?",dataType:"jsonp",method:"POST",data:s,success:function(t){console.log("response=",t),!i&&setTimeout((function(){n.end_loading()}),100),t.error?(n.end_loading(),console.log(t)):(n._need2save(!1),e&&e())},error:function(t){n.end_loading(),console.log(t)}})}else e&&e()},edit_menu:function(e){var i=this,n=t.THE_CAFE.get().id,s=!!(e=e)&&i.get(e);console.log("edit menu ",s),s?t.VIEW_EDIT_MENU.update({id_cafe:n,menu:s,onReady:function(e){var n=i.get_index_by_id(e.id);n<0?console.log("unknown id menu"):(t.MENU.get()[n]=e,i._page_hide(),i.update_menu_list(e))}}):t.VIEW_EDIT_MENU.update({id_cafe:n,menu:s,onReady:function(e){t.MENU.add(e),i.add_to_menu_list(e)}}),t.VIEWS.setCurrent(t.VIEW_EDIT_MENU.name)},check_limit_sections:function(e){var i=t.THE_CAFE.get(),n=2!==parseInt(i.cafe_status,10)?CFG.limits.test:CFG.limits.full,s=this.get().length<n.total_sections,o="";o=2!==i.cafe_status?t.LNG.get("lng_limits_total_section__test"):t.LNG.get("lng_limits_total_section__full"),s&&e&&e.onReady?e.onReady():t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:o,btn_title:t.LNG.get("lng_close")})},update_menu_list:function(t){var e=this;if(!this.MENU_LIST)return console.log("cant update menu list"),!1;this.MENU_LIST.updateMenu(t),setTimeout((function(){e._page_show(),e.end_loading()}),100)},add_to_menu_list:function(t){var e=this;if(!this.MENU_LIST)return console.log("cant update menu list"),!1;this.MENU_LIST.addMenu(t),setTimeout((function(){e._page_show(),e.end_loading()}),100)},delete_menu:function(t,e){var i=this,n={id_menu:t=t};this.now_loading(),this.AJAX=$.ajax({url:"adm/lib/lib.remove_menu.php?callback=?",dataType:"jsonp",data:n,method:"POST",success:function(i){i.error?(e.onError&&e.onError(t),console.log("err:",i)):(i["cafe-rev"],i.message,e.onSuccess&&e.onSuccess(t))},error:function(n){i.end_loading(),e.onError&&e.onError(t),console.log("err",n)}})},error_message:function(e){e=e||"<p>Что-то пошло не так. Попробуйте позже или обратитесь к Администратору Сервиса</p>";t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:e,btn_title:t.LNG.get("lng_close"),on_close:function(){}})}},u={init:function(t){return this._init(t),this.$tpl_item=$(t.template_item),this.$itemsWrapper=this.$view.find(".all-items-wrapper"),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$btnAdd=this.$footer.find(".add"),this.$btnSave=this.$footer.find(".save"),this.ID_MENU=0,this.CURRENT_MENU={},this.NEED_POS_TO_SAVE=!1,this.behavior(),this},behavior:function(){var t=this;this._behavior();var e=function(){t._blur({onBlur:function(){t.LOADING||(t.NEED_TO_SAVE||t.NEED_POS_TO_SAVE?(t.AJAX&&t.AJAX.abort(),t.PAGES&&t.PAGES.stopLoadingImages(),t.save({onReady:function(){t.PAGELIST&&t.PAGELIST.hide(150,"del tail"),setTimeout((function(){t._go_back()}),150)}})):(t.PAGELIST&&t.PAGELIST.hide(150,"del tail"),setTimeout((function(){t._go_back()}),150)))}})};this.$viewTitle.on("touchend",(function(){return e(),!1})),this.$btnBack.on("touchend",(function(){return e(),!1})),this.$btnSave.on("touchend",(function(){return t._blur({onBlur:function(){!t.LOADING&&t.save({})}}),!1})),this.$btnAdd.on("touchend",(function(){return t._blur({onBlur:function(){t.LOADING||t.NEED_TO_SAVE||t.check_limit_items_in_section({onReady:function(){t.item_add()}})}}),!1}))},update:function(e,i){var n=this;this._update(),this.ID_MENU=e.id,t.THE_CAFE.is_iiko_mode()&&this.$btnAdd.hide(),this.reset(),this.$itemsWrapper.html(""),this._now_loading(),this._update_title(e.title);var s=t.MENU_ICONS.get(e.id_icon);this.$viewTitleIcon.addClass(s.className),this.CURRENT_MENU=e,n._page_show(),this.load_items_by_menu(e.id,{onReady:function(s){t.ITEMS.update(e.id,s),console.log("====items====",s),setTimeout((function(){n.build_html(i)}),300)}})},reset:function(){this.NEED_TO_SAVE=!1,this.NEED_POS_TO_SAVE=!1,this.$view.removeClass("need-to-save"),this.set_is_empty(!1)},set_is_empty:function(t){t?this.$view.addClass("all-items-is-empty"):this.$view.removeClass("all-items-is-empty")},build_html:function(e){var i=this,n=t.ITEMS.get(this.CURRENT_MENU.id),s=!(!e||!e.move2end),o=this._update_lng(i.$tpl_item.clone()),a=t.THE_CAFE.is_iiko_mode();this.PAGES=$.menuItems({arr:n,tpl:o,need2Save:function(t){i._need2save(t)},need2SavePos:function(){i.need_pos_to_save()},saveItem:function(t){},saveItemsPos:function(){},itemEdit:function(t){i.item_edit(t)},itemImageEdit:function(t){i.item_image_edit(t)},itemDelete:function(t){i.delete_item_confirm(t)},itemReplace:function(t){i.item_replace(t)},currency:"RUB",pricePrecision:t.THE_CAFE.get().price_precision,currencySign:t.CURRENCY.get_current(),managedByIiko:a}),this.PAGELIST=$.superPageList2({$parent:this.$itemsWrapper,Pages:this.PAGES,ALLITEMS:n,move2end:s,pauseBeforeShow:"500",on_resize:function(){t.VIEWS.getCurrentName()==i.name&&(console.log("ON_RESIZE"),i.build_html())}}),setTimeout((function(){!n.length&&i.set_is_empty(!0),i._end_loading()}),500)},item_replace:function(t){this.PAGELIST&&("next"==t?this.PAGELIST.change_pos_next():this.PAGELIST.change_pos_prev())},need_pos_to_save:function(){this.NEED_POS_TO_SAVE=!0,this.$view.addClass("need-to-save")},item_image_edit:function(e){var i=this;setTimeout((function(){i.PAGELIST&&i.PAGELIST.reset()}),200),t.VIEW_ITEM_IMAGE_CHANGE.update({item:e,onReady:function(t){e.image_name=t.image_name,e.image_url=t.image_url,i.PAGES&&i.PAGES.updateImageForCurrent()}}),t.VIEWS.setCurrent(t.VIEW_ITEM_IMAGE_CHANGE.name)},item_add:function(){var e=this,i=t.ITEMS.get(this.CURRENT_MENU.id);this.PAGELIST&&this.PAGELIST.reset();var n={menu:this.CURRENT_MENU,item:!1,pos:i.length,doAfterSave:function(t){i.push(t),e.reset(),e.set_is_empty(!1),e.PAGES&&e.PAGES.updateAfterAdd((function(){e.PAGELIST&&e.PAGELIST.updateAfterAdd((function(){e._end_loading()}))}))}};setTimeout((function(){t.VIEW_EDIT_ITEM.update(n),t.VIEWS.setCurrent(t.VIEW_EDIT_ITEM.name)}),300)},item_edit:function(e){var i=this,n=this.CURRENT_MENU.id;t.ITEMS.get(n);var s={menu:this.CURRENT_MENU,item:e,pos:e.pos,doAfterSave:function(e){var s=t.ITEMS.replace_item(n,e);i.PAGES&&i.PAGES.updateItem(s)}};this.save({onReady:function(){t.VIEW_EDIT_ITEM.update(s),t.VIEWS.setCurrent(t.VIEW_EDIT_ITEM.name)}})},delete_item_from_db:function(e){var i=this;this.ID_USER;var n=e.id,s=this.get();if(!s.length)return!1;for(var o=-1,a=0;a<s.length;a++)if(s[a].id==n){o=a;break}if(-1==o)return console.log("unknown index to delete"),this._end_loading(),!1;this._now_loading(),this.PAGELIST&&this.PAGELIST.lock_behaviors(!0);var _=o==s.length-1,r={update_all_pos_before_deleting:function(t){i.save_items_pos({onReady:function(){r.removeItemFromDB(t)}},"noEndLoading")},removeItemFromDB:function(e){i.reset(),i.AJAX=$.ajax({url:"adm/lib/lib.remove_item.php?callback=?",dataType:"jsonp",data:{id_item:n},method:"POST",success:function(e){e.error?(this.PAGELIST&&this.PAGELIST.lock_behaviors(!1),i._end_loading(),t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"Не удалось удалить позицию",btn_title:t.LNG.get("lng_ok")}),console.log("err:",e.error)):i.PAGELIST&&i.PAGELIST.removeCurrentPage({onReady:function(){i._end_loading(),!i.get().length&&i.set_is_empty(!0)}})},error:function(e){i._end_loading(),t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"Не удалось удалить позицию",btn_title:t.LNG.get("lng_ok")}),console.log("err save menu info",e)}})}};s.length>1&&!_?(s.splice(o,1),r.update_all_pos_before_deleting(o)):(s.splice(o,1),r.removeItemFromDB(o))},delete_item_confirm:function(e){var i=this;i.PAGELIST&&i.PAGELIST.reset();var n=t.LNG.get("lng_confirm_delete"),s=t.LNG.get("lng_delete"),o=t.LNG.get("lng_cancel");setTimeout((function(){t.VIEWS.modalConfirm({title:e.title,ask:n,action:function(){i.delete_item_from_db(e)},buttons:[s,o]})}),300)},save:function(t){var e=this,i=function(){e.NEED_TO_SAVE?e.save_item_flags(e.NEED_TO_SAVE,t):e.NEED_POS_TO_SAVE?e.save_items_pos(t):t.onReady&&t.onReady()};!e.LOADING&&e.PAGELIST&&e.PAGELIST.reset({onReady:function(){i()}})},save_items_pos:function(t,e){var i=this;this._now_loading();for(var n=[],s=this.get(),o=0;o<s.length;o++)n.push(s[o].id),s[o].pos=o;var a={id_menu:this.ID_MENU,arrpos:n};this.AJAX=$.ajax({url:"adm/lib/lib.save_items_pos.php?callback=?",dataType:"jsonp",data:a,method:"POST",success:function(n){i.reset(),n.error?(i._end_loading(),console.log("err:",n.error)):(n["cafe-rev"],n.arr_items,setTimeout((function(){!e&&i._end_loading(),t.onReady&&t.onReady()}),300))},error:function(t){i._end_loading(),console.log("err save menu info",t)}})},save_item_flags:function(t,e){var i=this;if(this.LOADING)return!1;this._now_loading();var n={flag_spicy:t.mode_spicy,flag_hit:t.mode_hit,flag_vege:t.mode_vege};t?function(e){i.AJAX=$.ajax({url:"adm/lib/lib.save_item_flags.php?callback=?",dataType:"jsonp",data:{id_item:t.id,itemFlags:n},method:"POST",success:function(t){setTimeout((function(){i._end_loading(),t.error?console.log("err:",t.error):(t["cafe-rev"],t.message,e.onReady&&e.onReady())}),1e3)},error:function(t){i._end_loading(),console.log("err save flags",t)}})}({onReady:function(){i.NEED_POS_TO_SAVE?i.save_items_pos(e):(i.reset(),setTimeout((function(){i._end_loading(),e.onReady&&e.onReady()}),300))}}):setTimeout((function(){i.reset(),i._end_loading()}),300)},get:function(){return t.ITEMS.get(this.CURRENT_MENU.id)},load_items_by_menu:function(t,e){var i=this,n={id_menu:t};this.AJAX=$.ajax({url:"adm/lib/lib.get_all_items.php?callback=?",dataType:"jsonp",data:n,method:"POST",success:function(t){if(t.error)i._end_loading(),console.log("err:",t.error);else{var n=t["app-version"],s=t["all-items"];if(CFG.app_version!==n)return i._update_app(n),!1;e&&e.onReady&&e.onReady(s)}},error:function(t){return i._reload_by_err(),console.log("err load items",t),!1}})},check_limit_items_in_section:function(e){var i=t.THE_CAFE.get(),n=2!==parseInt(i.cafe_status,10)?CFG.limits.test:CFG.limits.full,s=this.get().length<n.items_in_section,o="";o=2!==parseInt(i.cafe_status,10)?t.LNG.get("lng_limits_items_in_section__test"):t.LNG.get("lng_limits_items_in_section__full"),s?e.onReady&&e.onReady():t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:o,btn_title:t.LNG.get("lng_close")})}},g={init:function(t,e,i){return this.$view=t,this.$parent=e,this.cafe=i,this.EXTRA_LANGS=this.cafe.extra_langs?JSON.parse(this.cafe.extra_langs):{},this.build(),this},build:function(){if(this.$parent.find(".lang-tabs").remove(),Object.keys(this.EXTRA_LANGS).length>0){let t=$("<ul></ul>").addClass("lang-tabs");this.EXTRA_LANGS=$.extend({ru:"Русский"},this.EXTRA_LANGS);for(let e in this.EXTRA_LANGS){this.EXTRA_LANGS[e];let i=$(`<li data-lang-code="${e}" class="${"ru"==e?"current":""}">${e}</li>`);i.on("touchend",(t=>{this.$view._blur({onBlur:()=>{this.$view.LOADING||this.$view.VIEW_SCROLLED||i.hasClass("current")||(i.addClass("current"),i.siblings().removeClass("current"),this._set_current(i.data("lang-code")))}}),t.originalEvent.cancelable&&t.preventDefault()})),t.append(i)}this.$parent.append(t)}else this.EXTRA_LANGS={ru:"Русский"}},get_langs:function(){return this.EXTRA_LANGS},_set_current:function(t){$(this).trigger("change",t)}},m={init:function(t){return this._init(t),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$btnSave=this.$view.find(".save"),this.$langsSections=this.$view.find(".menu-inputs-extra-langs"),this.MENU_ICON_ID=0,this.$icons=this.build_icons(),this.reset(),this.behavior(),this},build_icons:function(){for(var e=t.MENU_ICONS.get_total(),i=this.$view.find(".add-menu-icons"),n=0;n<e;n++){var s=t.MENU_ICONS.get(n),o=$("<div></div>",{"data-title":s.title}).html($("<span></span>",{class:s.className}));n==this.MENU_ICON_ID&&o.addClass("checked"),i.append(o)}return i.find("div")},change_current_lang:function(t){this.CURR_LANG_TO_EDIT=t,this.$view.find(".extra-lang-section").hide().filter(`div[data-extra-lang-code=${t}]`).show()},set_data:function(t,e,i){this.$view.find(`div[data-extra-lang-code=${i}]`).find(`.${t}`).val(e)},get_data:function(e,i){let n=this.$view.find(`div[data-extra-lang-code=${i}]`).find(`.${e}`).val();return n=$.clear_user_input(n,t.INPUTS_LENGTH.get(e)),n},colllect_all_inputs:function(){const t={},e=this.LTABS.get_langs();for(let i in e)e.hasOwnProperty(i)&&(t[i]=this.get_user_inputs(i));return t},inputs_has_empty_values:function(t){return!t.title},get_user_inputs:function(t){return{title:this.get_data("menu-title",t)}},update:function(e){this._update(),this._update_tabindex(),this.ID_CAFE=e.id_cafe,this.MENU=e.menu,this.ID_MENU=this.MENU?this.MENU.id:null,this.MENU_ICON_ID=this.MENU?this.MENU.id_icon:0,this.LTABS=$.extend({},g).init(this,this.$page,t.THE_CAFE.get()),$(this.LTABS).on("change",((t,e)=>{this.change_current_lang(e)})),this.rebuild_data_sections(),this.update_title_icon(),this.reset(),this.DO_AFTER_SAVE=e.onReady||function(){};const i=t.LNG.get("lng_view_edit_menu__edit"),n=t.LNG.get("lng_view_edit_menu__add"),s=this.MENU?i:n;if(this._update_title(s),this.MENU){this.set_data("menu-title",this.MENU.title,"ru");const t=this.LTABS.get_langs(),e=this.MENU.extra_data?JSON.parse(this.MENU.extra_data,1):[];for(let i in t)t.hasOwnProperty(i)&&"ru"!==i&&e[i]&&e[i].title&&this.set_data("menu-title",e[i].title,i)}this.$icons.removeClass("checked"),this.$icons.eq(this.MENU_ICON_ID).addClass("checked"),this._now_loading(),this.get_app_version({onReady:()=>{this._page_show(),setTimeout((()=>{this._end_loading()}),300)}})},rebuild_data_sections:function(){this.$langsSections.html("");const t=t=>{let e=$('<div class="extra-lang-section">\n\t\t\t\t\t<input class="std-form__input menu-title" type="text" name="menu-title" maxlength="555"></div>');e.attr({"data-extra-lang-code":t}).hide(),this.CURR_LANG_TO_EDIT==t&&e.show(),this.$langsSections.append(e)},e=this.LTABS.get_langs();for(let i in e)t(i);this.$langsSections.find("input, textarea").on("keyup",(t=>{this._need2save(!0)}))},get_app_version:function(t){var e=this;this.AJAX=$.ajax({url:"adm/lib/lib.get_app_version.php?callback=?",dataType:"jsonp",data:{},method:"POST",success:function(i){if(i.error)e.error_message("Ошибка подключения. Попробуйте зайти позже."),e._end_loading();else{var n=i["app-version"];if(CFG.app_version!==n)return void e._update_app(n);t&&t.onReady&&t.onReady()}},error:function(t){e.error_message("Ошибка подключения. Попробуйте зайти позже."),e._end_loading()}})},update_title_icon:function(){var e=t.MENU_ICONS.get(this.MENU_ICON_ID),i=t.MENU_ICONS.get();for(var n in i)i.hasOwnProperty(n)&&this.$viewTitleIcon.removeClass(i[n].className);this.$viewTitleIcon.addClass(e.className)},behavior:function(){var t=this;this._behavior(),this.$btnBack.on("touchend",(t=>(this._blur({onBlur:()=>{!this.LOADING&&this._go_back()}}),!1))),this.$btnSave.on("touchend",(t=>(this._blur({onBlur:()=>{!this.LOADING&&this.save()}}),!1))),this.$icons.each((function(e){$(this).on("touchend",(function(i){$(this).hasClass("checked")||t.VIEW_SCROLLED||(t.MENU_ICON_ID=e,t.update_title_icon(),$(this).siblings().removeClass("checked"),$(this).addClass("checked"),t._need2save(!0)),i.originalEvent.cancelable&&i.preventDefault(),i.stopPropagation()}))}))},reset:function(){this._reset(),this._page_to_top(),this._page_hide(),this._need2save(!1),this.change_current_lang("ru"),this.$form.find("input,textarea").val("")},save:function(){var e=this.ID_CAFE,i=this.ID_MENU||"",n=this.MENU_ICON_ID;this.NEED_TO_SAVE||this.LOADING||this._go_back();const s=this.get_data("menu-title","ru");if(!s)return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:t.LNG.get("lng_required_field"),btn_title:t.LNG.get("lng_close")}),void this._end_loading();if(s.length<2)return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"Минимальная длина <nobr>названия –</nobr> две буквы",btn_title:t.LNG.get("lng_close")}),void this._end_loading();const o=this.colllect_all_inputs();let a=0;const _=this.LTABS.get_langs();if(Object.keys(_).length>1)for(let t in _)this.inputs_has_empty_values(o[t])&&a++;const r={id_cafe:e,id_icon:n,id_menu:i,all_inputs:o},l="<p>Невозможно добавить/сохраниеть раздел.</p>\n        \t\t\t\t<p>Попробуйте позже или обратитесь в поддержку.</p>",h=()=>{this._now_loading(),this.save_async(r).then((t=>{if(console.log(t),t.error)this._end_loading(),t.error&&"string"==typeof t.error&&-1!==t.error.indexOf("total_sections")?this.error_message("<p>Количество разделов в меню достигло лимита.</p><p>Откройте «Помощь», \n        \t\t\t\tчтобы ознакомиться со всеми возможностями и ограничениями сервиса.</p>"):this.error_message(l);else{t["cafe-rev"];const e=t.menu;this.DO_AFTER_SAVE&&this.DO_AFTER_SAVE(e),this._end_loading(),setTimeout((()=>{this._go_back()}),300)}})).catch((t=>{console.log(t),this.error_message(l),this._end_loading()}))};a?(console.log("some extra fields is empty"),t.VIEWS.modalConfirm({title:"Внимание!",ask:"Некоторые переводы не заполнены. Все равно сохранить?",action:t=>{t&&h()},buttons:["Да","Нет"]})):h()},save_async:function(t){return new Promise(((e,i)=>{this.AJAX=$.ajax({url:"adm/lib/lib.save_menu.php?callback=?",dataType:"jsonp",data:t,method:"POST",success:function(t){e(t)},error:function(t){i(t)}})}))},error_message:function(e){t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:e,btn_title:t.LNG.get("lng_close")})}},f={init:function(t){return this._init(t),this.$itemsWrapper=this.$view.find(".all-items-wrapper"),this.$btnSave=this.$view.find(".save"),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$sectionChooseMenu=this.$view.find(".edit-item-choose-section"),this.$btnChangeSection=this.$view.find(".edit-item-choose-section__button"),this.$item_iiko_modifiers=this.$form.find(".iiko-modifiers"),this.$item_iiko_modifiers_title=this.$form.find(".iiko-modifiers-title"),this.$item_iiko_volume_title=this.$form.find(".item-volume-title__iiko"),this.$item_iiko_volume=this.$form.find(".item-volume__iiko"),this.$item_iiko_price_title=this.$form.find(".item-price-title__iiko"),this.$item_iiko_price=this.$form.find(".item-price__iiko"),this.$item_chefsmenu_volume=this.$form.find(".item-volume"),this.$item_chefsmenu_price=this.$form.find(".item-price"),this.$item_edits_container=this.$form.find(".item-edits-container"),this.$tpl_item_edit_form=$("#templates .tpl-item-edit-form"),this.CURR_LANG_TO_EDIT="ru",this.reset(),this.behavior(),this},reset:function(){this._reset(),this.need2save(!1),this._page_to_top(),this.change_current_lang("ru"),this.$btnChangeSection.html("")},update:function(e){this._update(),this._update_tabindex(),this._page_hide(),this.CURRENT_MENU=e.menu,this.ITEM=e.item,this.POS_ORDER=e.pos,this.DO_AFTER_SAVE=e.doAfterSave,this.reset(),this.LTABS=$.extend({},g).init(this,this.$page,t.THE_CAFE.get()),$(this.LTABS).on("change",((t,e)=>{this.change_current_lang(e)})),this.rebuild_data_sections();const i=t.THE_CAFE.is_iiko_mode()?"iiko-mode-only":"chefsmenu-mode-only";if(this.$view.addClass(i),this.ITEM){this.ACTION_MODE="edit",this._update_title(t.LNG.get("lng_item_edit")),this.$sectionChooseMenu.show(),this.id_item=this.ITEM.id,this.set_data("item-title",this.ITEM.title,"ru"),this.set_data("item-description",this.ITEM.description,"ru");const e=this.LTABS.get_langs(),i=this.ITEM.extra_data?JSON.parse(this.ITEM.extra_data,1):[];for(let t in e)e.hasOwnProperty(t)&&"ru"!==t&&i[t]&&(i[t].title&&this.set_data("item-title",i[t].title,t),i[t].description&&this.set_data("item-description",i[t].description,t));if(t.THE_CAFE.is_iiko_mode()){var n=[];if(""!==this.ITEM.iiko_modifiers){var s=JSON.parse(this.ITEM.iiko_modifiers);if(s.length>0){for(var o in s){var a=s[o].name,_=s[o].items;if(_.length>0){var r=[];for(var l in _)r.push(_[l].name);var h='<div class="std-form__ul_tags_title">– '+a+"</div>"+('<ul class="std-form__ui_tags"><li>'+r.join("</li><li>")+"</li></ul>");n.push(h)}}this.$item_iiko_modifiers.html(n.join("")),this.$item_iiko_modifiers_title.show()}else this.$item_iiko_modifiers.html("").hide(),this.$item_iiko_modifiers_title.hide()}else this.$item_iiko_modifiers.html("").hide(),this.$item_iiko_modifiers_title.hide();var c="Стоимость("+t.CURRENCY.get_current()+"):";this.$item_iiko_price_title.html(c);var d=[],u=this.ITEM.iiko_sizes?JSON.parse(this.ITEM.iiko_sizes):[];for(var m in u)d.push(u[m].price);this.$item_iiko_price.val(d.join(" / ")).attr({disabled:!0});var f=this.ITEM.iiko_measure_unit;this.$item_iiko_volume_title.html("Вес ("+f+"):");var p=[];for(var m in u){var v={sizeCode:u[m].sizeCode,sizeName:u[m].sizeName,weight:u[m].portionWeightGrams};p.push(v.sizeName+" "+v.weight+"г")}this.$item_iiko_volume.val(p.join(" / ")).attr({disabled:!0})}else this.$item_chefsmenu_volume.val(this.ITEM.volume),this.$item_chefsmenu_price.val(this.ITEM.price);this.$btnChangeSection.html(this.CURRENT_MENU.title)}else this.ACTION_MODE="add",this._update_title(t.LNG.get("lng_item_add")),this.$sectionChooseMenu.hide();setTimeout((()=>{this._page_show()}),350)},rebuild_data_sections:function(){this.$item_edits_container.html("");const t=t=>{let e=this.$tpl_item_edit_form.clone().hide();e.attr({"data-extra-lang-code":t}),this.CURR_LANG_TO_EDIT==t&&e.show(),this.$item_edits_container.append(e)},e=this.LTABS.get_langs();for(let i in e)t(i);this.$item_edits_container.find("input, textarea").on("keyup",(t=>{this.need2save(!0)}))},change_current_lang:function(t){this.CURR_LANG_TO_EDIT=t,this.$view.find(".extra-lang-section").hide().filter(`div[data-extra-lang-code=${t}]`).show()},set_data:function(t,e,i){this.$view.find(`div[data-extra-lang-code=${i}]`).find(`.${t}`).val(e)},get_data:function(e,i){let n=this.$view.find(`div[data-extra-lang-code=${i}]`).find(`.${e}`).val();return n=$.clear_user_input(n,t.INPUTS_LENGTH.get(e)),n},price_to_number:function(e){t.THE_CAFE.get();e=e.replace(/\,/g,".");return isNaN(e)?0:parseInt(e,10)},behavior:function(){this._behavior(),this.$btnSave.on("touchend",(()=>(this._blur({onBlur:()=>{!this.LOADING&&this.save({onReady:()=>{this._go_back()}})}}),!1))),this.$btnBack.on("touchend",(()=>(this._blur({onBlur:()=>{!this.LOADING&&this._go_back()}}),!1)));var e=()=>{t.VIEW_REPLACING_PARENT_SECTION.update(this.ITEM),t.VIEWS.setCurrent(t.VIEW_REPLACING_PARENT_SECTION.name)};this.$btnChangeSection.on("touchend",(()=>(this._blur({onBlur:()=>{this.LOADING||this.VIEW_SCROLLED||(this.NEED_TO_SAVE?this.save({onReady:()=>{e()}}):e())}}),!1))),t.THE_CAFE.is_iiko_mode()||(this.$item_chefsmenu_volume.on("keyup",(()=>{this.need2save(!0)})),this.$item_chefsmenu_price.on("keyup",(()=>{this.need2save(!0)})))},need2save:function(t){this.NEED_TO_SAVE=t,t?this.$view.addClass("need-to-save"):this.$view.removeClass("need-to-save")},get_user_inputs:function(e){return t.THE_CAFE.is_iiko_mode()?{title:this.get_data("item-title",e),description:this.get_data("item-description",e)}:{title:this.get_data("item-title",e),description:this.get_data("item-description",e),volume:this.$item_chefsmenu_volume.val(),price:this.$item_chefsmenu_price.val()}},colllect_all_inputs:function(){const t={},e=this.LTABS.get_langs();for(let i in e)e.hasOwnProperty(i)&&(t[i]=this.get_user_inputs(i));return t},inputs_has_empty_values:function(t){return!t.title||!t.description},save:function(e){const i=this.CURRENT_MENU.id,n=this.ITEM?this.ITEM.id:0,s=this.POS_ORDER,o=this.ITEM?this.ITEM.created_by:"chefsmenu",a=this.colllect_all_inputs();if(!a.ru.title)return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"Укажите название блюда",btn_title:t.LNG.get("lng_close"),on_close:()=>{this._page_to_top()}}),!1;if(a.ru.title.length<3)return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"Название блюда слишком короткое",btn_title:t.LNG.get("lng_close"),on_close:()=>{this._page_to_top()}}),!1;if(!t.THE_CAFE.is_iiko_mode())if(a.ru.price){if(!/^[\d]*[\.\,]*[\d]*$/.test(a.ru.price))return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"Введите корректное значение стоимости",btn_title:t.LNG.get("lng_close")}),!1;a.ru.price=this.price_to_number(a.ru.price)}else a.ru.price=0;let _=0;const r=this.LTABS.get_langs();if(Object.keys(r).length>1)for(let t in r)this.inputs_has_empty_values(a[t])&&_++;const l={all_inputs:a,id_menu:i,id_item:n,created_by:o,pos:s},h="Ошибка. Не удалось сохранить.",c=()=>{this.save_async(l).then((t=>{t.error?t.error&&"string"==typeof t.error&&-1!==t.error.indexOf("total_items")?(this._end_loading(),this.error_message("<p>Общее количество блюд в вашем меню достигло лимита.</p>\n\t\t\t\t\t<p>Откройте «Помощь», чтобы ознакомиться со всеми возможностями и ограничениями сервиса.</p>")):(this._end_loading(),this.error_message(h)):(this.need2save(!1),t["cafe-rev"],this.ITEM=t.item,this.DO_AFTER_SAVE&&this.DO_AFTER_SAVE(this.ITEM),e&&e.onReady&&e.onReady(),setTimeout((()=>{this._end_loading()}),300)),console.log("result 1",typeof t.error,t)})).catch((t=>{console.log("result 2",typeof t.error,t),this.error_message(h),this._end_loading()}))};_?(console.log("some extra fields is empty"),t.VIEWS.modalConfirm({title:"Внимание!",ask:"Некоторые переводы не заполнены. Все равно сохранить?",action:t=>{t&&c()},buttons:["Да","Нет"]})):c()},save_async:function(t){return new Promise(((e,i)=>{this._now_loading(),this.AJAX=$.ajax({url:"adm/lib/lib.save_item.php?callback=?",dataType:"jsonp",data:t,method:"POST",success:function(t){e(t)},error:function(t){i(t)}})}))},error_message:function(e){t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:e,btn_title:t.LNG.get("lng_close"),on_close:()=>{this._page_to_top()}})}},p={init:function(t){this._init(t),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$btnSend=this.$footer.find(".send"),this.$askMessage=this.$form.find(".main-help-user-ask"),this.USER_EMAIL=CFG.user_email;var e=this.$form.find(".main-help-user-mail"),i=e.html();return i=i.replace("[email]","<strong>"+this.USER_EMAIL+"</strong>"),e.html(i),this.$btns_wrapper=this.$form.find(".view_main_help__links-btn"),this.build_asks_btn(),this.reset(),this.behavior(),this},update:function(){var t=this;this.reset(),this._update(),this._page_hide(),this._update_tabindex(),setTimeout((function(){t._page_show()}),300)},reset:function(){this._reset(),this._page_to_top(),this._need2save(!1)},behavior:function(){var e=this;this._behavior(),this.$btnBack.on("touchend",(function(){return e._blur({onBlur:function(){!e.LOADING&&e._go_back()}}),!1})),this.$askMessage.on("keyup",(function(){e.LOADING||(""==$(this).val().trim()?e._need2save(!1):e._need2save(!0));return!1})),this.$btnSend.on("touchend",(function(){return e._blur({onBlur:function(){!e.LOADING&&e.send_question({onReady:function(){t.VIEWS.modalMessage({title:t.LNG.get("lng_thank"),message:"Ваше сообщение отправлено. <br>Ответ придет на адрес "+e.USER_EMAIL,btn_title:t.LNG.get("lng_close")}),e._end_loading(),e.reset(),e._go_back()}})}}),!1}))},build_asks_btn:function(){var e=this,i=[{title:t.LNG.add(["-","Разделы меню: создание и редактирование (видео)"]),link:CFG.http+CFG.site_links.help_edit_sections},{title:t.LNG.add(["-","Блюда: создание и редактирование (видео)"]),link:CFG.http+CFG.site_links.help_edit_items},{title:t.LNG.add(["-","Настройка интерфейса"]),link:CFG.http+CFG.site_links.help_edit_customize_ui},{title:t.LNG.add(["-","Технические возможности и ограничения сервиса"]),link:CFG.http+CFG.site_links.features}];$.each(i,(function(t){var i=$("<div>",{class:"std-form__help-button"}).html(this.title),n=this.link;i.on("touchend",(function(){if(!e.VIEW_SCROLLED&&window.open(n,"_blank"))return!1})),e.$btns_wrapper.append(i)}))},send_question:function(e){var i=this;this._now_loading();var n=t.INPUTS_LENGTH.get("help-user-ask"),s={user_question:$.clear_user_input(this.$askMessage.val(),n),id_cafe:t.THE_CAFE.get().id};this.AJAX&&i.AJAX.abort(),this.AJAX=$.ajax({url:"adm/lib/lib.send_user_question.php?callback=?",data:s,method:"POST",dataType:"jsonp",success:function(n){console.log("response",n),n&&!n.error?e.onReady&&e.onReady():(i._end_loading(),t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:"Не удается отправить сообщение.",btn_title:t.LNG.get("lng_close")}))},error:function(e){i._end_loading(),t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:"Не удается отправить сообщение.",btn_title:t.LNG.get("lng_close")}),console.log(e)}})}},v={init:function(t){return this._init(t),this.$btnGetContract=this.$view.find(".view-get-contract__btn-send"),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.update_contract_cost(),this.behavior(),this},update:function(t){var e=this;this.reset(),this._update(),this._page_hide(),this.USER=t,this.USER_EMAIL=this.USER.email,setTimeout((function(){e._page_show()}),300)},reset:function(){this._reset(),this._page_to_top(),this._need2save(!1)},update_contract_cost:function(){},behavior:function(){var e=this;this._behavior(),this.$btnBack.on("touchend",(function(){return e._blur({onBlur:function(){!e.LOADING&&e._go_back()}}),!1}));var i=function(i){var n=["<p>На ваш адрес: "+e.USER_EMAIL," будет отправлена информация для подключения</p>"].join("");t.VIEWS.modalConfirm({title:"Подключение Меню",ask:n,action:function(){i.on_action&&i.on_action()},cancel:function(){},buttons:[t.LNG.get("lng_ok"),t.LNG.get("lng_cancel")]})},n=function(i){t.VIEWS.modalMessage({title:"Отлично!",message:["Информация отправлена ","на ваш электронный адрес: "+e.USER_EMAIL].join(""),btn_title:t.LNG.get("lng_close"),on_close:function(){setTimeout((function(){e._go_back()}),300)}})},s=function(){t.VIEWS.modalMessage({title:"Внимание!",message:["<p>Вы уже отправляли заявку на подключение сегодня.</p>","На ваш электронный адрес "+e.USER_EMAIL+" направлено письмо","с номером договора и инструкцией.</p>","<p>Если Вы не получили ответ, загляните, на всякий случай, в папку Спам ","или обратитесь в контактный отдел Сервиса. Спасибо</p>"].join(" "),btn_title:t.LNG.get("lng_close")})},o=function(){var i=["Информация не может быть отправлена ","на ваш адрес "+e.USER_EMAIL+", ","попробуйте позже или обратитесь ","к администратору Сервиса"].join("");t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:i,btn_title:t.LNG.get("lng_close")})};this.$btnGetContract.on("touchend",(function(){return e._blur({onBlur:function(){!e.LOADING&&i({on_action:function(){e.request_contract({onReady:function(){n()},onLimit:function(){s()},onError:function(){o()}})}})}}),!1}))},request_contract:function(e){var i=this;this._now_loading();var n={user_email:this.USER_EMAIL,id_cafe:t.THE_CAFE.get().id};this.AJAX&&i.AJAX.abort(),this.AJAX=$.ajax({url:"adm/lib/lib.send_request_contract.php?callback=?",data:n,method:"POST",dataType:"jsonp",success:function(t){console.log("777 response",t),i._end_loading(),t.error?t.error&&-1!==t.error.indexOf("limit message per day")?e.onLimit&&e.onLimit():e.onError&&e.onError():e.onReady&&e.onReady()},error:function(t){i._end_loading(),e.onError&&e.onError(),console.log("777 err response",t)}})}},E={init:function(t){return this._init(t),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$btnSave=this.$view.find(".save"),this.$imageHandler=this.$view.find(".item-image-change__handler"),this.$btnChange=this.$view.find(".change, .item-image-change__handler"),this.$btnRotateRight=this.$footer.find(".rotate-image"),this.$fileInput=this.$view.find("input.fileToUpload"),this.$extraLoader=this.$view.find(".app-view-extra-loader"),this.$extraLoaderLine=this.$extraLoader.find(".app-view-extra-loader__line"),this.$extraLoaderStatus=this.$extraLoader.find(".app-view-extra-loader__status"),this.IMAGE_MAX_WIDTH=1500,this.reset(),this.behavior(),this},reset:function(){this._reset(),this._need2save(!1),this.ID_ITEM=0,this.AJAX=!1,this.IMAGE=null,this.$elImg=null,this.$elCanvas=null,this.onReady=!1,this.CURRENT_ROTATE=0,this.REAL_ROTATE=0,this.handler_no_image(!1),this.btn_rotate_hide(!0),this.handlers_clear(),this.extra_loader_hide()},btn_rotate_hide:function(t){t?this.$btnRotateRight.addClass("hidden"):this.$btnRotateRight.removeClass("hidden")},handlers_clear:function(){this.$imageHandler.html("")},handler_no_image:function(t){t?this.$imageHandler.addClass("no-image"):this.$imageHandler.removeClass("no-image")},update_button_title:function(t){var e=t?"Заменить":"Выбрать";this.$btnChange.find("span").html(e)},update:function(t){var e=this;this.reset(),this._update(),this._page_hide(),this.ITEM=t.item,this.ID_ITEM=this.ITEM.id,this.onReady=t.onReady,this.update_button_title(this.ITEM.image_url),this.ITEM.image_url?(this._now_loading(),this.load_images(this.ITEM.image_url)):(this.handler_no_image(!0),setTimeout((function(){e._page_show()}),300))},rotate_image_toright:function(t){if(!this.LOADING&&this.IMAGE&&this.$elImg){void 0!==t?this.CURRENT_ROTATE=t:this.CURRENT_ROTATE+=90,this.REAL_ROTATE=this.CURRENT_ROTATE%360,this._need2save(!0);var e=!(this.CURRENT_ROTATE/90%2>0),i={w:this.$imageHandler.width(),h:this.$imageHandler.height()};if(this.IMAGE.width<this.IMAGE.height)var n=i.w/i.h;else n=i.h/i.w;var s=e?1:n;if(e)a=0;else var o=this.$elImg.height(),a=(this.$elImg.width()-o)/2*s+(o*s-o)/2;this.$elImg.css({top:a,transform:"translate(-50%,0%) rotateZ("+this.CURRENT_ROTATE+"deg) scale("+s+")",transition:".5s"})}return!1},image_to_start_pos:function(){this.CURRENT_ROTATE=0,this.REAL_ROTATE=0,this.rotate_image_toright(0)},load_images:function(e){var i=this,n=function(e,n){i.NOW_IMG_LOADING=new Image,n.crossOrigin&&(i.NOW_IMG_LOADING.crossOrigin="Anonymous"),i.NOW_IMG_LOADING.onload=function(){n.onReady&&n.onReady(this)},i.NOW_IMG_LOADING.onerror=function(e){var s=["<p>Не удалось открыть изображение, ","хотите его заменить?</p>"].join(" ");t.VIEWS.modalConfirm({title:t.LNG.get("lng_attention"),ask:s,action:function(){n.onReady&&n.onReady(null)},cancel:function(){i._go_back()},buttons:[t.LNG.get("lng_ok"),t.LNG.get("lng_cancel")]}),i._end_loading()},i.NOW_IMG_LOADING.src=e};n(e+"?adm_rnd="+Math.random(),{onReady:function(t){!t&&i.handler_no_image(!0),t&&i.show_image(t),i.update_button_title(t),setTimeout((function(){i._page_show()}),100),setTimeout((function(){t&&i.btn_rotate_hide(!1),i._end_loading()}),300)},crossOrigin:!0})},get_image_from_file:function(t){var e=this,i={readPreview:function(t){var e=new FileReader;e.readAsDataURL(t),e.onload=function(t){var e=t.target.result;i.preloadImage(e)}},preloadImage:function(t){var i=new Image;i.onload=function(){e.show_image(this),setTimeout((function(){e.btn_rotate_hide(!1),e.handler_no_image(!1),e._end_loading(),e.image_to_start_pos()}),300)},i.src=t}};i.readPreview(t)},show_image:function(t){var e=t.height>t.width;this.IMAGE=t,e?this.$imageHandler.addClass("image-vert"):this.$imageHandler.removeClass("image-vert"),this.$elImg?this.$elImg.attr({src:t.src}):(this.$elImg=$("<img>",{src:t.src}),this.$imageHandler.html(this.$elImg))},stop_load_image:function(){this.NOW_IMG_LOADING&&(this.NOW_IMG_LOADING.onload=function(){},this.NOW_IMG_LOADING.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7")},behavior:function(){var t=this;this._behavior(),this.$btnBack.on("touchend",(function(){return t.stop_load_image(),t.AJAX&&t.AJAX.abort(),t._blur({onBlur:function(){t._end_loading(),t._go_back()}}),!1})),this.$btnRotateRight.on("touchend",(function(e){!t.LOADING&&t.rotate_image_toright()})),this.$fileInput.change((function(){var e=$(this)[0].files;e.length&&(t.stop_load_image(),t._need2save(!0),t.FILE_TO_UPLOAD=e[0],t._now_loading(),t.get_image_from_file(e[0]))})),this.$btnChange.on("touchend",(function(){return t._blur({onBlur:function(){t.LOADING||t.$fileInput.val("").trigger("click")}}),!1})),this.$btnSave.on("touchend",(function(){return t._blur({onBlur:function(){!t.LOADING&&t.IMAGE&&t.save()}}),!1}))},extra_loader_show:function(){this.$extraLoader.addClass("app-view-extra-loader-visible")},extra_loader_hide:function(){this.$extraLoader.removeClass("app-view-extra-loader-visible"),this.extra_loader_reset()},extra_loader_update:function(t){this.$extraLoaderLine.css({width:t+"%"}),this.$extraLoaderStatus.html(t+"%")},extra_loader_reset:function(){this.$extraLoaderLine.css({width:0}),this.$extraLoaderStatus.html("0%")},show_err_loading:function(){t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"Не удалось сохранить изображение",btn_title:t.LNG.get("lng_ok")})},canvas_prepare:function(){if(!this.IMAGE||!this.$elImg)return!1;var t=this.IMAGE;t.height,t.width;var e=function(t,e){var i;if(t.height>t.width)if(t.height<e)var n={w:t.width,h:t.height};else{i=e;n={w:t.width/(t.height/e),h:i}}else if(t.width<e)n={w:t.width,h:t.height};else n={w:e,h:t.height/(t.width/e)};return n}(t,this.IMAGE_MAX_WIDTH),i=performance.now();this.cvs=document.createElement("canvas"),this.cvs.setAttribute("id","image-canvas"),this.cvs.width=e.w,this.cvs.height=e.h,this.ctx=this.cvs.getContext("2d"),this.ctx.drawImage(t,0,0,e.w,e.h);var n=performance.now();console.log("image to canvas takes "+(n-i)+" milliseconds.")},save:function(){var t=this;if(this.$inputs.blur(),this.canvas_prepare(),!this.cvs)return!1;this._now_loading(),this.extra_loader_show(),this.btn_rotate_hide(!0);var e=function(e){t._need2save(!1),t._end_loading(),t.extra_loader_hide(),t.btn_rotate_hide(!1);var i=JSON.parse(e.target.responseText);if(!i||i.error)t.show_err_loading();else{var n={image_name:i.image_name,image_url:i.image_url};t.onReady&&t.onReady(n),t._go_back()}},i=function(e){if(e.lengthComputable){var i=parseInt(e.loaded/e.total*100);i>10&&t.extra_loader_update(i-10)}},n=function(e){t.extra_loader_hide(),t._end_loading(),t.show_err_loading(),console.log("upload faled",e.target.responseText)},s=function(e){t.extra_loader_hide(),t._end_loading(),t.show_err_loading(),console.log("upload canceled",e.target.responseText)},o=function(o){var a=new FormData;a.append("up_file",o,"new_image"),a.append("id_item",t.ID_ITEM),a.append("need_rotate",t.REAL_ROTATE),t.AJAX=new XMLHttpRequest,t.AJAX.upload.addEventListener("progress",i,!1),t.AJAX.addEventListener("load",e,!1),t.AJAX.addEventListener("error",n,!1),t.AJAX.addEventListener("abort",s,!1),t.AJAX.open("POST","adm/lib/lib.save_to_file.php",!0),t.AJAX.send(a)};this.cvs.toBlob((function(t){console.log("SAVE!",(t.size/1e6).toFixed(2)+"Mb"),o(t)}),"image/jpeg",.95)}},b={init:function(t){return this._init(t),this.$btnCafeInfo=this.$form.find(".btn-cafe-info"),this.$btnMenuLink=this.$form.find(".btn-menu-link"),this.$btnChangeLanguage=this.$form.find(".btn-change-language"),this.$btnGetContract=this.$form.find(".btn-get-contract"),this.$titleGetContract=this.$form.find(".title-get-contract"),this.$btnChangePassword=this.$form.find(".btn-change-password"),this.$btnChangeCartSettings=this.$form.find(".btn-cart-settings"),this.$btnChangeSubdomain=this.$form.find(".btn-change-subdomain"),this.$btnAddIiko=this.$form.find(".btn-add-iiko"),this.$btnIikoCustomization=this.$form.find(".btn-iiko-customization"),this.$btnIikoModifDict=this.$form.find(".btn-iiko-modifiers-dictionary"),this.$btnAccountExit=this.$form.find(".btn-account-exit"),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$cafe_status=this.$view.find(".view-customize-all__cafe-status"),this.$adm_email=this.$view.find(".view-customize-all__user-email"),this.$app_version=this.$view.find(".view-customize-all__app-version"),this.siteUrl=CFG.http+CFG.www_url,this.update_app_version(CFG.app_version),this.behavior(),this.reset(),this},update_iiko_mode:function(){this.IIKO_MODE=t.THE_CAFE.is_iiko_mode(),this.IIKO_MODE?this.$view.addClass("iiko-mode"):this.$view.addClass("chefsmenu-mode")},update_cafe_status:function(t){let e="",i="";switch(t){case 2:e="Договор",i="cafe-status-contract";break;case 1:e="В архиве",i="cafe-status-archive";break;default:e="Тестовый период",i="cafe-status-test"}this.$view.addClass(i),this.$cafe_status.html("Статус: <span>"+e+"</span>")},update:function(){this._update(),this.reset(),this._page_hide(),this._now_loading(),this.update_iiko_mode(),this.load_user_info().then((e=>{let[i,n]=e;CFG.app_version!==n?this._update_app(n):(this.USER=i,this.$adm_email.html("Администратор: <span>"+i.email+"</span>"),this.load_cafe_info().then((e=>{let i=parseInt(t.THE_CAFE.get("cafe_status"),10),n=parseInt(e.cafe_status,10);n!==i?this._update_app_as_status_changed(n):(this.update_cafe_status(n),this._page_show(),setTimeout((()=>{this._end_loading()}),300))})))}))},update_app_version:function(t){var e=this.$app_version.html().replace("[app-version]",t);this.$app_version.html(e)},reset:function(){this._reset(),this._page_to_top(),this.$view.find(".user-mail span").html("...")},behavior:function(){var e=this;this._behavior(),this.$btnBack.on("touchend",(function(t){!e.LOADING&&e._go_back(),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnCafeInfo.on("touchend",(function(i){e.VIEW_SCROLLED||(t.VIEW_CUSTOMIZING_CAFE.update(),t.VIEWS.setCurrent(t.VIEW_CUSTOMIZING_CAFE.name)),i.originalEvent.cancelable&&i.preventDefault()})),this.$btnChangeLanguage.on("touchend",(function(i){e.VIEW_SCROLLED||(t.VIEW_CUSTOMIZE_INTERFACE.update(e.USER),t.VIEWS.setCurrent(t.VIEW_CUSTOMIZE_INTERFACE.name)),i.originalEvent.cancelable&&i.preventDefault()})),this.$btnChangeCartSettings.on("touchend",(function(i){e.VIEW_SCROLLED||(t.VIEW_CUSTOMIZING_CART.update(e.ID_USER),t.VIEWS.setCurrent(t.VIEW_CUSTOMIZING_CART.name)),i.originalEvent.cancelable&&i.preventDefault()})),this.$btnMenuLink.on("touchend",(function(i){e.VIEW_SCROLLED||(t.VIEW_CAFE_LINK.update(),t.VIEWS.setCurrent(t.VIEW_CAFE_LINK.name)),i.originalEvent.cancelable&&i.preventDefault()})),this.$btnGetContract.on("touchend",(function(i){e.VIEW_SCROLLED||(t.VIEW_GET_CONTRACT.update(e.USER),t.VIEWS.setCurrent(t.VIEW_GET_CONTRACT.name)),i.originalEvent.cancelable&&i.preventDefault()})),this.$btnChangePassword.on("touchend",(function(i){e.VIEW_SCROLLED||(t.VIEW_CHANGE_PASSWORD.update(e.ID_USER),t.VIEWS.setCurrent(t.VIEW_CHANGE_PASSWORD.name)),i.originalEvent.cancelable&&i.preventDefault()})),this.$btnChangeSubdomain.on("touchend",(function(i){e.VIEW_SCROLLED||(t.VIEW_CHANGE_SUBDOMAIN.update(),t.VIEWS.setCurrent(t.VIEW_CHANGE_SUBDOMAIN.name)),i.originalEvent.cancelable&&i.preventDefault()})),this.$btnAddIiko.on("touchend",(function(i){e.VIEW_SCROLLED||(t.VIEW_IIKO_ADDING_API_KEY.update(),t.VIEWS.setCurrent(t.VIEW_IIKO_ADDING_API_KEY.name)),i.originalEvent.cancelable&&i.preventDefault()})),this.$btnIikoCustomization.on("touchend",(function(i){e.VIEW_SCROLLED||(t.VIEW_IIKO_CUSTOMIZATION.update(),t.VIEWS.setCurrent(t.VIEW_IIKO_CUSTOMIZATION.name)),i.originalEvent.cancelable&&i.preventDefault()})),this.$btnIikoModifDict.on("touchend",(function(i){e.VIEW_SCROLLED||(t.VIEW_IIKO_MODIF_DICTIONARY.update(),t.VIEWS.setCurrent(t.VIEW_IIKO_MODIF_DICTIONARY.name)),i.originalEvent.cancelable&&i.preventDefault()})),this.$btnAccountExit.on("touchend",(function(t){e.VIEW_SCROLLED||e.exit(),t.originalEvent.cancelable&&t.preventDefault()}))},exit:function(){var e=this;this._now_loading(),this.AJAX=$.ajax({url:"adm/lib/usr.exit.php?callback=?",dataType:"jsonp",data:{},method:"POST",success:function(i){e._end_loading(),i&&!i.error?location.href=e.siteUrl:t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:i.error,btn_title:t.LNG.get("lng_close")})},error:function(i){e._end_loading(),t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:"Не могу выйти из аккаунта",btn_title:t.LNG.get("lng_close")})}})},load_user_info:function(){return new Promise(((e,i)=>{var n=this;this.AJAX=$.ajax({url:"adm/lib/usr.get_info.php?callback=?",dataType:"jsonp",data:{},method:"POST",success:function(i){n._end_loading(),i.error?(t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:"Не могу загрузить данные пользователя",btn_title:t.LNG.get("lng_close")}),console.log("err:",i.error)):e([i.user,i["app-version"]])},error:function(t){return n._end_loading(),n._reload_by_err(),console.log("err load page",t),!1}})}))},load_cafe_info:function(){return new Promise(((e,i)=>{var n=this;this.AJAX=$.ajax({url:"adm/lib/lib.get_cafe_info.php?callback=?",dataType:"jsonp",data:{},method:"POST",success:function(i){i.error?(t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:"Не могу загрузить данные меню",btn_title:t.LNG.get("lng_close")}),console.log("err:",i.error)):(console.log("---load_cafe_info response---",i),e(i.cafe))},error:function(t){return n._end_loading(),n._reload_by_err(),console.log("err load page",t),!1}})}))}},I={init:function(t){return this._init(t),this.$btnSave=this.$footer.find(".save"),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$btnCafeDescription=this.$view.find(".btn-cafe-description"),this._need2save(!1),this.behavior(),this},update:function(){var e=this;this._update(),this._page_hide(),this.reset();var i=t.THE_CAFE.get();this.ID_CAFE=i.id,this.$view.find("input[name=cafe-title]").val(i.cafe_title),this.$view.find("textarea[name=cafe-address]").val(i.cafe_address),this.$view.find("input[name=chief-cook]").val(i.chief_cook),this.$view.find("input[name=cafe-phone]").val(i.cafe_phone),this.$view.find("input[name=work-hours]").val(i.work_hours),setTimeout((function(){e._page_show()}),300)},behavior:function(){var e=this;this._behavior(),this.$btnBack.on("touchend",(function(){return e._blur({onBlur:function(){!e.LOADING&&e._go_back()}}),!1})),this.$btnSave.on("touchend",(function(){return e._blur({onBlur:function(){e.NEED_TO_SAVE&&!e.LOADING&&e.save({onReady:function(){e._go_back()}})}}),!1})),this.$btnCafeDescription.on("touchend click",(function(i){return e._blur({onBlur:function(){e.LOADING||e.VIEW_SCROLLED||(t.VIEW_CAFE_DESCRIPTION.update(),t.VIEWS.setCurrent(t.VIEW_CAFE_DESCRIPTION.name))}}),!1})),this.$inputs.on("keyup",(function(t){return e._need2save(!0),!1}))},reset:function(){this._reset(),this._need2save(!1),this._page_to_top()},save:function(e){var i=this,n=this.ID_CAFE,s={cafe_title:this.$view.find("input[name=cafe-title]").val(),cafe_address:this.$view.find("textarea[name=cafe-address]").val(),chief_cook:this.$view.find("input[name=chief-cook]").val(),cafe_phone:this.$view.find("input[name=cafe-phone]").val(),work_hours:this.$view.find("input[name=work-hours]").val()},o={cafe_title:$.clear_user_input(s.cafe_title,t.INPUTS_LENGTH.get("cafe-title")),cafe_address:$.clear_user_input(s.cafe_address,t.INPUTS_LENGTH.get("cafe-address")),chief_cook:$.clear_user_input(s.chief_cook,t.INPUTS_LENGTH.get("chief-cook")),cafe_phone:$.clear_user_input(s.cafe_phone,t.INPUTS_LENGTH.get("cafe-phone")),work_hours:$.clear_user_input(s.work_hours,t.INPUTS_LENGTH.get("work-hours"))};if(!o.cafe_title)return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"Укажите название кафе",btn_title:t.LNG.get("lng_close")}),!1;if(o.cafe_title.length<3)return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"Название кафе слишком короткое",btn_title:t.LNG.get("lng_close")}),!1;if(!o.cafe_address)return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"Введите адрес кафе",btn_title:t.LNG.get("lng_close")}),!1;if(o.cafe_address.length<3)return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"Адрес кафе слишком короткий",btn_title:t.LNG.get("lng_close")}),!1;if(o.cafe_phone){if(!/^[\d\s\-\(\)\+\,]+$/.test(o.cafe_phone))return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"<p>Введите корректный номер телефона кафе.</p><p>Допускаются только цифры скобки и тире</p>",btn_title:t.LNG.get("lng_close")}),!1}this._now_loading();var a={id_cafe:n,cafe_title:o.cafe_title,cafe_address:o.cafe_address,chief_cook:o.chief_cook,cafe_phone:o.cafe_phone,work_hours:o.work_hours};this.AJAX=$.ajax({url:"adm/lib/lib.save_cafe.php?callback=?",dataType:"jsonp",data:a,method:"POST",success:function(n){if(console.log("response",n),!n||n.error)console.log("response err:",n);else{var s=n;s.rev,t.THE_CAFE.update(s),t.VIEW_ALL_MENU._update_title(s.cafe_title),i._end_loading(),e&&e.onReady&&e.onReady(s)}},error:function(t){i._end_loading(),console.log("err save cafe info",t)}})}},A={init:function(t){return this._init(t),this.$btnSave=this.$view.find(".save"),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$buttonsCartMode=this.$view.find(".customizing-cart__cart-mode"),this.$buttonsDeliveryMode=this.$view.find(".customizing-cart__delivery-mode"),this.$buttonsOrderWay=this.$view.find(".customizing-cart__order-way"),this.sa_bnt_upd_tg_keys=this.$view.find('button[name="update_all_tg_keys"]'),this.$section_tgusers=this.$view.find(".customizing-cart__all-tgusers"),this.$iikoSectionOnly=this.$view.find(".iiko-section-only"),this.$btn_tg_key_waiter=this.$view.find("button.key-waiter"),this.$btn_tg_key_manager=this.$view.find("button.key-manager"),this.$btn_tg_key_supervisor=this.$view.find("button.key-supervisor"),this.$btn_get_invitation_link=this.$view.find("button[name=get_invitation_link]"),this.behavior(),this},reset:function(){this._reset(),this._need2save(!1),this._page_to_top(),this.iiko_set_section_visibility(t.THE_CAFE.is_iiko_mode())},update:function(e){this._update(),this._page_hide();var i=t.THE_CAFE.get();this.ID_CAFE=i.id,this.NEW_CART_MODE=parseInt(i.cart_mode,10),this.NEW_DELIVERY_MODE=parseInt(i.has_delivery,10),this.NEW_ORDER_WAY=parseInt(i.order_way,10),this.reset(),this.rebuild(),this.load_tg_keys_async().then((t=>{this.update_tg_keys_buttons(t),this.load_tg_users_async().then((t=>{this.update_tg_users_list(t),this.end_updating()})).catch((t=>{this.end_updating_with_error("Не удалось проверить пользователей телеграм чата для кафе")}))})).catch((t=>{this.end_updating_with_error("Не удалось загрузить ключи для телеграма")}))},update_tg_users_list:function(t){const e=this.$section_tgusers.find(".tgusers-role-waiter span"),i=this.$section_tgusers.find(".tgusers-role-manager span"),n=this.$section_tgusers.find(".tgusers-role-supervisor span"),s=function(t,e){let i="";if(t.length>0){let n=0;for(let e in t){i+=`<strong>${t[e].nickname?`${t[e].nickname} (${t[e].name})`:t[e].name}</strong>`,n++,n<t.length&&(i+=", ")}console.log("html",i),e.html(i)}};if(function(){const t="нет";e.html(t),i.html(t),n.html(t)}(),t&&t.length){const o={waiters:[],managers:[],supervisors:[]};for(let e in t)switch(t[e].role){case"waiter":o.waiters.push(t[e]);break;case"manager":o.managers.push(t[e]);break;case"supervisor":o.supervisors.push(t[e])}s(o.waiters,e),s(o.managers,i),s(o.supervisors,n)}},end_updating_with_error(e){e&&t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:e,btn_title:t.LNG.get("lng_ok")}),this.end_updating()},end_updating:function(){setTimeout((()=>{this._end_loading(),this._page_show()}),300)},update_tg_keys_buttons:function(t){const e=t.reduce(((t,e)=>{const i=e.role||"";return i&&(t[i]=e),t}),{});this.TG_KEYS=e;const i=e.waiter.tg_key,n=e.manager.tg_key,s=e.supervisor.tg_key;i&&this.$btn_tg_key_waiter.html(i.toUpperCase()),n&&this.$btn_tg_key_manager.html(n.toUpperCase()),s&&this.$btn_tg_key_supervisor.html(s.toUpperCase())},rebuild:function(){var e=this;t.THE_CAFE.get(),this.$buttonsCartMode.html("");var i=["Корзина выключена","Корзина включена"];for(let n=0;n<i.length;n++){let s=parseInt(t.THE_CAFE.get().cart_mode,10)==n?" checked":"",o=$("<div class='std-form__radio-button "+s+"' mode='"+n+"'>"+i[n]+"</div>\n");o.on("touchend",(function(t){e.VIEW_SCROLLED||$(this).hasClass("checked")||(e.NEW_CART_MODE=parseInt($(this).attr("mode"),10),$(this).addClass("checked"),$(this).siblings().removeClass("checked"),e.check_need_to_save()),t.originalEvent.cancelable&&t.preventDefault()})),this.$buttonsCartMode.append(o)}this.$buttonsDeliveryMode.html("");i=["Нет доставки","Есть доставка"];for(let n=0;n<i.length;n++){let s=parseInt(t.THE_CAFE.get().has_delivery,10)==n?" checked":"",o=$("<div class='std-form__radio-button "+s+"' mode='"+n+"'>"+i[n]+"</div>\n");o.on("touchend",(function(t){e.VIEW_SCROLLED||$(this).hasClass("checked")||(e.NEW_DELIVERY_MODE=parseInt($(this).attr("mode"),10),$(this).addClass("checked"),$(this).siblings().removeClass("checked"),e.check_need_to_save()),t.originalEvent.cancelable&&t.preventDefault()})),this.$buttonsDeliveryMode.append(o)}this.$buttonsOrderWay.html("");i=["1. Только в TG","2. В TG, затем в iiko (beta)"];for(let n=0;n<i.length;n++){let s=parseInt(t.THE_CAFE.get().order_way,10)==n?" checked":"",o=$("<div class='std-form__radio-button "+s+"' mode='"+n+"'>"+i[n]+"</div>\n");o.on("touchend",(function(t){e.VIEW_SCROLLED||$(this).hasClass("checked")||(e.NEW_ORDER_WAY=parseInt($(this).attr("mode"),10),$(this).addClass("checked"),$(this).siblings().removeClass("checked"),e.check_need_to_save()),t.originalEvent.cancelable&&t.preventDefault()})),this.$buttonsOrderWay.append(o)}this.check_need_to_save()},iiko_set_section_visibility:function(t){t?this.$iikoSectionOnly.show():this.$iikoSectionOnly.hide()},behavior:function(){var e=this;this._behavior(),this.$btnBack.on("touchend",(function(){return e._blur({onBlur:function(){!e.LOADING&&t.VIEWS.goBack()}}),!1})),this.$btnSave.on("touchend",(function(){return e._blur({onBlur:function(){!e.LOADING&&e.save({onReady:function(){e._go_back()}})}}),!1})),this.$btn_tg_key_waiter.on("touchend",(t=>{!e.VIEW_SCROLLED&&e._blur({onBlur:()=>{const t="waiter";this.$btn_tg_key_waiter.focus(),setTimeout((()=>{e.tg_key_to_clipboard(this.TG_KEYS[t].tg_key,t)}),300)}}),t.originalEvent.cancelable&&t.preventDefault()})),this.$btn_tg_key_manager.on("touchend",(t=>{!e.VIEW_SCROLLED&&e._blur({onBlur:()=>{const t="manager";this.$btn_tg_key_manager.focus(),setTimeout((()=>{e.tg_key_to_clipboard(this.TG_KEYS[t].tg_key,t)}),300)}}),t.originalEvent.cancelable&&t.preventDefault()})),this.$btn_tg_key_supervisor.on("touchend",(t=>{!e.VIEW_SCROLLED&&e._blur({onBlur:()=>{const t="supervisor";this.$btn_tg_key_supervisor.focus(),setTimeout((()=>{e.tg_key_to_clipboard(this.TG_KEYS[t].tg_key,t)}),300)}}),t.originalEvent.cancelable&&t.preventDefault()})),this.sa_bnt_upd_tg_keys.on("touchend",(t=>{!e.VIEW_SCROLLED&&this.sa_update_all_tg_keys(),t.originalEvent.cancelable&&t.preventDefault()})),this.$btn_get_invitation_link.on("touchend",(t=>{!e.VIEW_SCROLLED&&this.create_invitation_link(),t.originalEvent.cancelable&&t.preventDefault()}))},tg_key_to_clipboard:function(e,i){navigator.clipboard.writeText(e.toUpperCase()).then((()=>{let e="Ключ не удалось скопировать";"waiter"===i?e="Ключ <strong>для официанта</strong> скопирован":"manager"===i?e="Ключ <strong>для менеджера</strong> скопирован":"supervisor"===i&&(e="Ключ <strong>для администратора</strong> скопирован"),t.VIEWS.modalMessage({title:"Отлично!",message:e,btn_title:t.LNG.get("lng_ok")})}),(()=>{t.VIEWS.modalMessage({title:"Ошибка",message:"Ключ не удалось скопировать",btn_title:t.LNG.get("lng_ok")})}))},check_need_to_save:function(){this._need2save(!1),t.THE_CAFE.is_iiko_mode()?parseInt(t.THE_CAFE.get().cart_mode,10)===this.NEW_CART_MODE&&parseInt(t.THE_CAFE.get().order_way,10)===this.NEW_ORDER_WAY&&parseInt(t.THE_CAFE.get().has_delivery,10)===this.NEW_DELIVERY_MODE||this._need2save(!0):parseInt(t.THE_CAFE.get().cart_mode,10)===this.NEW_CART_MODE&&parseInt(t.THE_CAFE.get().has_delivery,10)===this.NEW_DELIVERY_MODE||this._need2save(!0)},create_invitation_link:function(){return this.load_tg_link_async("manager").then((t=>{console.log("link = ",t),this._end_loading()})).catch((t=>{this._end_loading(),console.log("error",t)}))},load_tg_link_async:function(e){return new Promise(((i,n)=>{this._now_loading();var s={cafe_uniq_name:t.THE_CAFE.get().uniq_name,user_role:e};this.AJAX=$.ajax({url:"adm/lib/lib.get_tg_link.php?callback=?",data:s,method:"POST",dataType:"jsonp",success:function(t){t&&!t.error?i(t):n(t)},error:function(t){n(t)}})}))},load_tg_keys_async:function(){return new Promise(((e,i)=>{this._now_loading();var n={cafe_uniq_name:t.THE_CAFE.get().uniq_name};this.AJAX=$.ajax({url:"adm/lib/lib.get_tg_keys.php?callback=?",data:n,method:"POST",dataType:"jsonp",success:function(t){console.log("==response==",t),t&&!t.error?e(t):i(t)},error:function(t){console.log("==err response==",t),i(t)}})}))},load_tg_users_async:function(){return new Promise(((e,i)=>{this._now_loading();var n={cafe_uniq_name:t.THE_CAFE.get().uniq_name};this.AJAX=$.ajax({url:"adm/lib/lib.get_tg_users.php?callback=?",data:n,method:"POST",dataType:"jsonp",success:function(t){console.log("==response==",t),t&&!t.error?e(t):i(t)},error:function(t){console.log("==err response==",t),i(t)}})}))},save:function(e){var i=this;this._now_loading();var n={id_cafe:t.THE_CAFE.get().id,cart_mode:this.NEW_CART_MODE,order_way:this.NEW_ORDER_WAY,has_delivery:this.NEW_DELIVERY_MODE};this.AJAX=$.ajax({url:"adm/lib/lib.save_cart_settings.php?callback=?",data:n,method:"POST",dataType:"jsonp",success:function(n){if(console.log("response",n),n&&!n.error){var s=n;s.rev,setTimeout((function(){!function(n){i._end_loading(),n.error?(i._end_loading(),console.log(n.error)):(t.THE_CAFE.update(n),e.onReady&&e.onReady())}(s)}),300)}else console.log("response err:",n)},error:function(t){i._end_loading(),console.log("err load cafe info",t)}})},sa_update_all_tg_keys:function(){t.VIEWS.modalConfirm({title:"Внимание",ask:"Вы уверены, что хотите заменить ключи телеграма. Всем сотрудникам придется зайти в телеграм канал заново.",action:e=>{e?this.sa_update_all_tg_keys_asynq().then((t=>{this.update_tg_keys_buttons(t),this.update_tg_users_list(!1),this._end_loading()})).catch((e=>{t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"Не удалось обновить ключи для телеграма",btn_title:t.LNG.get("lng_ok")}),console.log(e),this._end_loading()})):console.log("CANCELED")},buttons:[t.LNG.get("lng_ok"),t.LNG.get("lng_cancel")]})},sa_update_all_tg_keys_asynq:function(){return new Promise(((e,i)=>{this._now_loading();var n={cafe_uniq_name:t.THE_CAFE.get().uniq_name};this.AJAX=$.ajax({url:"adm/lib/lib.update_all_tg_keys.php?callback=?",data:n,method:"POST",dataType:"jsonp",success:function(t){t&&!t.error?e(t):i(t)},error:function(t){i(t)}})}))}},w={init:function(t){return this._init(t),this.$btnSave=this.$view.find(".save"),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$buttonsSkin=this.$view.find(".customize-interface__skin"),this.$extra_lang_container=this.$view.find(".customize-interface__extra_lang"),this.$inp_new_lang=this.$view.find("input[name=new-lang]"),this.$inp_lang_to_delete=this.$view.find("input[name=lang-to-delete]"),this.behavior(),this},update:function(e){this._update(),this._page_hide(),this.USER=e;var i=t.THE_CAFE.get();this.reset(),this._now_loading();const n=t.THE_CAFE.get("extra_langs"),s=n?JSON.parse(n):[];this._rebuild_extra_langs_list(s),this.NEW_CAFE_SKIN=i.skin_label,this.SKINS?setTimeout((()=>{this._page_show(),this._end_loading()}),300):this.load_all_skins({onReady:t=>{this.SKINS=t,this.rebuild(),setTimeout((()=>{this._page_show(),this._end_loading()}),600)}})},load_all_skins:function(t){var e=this;this._now_loading(),this.AJAX=$.ajax({url:"adm/lib/lib.get_all_skins.php?callback=?",data:{},method:"POST",dataType:"jsonp",success:function(i){if(console.log("response",i),i&&!i.error){var n=i["all-skins"];t&&t.onReady&&t.onReady(n)}else e._end_loading(),console.log("response err:",i)},error:function(t){e._end_loading(),console.log("err load cafe info",t)}})},reset:function(){this._reset(),this._need2save(!1),this._page_to_top()},rebuild:function(){this.rebuild_skins_list(),this.check_need_to_save()},rebuild_skins_list:function(){var t=this;this.$buttonsSkin.html("");var e=this.SKINS["all-skins"],i=this.SKINS["skin-groups"];for(var n in this.NEW_CAFE_SKIN||(this.NEW_CAFE_SKIN="light-lemon"),i){var s=i[n];for(var o in e)if(e[o].group==s){var a=e[o].label,_=this.NEW_CAFE_SKIN==a?"checked":"",r=$("<div>",{attr:{label:a},class:"std-form__radio-button "+_}).html(e[o].name.ru);r.on("touchend",(function(){return t.VIEW_SCROLLED||$(this).hasClass("checked")||(t.NEW_CAFE_SKIN=$(this).attr("label"),$(this).addClass("checked"),$(this).siblings().removeClass("checked"),t.check_need_to_save()),!1})),this.$buttonsSkin.append(r)}}},behavior:function(){this._behavior(),this.$btnBack.on("touchend",(()=>(this._blur({onBlur:()=>{!this.LOADING&&t.VIEWS.goBack()}}),!1))),this.$btnSave.on("touchend",(()=>(this._blur({onBlur:()=>{this.LOADING||this.save_async().then((e=>{const i=e;t.THE_CAFE.update(i),this._go_back()})).catch((t=>{this._show_err_message(t)}))}}),!1))),this.$inp_new_lang.on("keyup",(t=>{this.$inp_lang_to_delete.val(""),this.check_need_to_save()})),this.$inp_lang_to_delete.on("keyup",(t=>{this.$inp_new_lang.val(""),this.check_need_to_save()}))},check_need_to_save:function(){this._need2save(!1);let e=this.$inp_new_lang.val().trim(),i=this.$inp_lang_to_delete.val().trim();t.THE_CAFE.get().skin_label===this.NEW_CAFE_SKIN&&""===e&&""===i||this._need2save(!0)},save_async:function(){return new Promise(((e,i)=>{this._now_loading();const n={id_cafe:t.THE_CAFE.get().id,new_lang:this.$inp_new_lang.val().trim(),lang_to_delete:this.$inp_lang_to_delete.val().trim(),skin_label:this.NEW_CAFE_SKIN};this.AJAX=$.ajax({url:"adm/lib/lib.save_interface.php?callback=?",data:n,method:"POST",dataType:"jsonp",success:t=>{console.log("result1",t),t&&!t.error?e(t):i(t)},error:t=>{console.log("result2",t),i(t)}})}))},_show_err_message(e){let i="Не могу загрузить данные. Нужна помощь Администратора сервиса.";e.error&&"string"==typeof e.error&&-1!==e.error.indexOf("Unknown lang")?i="Не найден язык. Проверьте введенное название.":e.error&&"string"==typeof e.error&&-1!==e.error.indexOf("Too short lang name")&&(i="Проверьте введенное название языка. Слишком короткое."),t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:i,btn_title:t.LNG.get("lng_close")}),this._end_loading()},_rebuild_extra_langs_list:function(t){if(this.$extra_lang_container.html(""),!(Object.keys(t).length>0)){let t="<p>Не найдены</p>";return this.$extra_lang_container.html(t),!1}{let e=$("<ul></ul>");for(let i in t)t.hasOwnProperty(i)&&e.append(`<li>${t[i]} <strong>(${i})</strong></li>`);this.$extra_lang_container.html(e)}}},N={init:function(t){return this._init(t),this.$btnSave=this.$view.find(".save"),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$cafe_description=this.$view.find("textarea[name=cafe-description]"),this.behavior(),this},update:function(){var e=this;this._update(),this.reset(),this._update_tabindex();var i=t.THE_CAFE.get();this._need2save(!1),this.$cafe_description.val(i.cafe_description),setTimeout((function(){e._page_show()}),300)},reset:function(){this._reset(),this._page_to_top()},behavior:function(){var t=this;this._behavior(),this.$btnBack.on("touchend",(function(){return t._blur({onBlur:function(){!t.LOADING&&t._go_back()}}),!1})),this.$btnSave.on("touchend",(function(){return t._blur({onBlur:function(){t.NEED_TO_SAVE&&!t.LOADING&&t.save({onReady:function(){t._go_back()}})}}),!1})),this.$inputs.on("keyup",(function(e){return t._need2save(!0),!1}))},save:function(e){var i=this,n=t.INPUTS_LENGTH.get("cafe-description"),s=$.clear_user_input(this.$cafe_description.val(),n);if(""==s)return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"Напишите немного о вашем заведении.",btn_title:t.LNG.get("lng_close")}),!1;s.length<5&&(s="Нет информации");var o={id_cafe:t.THE_CAFE.get().id,cafe_description:s};this._now_loading(),this.AJAX=$.ajax({url:"adm/lib/lib.save_cafe_description.php?callback=?",dataType:"jsonp",data:o,method:"POST",success:function(n){if(console.log("response",n),i._end_loading(),n&&!n.error){var s=n;s.rev,t.THE_CAFE.update(s),t.VIEW_ALL_MENU._update_title(s.cafe_title),i._end_loading(),e&&e.onReady&&e.onReady(s)}else console.log(n.error)},error:function(t){i._end_loading(),console.log("err save cafe description",t)}})}},T={init:function(t){return this._init(t),this.$btnSave=this.$view.find(".save"),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$allMenuSection=this.$view.find(".all-menu-sections"),this.behavior(),this.reset(),this},update:function(t){var e=this;this.reset(),this._update(),this._page_hide(),this.ITEM=t,this.rebuild(),setTimeout((function(){e._page_show()}),300)},reset:function(){this._reset(),this._page_to_top(),this._need2save(!1),this.NEW_PARENT_MENU=0},rebuild:function(){var e=this;this.$allMenuSection.html("");for(var i=t.VIEW_ALL_MENU.get(),n=0;n<i.length;n++){var s=parseInt(e.ITEM.id_menu,10)===parseInt(i[n].id,10)?" checked":"",o=$('<div class="std-form__radio-button '+s+'" mode="'+i[n].id+'">'+i[n].title+"</div>\n");o.on("touchend",(function(){return e.VIEW_SCROLLED||$(this).hasClass("checked")||(e.NEW_PARENT_MENU=parseInt($(this).attr("mode"),10),$(this).addClass("checked"),$(this).siblings().removeClass("checked"),e.on_change()),!1})),this.$allMenuSection.append(o)}setTimeout((function(){e._page_show()}),600)},on_change:function(){var t=!(!this.NEW_PARENT_MENU||parseInt(this.NEW_PARENT_MENU,10)===parseInt(this.ITEM.id_menu,10));this._need2save(t)},behavior:function(){var e=this;this._behavior(),this.$btnSave.on("touchend",(function(){return e._blur({onBlur:function(){if(!e.LOADING)if(e.NEED_TO_SAVE){var i=t.VIEW_ALL_MENU.get(e.NEW_PARENT_MENU);e.save({onReady:function(e){t.VIEW_ALL_ITEMS.update(i,{move2end:!0}),t.VIEWS.jumpTo(t.VIEW_ALL_ITEMS.name)}})}else e._go_back()}}),!1})),this.$btnBack.on("touchend",(function(){return e._blur({onBlur:function(){!e.LOADING&&e._go_back()}}),!1}))},save:function(t){var e=this;this._now_loading();var i={id_item:this.ITEM.id,new_parent_menu:this.NEW_PARENT_MENU};this.AJAX=$.ajax({url:"adm/lib/lib.save_item_parent.php?callback=?",dataType:"jsonp",data:i,method:"POST",success:function(i){if(console.log("response",i),i.error)console.log(i.error);else{i["cafe-rev"];var n=i.item;setTimeout((function(){e._end_loading(),t&&t.onReady&&t.onReady(n)}),300)}},error:function(t){e._end_loading(),console.log("err save item parent",t)}})}},k={init:function(t){return this._init(t),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$btnGetQRcode=this.$footer.find(".btn-get-qrcode"),this.$home_menu_link=this.$form.find(".std-form__bright-link a"),this.$qrCode=this.$form.find(".view-cafe-link__qr-code"),this.USER_EMAIL=CFG.user_email,this.behavior(),this},update:function(){var e=this;this._update(),this._page_hide(),this._now_loading(),this.reset(),this._update_tabindex();var i=t.THE_CAFE.get();this.$home_menu_link.html(t.THE_CAFE.get_link("name")).attr({href:t.THE_CAFE.get_link("url")}),this.$qrCode.html("<img src='"+i.qrcode+"'>");var n=new Image;n.onload=function(){e._end_loading(),e._page_show()},n.src=i.qrcode},reset:function(){this._reset(),this._page_to_top()},behavior:function(){var e=this;this._behavior(),this.$btnBack.on("touchend",(function(){return e._blur({onBlur:function(){!e.LOADING&&e._go_back()}}),!1}));var i=function(i){var n=["<p>На ваш адрес: "+e.USER_EMAIL,"будет отправлен QR-код вашего Меню и инструкция по применению</p>"].join(" ");t.VIEWS.modalConfirm({title:"Отправка сообщения",ask:n,action:function(){i.on_action&&i.on_action()},cancel:function(){},buttons:[t.LNG.get("lng_ok"),t.LNG.get("lng_cancel")]})},n=function(i){t.VIEWS.modalMessage({title:"Отлично!",message:["Информация отправлена ","на ваш электронный адрес: "+e.USER_EMAIL].join(""),btn_title:t.LNG.get("lng_close"),on_close:function(){setTimeout((function(){e._go_back()}),300)}})},s=function(){t.VIEWS.modalMessage({title:"Внимание!",message:["<p>Вы уже запрашивали QR-код менее 5 минут назад.</p>","На ваш электронный адрес "+e.USER_EMAIL+" было направлено письмо","с кодом и инструкцией.</p>","<p>Если Вы не получили ответ, загляните, на всякий случай, в папку Спам,","попробуйте получить код позже или обратитесь в контактный отдел Сервиса</p>"].join(" "),btn_title:t.LNG.get("lng_close")})},o=function(){var i=["Информация не может быть отправлена ","на ваш адрес "+e.USER_EMAIL+", ","попробуйте позже или обратитесь ","к администратору Сервиса"].join("");t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:i,btn_title:t.LNG.get("lng_close")})};this.$btnGetQRcode.on("touchend",(function(){return e._blur({onBlur:function(){!e.LOADING&&i({on_action:function(){return e.send({onReady:function(){n()},onLimit:function(){s()},onError:function(){o()}}),!1}})}}),!1})),this.$view.find(".btn-cafe-description").on("touchend",(function(){return t.VIEWS.setCurrent(t.VIEW_MAIN_HELP.name),!1}))},send:function(e){var i=this;this._now_loading();var n={id_cafe:t.THE_CAFE.get().id};this.AJAX=$.ajax({url:"adm/lib/lib.send_qr_code.php?callback=?",data:n,method:"POST",dataType:"jsonp",success:function(t){console.log("response=",t),i._end_loading(),t.error?t.error&&-1!==t.error.indexOf("limit message per day")?e.onLimit&&e.onLimit():e.onError&&e.onError():e.onReady&&e.onReady()},error:function(t){i._end_loading(),e.onError&&e.onError(),console.log("err",t)}})}},L={init:function(t){return this._init(t),this.$inputPass=this.$view.find("input[name=new-password]"),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$btnSave=this.$view.find(".save"),this.SITE_URL=CFG.base_url,this.USER_EMAIL=CFG.user_email,this.behavior(),this.reset(),this},update:function(t){var e=this;this._update(),this._page_hide(),this._update_tabindex(),this.ID_USER=t,this.reset(),setTimeout((function(){e._page_show()}),300)},reset:function(){this._reset(),this._need2save(!1),this._page_to_top(),this.pass_show()},behavior:function(){var e=this;this._behavior(),this.$btnBack.bind("touchend",(function(){return e._blur({onBlur:function(){!e.LOADING&&e._go_back()}}),!1}));var i=function(i){var n=["<p>На ваш адрес <b>"+e.USER_EMAIL+"</b>","будет отправлена ссылка","для подтверждения смены пароля.</p>"].join(" ");t.VIEWS.modalConfirm({title:"Отправка сообщения",ask:n,action:function(){i.on_action&&i.on_action()},cancel:function(){},buttons:[t.LNG.get("lng_ok"),t.LNG.get("lng_cancel")]})},n=function(i){t.VIEWS.modalMessage({title:"Запрос отправлен!",message:["На ваш электронный адрес: <strong>"+e.USER_EMAIL+"</strong>","отправлена ссылка. Перейдите по ней, чтобы","сохранить изменение пароля"].join(" "),btn_title:t.LNG.get("lng_close"),on_close:function(){setTimeout((function(){e._go_back()}),300)}})},s=function(){var i=["Информация не может быть отправлена ","на ваш адрес "+e.USER_EMAIL+", ","попробуйте позже или обратитесь ","к администратору Сервиса"].join("");t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:i,btn_title:t.LNG.get("lng_close")})};this.$btnSave.bind("touchend",(function(){return e._blur({onBlur:function(){e.NEED_TO_SAVE&&!e.LOADING&&i({on_action:function(){e.save({onReady:function(){n()},onError:function(){s()}})}})}}),!1})),this.$inputPass.on("keyup",(function(t){e.is_need_to_save()}))},is_need_to_save:function(){""!==this.$inputPass.val()?this._need2save(!0):this._need2save(!1)},is_correct_input:function(e){return/^[\-\_0-9a-zA-Z]*$/g.test(e)?!(e.length<6)||(t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:t.LNG.get("lng_min_pass_length"),btn_title:t.LNG.get("lng_close")}),!1):(t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:["<p>Для пароля допустимы следующие символы:</p>","<ul><li>Бувы латинского алфавита</li><li>Цифры</li>","<li>Тире</li><li>Знак подчеркивания</li></ul></p>"].join(" "),btn_title:t.LNG.get("lng_close")}),!1)},pass_hide:function(){this.$inputPass.attr({type:"password"})},pass_show:function(){this.$inputPass.attr({type:"input"})},save:function(e){var i=this,n=t.INPUTS_LENGTH.get("new-password"),s=$.clear_user_input(this.$inputPass.val(),n);if(this.is_correct_input(s)){this.$inputPass.blur(),this.pass_hide();var o={newpass:s};this._now_loading(),this.AJAX=$.ajax({url:"adm/lib/usr.password_update.php?callback=?",dataType:"jsonp",data:o,method:"POST",success:function(t){console.log("confirm",t),i._end_loading(),t&&!t.error?(i._end_loading(),e&&e.onReady&&e.onReady()):(e&&e.onError&&e.onError(),i.pass_show())},error:function(t){i._end_loading(),i.pass_show(),console.log(t),e&&e.onError&&e.onError()}})}}},S={init:function(t){return this._init(t),this.$inputSubdomain=this.$view.find("input[name=new-subdomain]"),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$btnSave=this.$view.find(".save"),this.$bestAddress=this.$form.find(".view-change-subdomain__best-address"),this.$bestAddressText=this.$form.find(".view-change-subdomain__best-address_text"),this.$addressPreview=this.$form.find(".view-change-subdomain__preview"),this.$allwaysAddressText=this.$form.find(".view-change-subdomain__allways-address_text"),this.SITE_URL=CFG.base_url,this.USER_EMAIL=CFG.user_email,this.reset(),this.behavior(),this},update:function(){var e=this;this._reset(),this._update(),this._page_hide(),this._update_tabindex(),this.load({onReady:function(i){i.subdomain!==t.THE_CAFE.get("subdomain")&&t.THE_CAFE.set({subdomain:i.subdomain}),e.CAFE=t.THE_CAFE.get(),e.reset(),e.update_content(),setTimeout((function(){e._page_show()}),300)}})},reset:function(){this._reset(),this._need2save(!1),this._page_to_top(),this.update_address_preview()},update_content:function(){var t=".view-change-subdomain__if-has-subdomain",e=".view-change-subdomain__if-no-subdomain";""==this.CAFE.subdomain?(this.$form.find(t).hide(),this.$form.find(e).show()):(this.$form.find(t).show(),this.$form.find(e).hide());var i=CFG.http,n=CFG.www_url+"/cafe/"+this.CAFE.uniq_name;if(""==this.CAFE.subdomain)var s=n;else s=this.CAFE.subdomain+"."+CFG.www_url;var o='<a href="'+i+s+'" >'+s+"</a>",a='<a href="'+i+n+'" >'+n+"</a>";this.$bestAddressText.html(o),this.$allwaysAddressText.html(a)},behavior:function(){var t=this;this._behavior(),this.$btnBack.bind("touchend",(function(){return t._blur({onBlur:function(){!t.LOADING&&t._go_back()}}),!1})),this.$btnSave.bind("touchend",(function(){return t._blur({onBlur:function(){t.NEED_TO_SAVE&&!t.LOADING&&t.save({onReady:function(){setTimeout((function(){t._go_back()}),300)}})}}),!1})),this.$inputSubdomain.on("keyup",(function(e){t.is_need_to_save(),t.update_address_preview()}))},is_need_to_save:function(){""!==this.$inputSubdomain.val()?this._need2save(!0):this._need2save(!1)},update_address_preview:function(){var t=this.$inputSubdomain.val(),e="<strong>"+(t=""!==t?t:"yourname")+"</strong>."+CFG.www_url;this.$addressPreview.html(e)},is_correct_input:function(e){var i=t.LNG.get(["You cannot replace the name with the same","Вы не можете заменить имя на тоже самое"]);if(e==this.CAFE.subdomain)return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:i,btn_title:t.LNG.get("lng_close")}),!1;i=t.LNG.get(["Only Latin characters, numbers, and dashes are allowed for a name. The name must begin with a letter or number.","Для имени допустимы только бувы латинского алфавита, цифры и тире. Имя должно начинаться с буквы или цифры."]);if(!/^[0-9a-zA-Z].[\-0-9a-zA-Z]*$/g.test(e))return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:i,btn_title:t.LNG.get("lng_close")}),!1;i=t.LNG.get(["Name too short","Слишком короткое имя"]);return!(e.length<3)||(t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:i,btn_title:t.LNG.get("lng_close")}),!1)},load:function(e){var i=this,n=function(){t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:["<p>Невозможно загрузить информацию о Меню.</p>","<p>Попробуйте позже, или обратитесь к администратору сервиса</p>"].join(" "),btn_title:t.LNG.get("lng_close")})};this._now_loading(),this.AJAX=$.ajax({url:"adm/lib/lib.get_cafe_info.php?callback=?",dataType:"jsonp",data:{},method:"POST",success:function(t){console.log(t),i._end_loading(),t&&!t.error?(i._end_loading(),e&&e.onReady&&e.onReady(t.cafe)):t.error&&n()},error:function(t){console.log(t),i._end_loading(),n()}})},save:function(e){var i=this,n=t.INPUTS_LENGTH.get("new-subdomain"),s=$.clear_user_input(this.$inputSubdomain.val(),n);if(!this.is_correct_input(s))return!1;var o=function(e){var n=t.LNG.get([["<p>An email has been sent to <b>"+i.USER_EMAIL+"</b>.</p>","<p>Please, open the letter <nobr>and confirm</nobr> the name change.</p>"].join(""),["<p>На ваш адрес <b>"+i.USER_EMAIL+"</b> отправлено письмо.</p>","<p>Откройте письмо <nobr>и подтвердите</nobr> смену имени.</p>"].join("")]);t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:n,btn_title:t.LNG.get("lng_close"),on_close:function(){e&&e.on_close&&e.on_close()}})},a=function(){var e=t.LNG.get(["Something wrong. Please try later or ask to Service Administrator","Что-то пошло не так. Попробуйте позже или обратитесь к Администратору Сервиса"]);t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:e,btn_title:t.LNG.get("lng_close")})},_=function(){var e=t.LNG.get(["This address already exists, try a different name","Такой адрес уже существует, попробуйте другое имя"]);t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:e,btn_title:t.LNG.get("lng_close")})},r=function(){var e=t.LNG.get(["Forbidden address, try a different name","Запрещенный адрес, попробуйте другое имя"]);t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:e,btn_title:t.LNG.get("lng_close")})},l=function(){var e=t.LNG.get([["<p>Your Menu works in test mode.</p>","<p>To take full advantage of the service, please","go to Settings and select Remove limitations.</p>"].join(""),["<p>Ваше Меню работает в тестовом режиме.</p>","<p>Чтобы воспользоваться всеми возможностями сервиса, ","перейдите в Настройки и выберите пункт Снять ограничения.</p>"].join("")]);t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:e,btn_title:t.LNG.get("lng_close")})};if(2===parseInt(this.CAFE.cafe_status,10)){var h={id_cafe:this.CAFE.id,new_subdomain:s};this._now_loading(),this.AJAX=$.ajax({url:"adm/lib/usr.subdomain_update.php?callback=?",dataType:"jsonp",data:h,method:"POST",success:function(t){i._end_loading(),t&&!t.error?o({on_close:function(){e&&e.onReady&&e.onReady()}}):t.error&&-1!==t.error.indexOf("already exist")?_():t.error&&-1!==t.error.indexOf("illegal name")?r():t.error&&-1!==t.error.indexOf("limited mode")?l():a()},error:function(t){console.log(t),i._end_loading(),a()}})}else l()}},C={init:function(t){return this._init(t),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$btnSave=this.$view.find(".save"),this.$inputIikoKey=this.$form.find("input[name=iiko-api-key]"),this.$linkIikoHelp=this.$form.find("a[name=link-iiko-help]"),this.SITE_URL=CFG.base_url,this.USER_EMAIL=CFG.user_email,this.IIKO_HELP_URL="/iiko-connection",this.update_content_once(),this.reset(),this.behavior(),this},update:function(){var t=this;this._reset(),this._update(),this._page_hide(),this._update_tabindex(),t.update_content(),setTimeout((function(){console.log("NOW!"),t._page_show()}),300)},reset:function(){this._reset(),this._need2save(!1),this._page_to_top()},update_content_once:function(){this.$linkIikoHelp.attr({href:this.IIKO_HELP_URL})},update_content:function(){let e=t.THE_CAFE.get().iiko_api_key;e=e||"",this.$inputIikoKey.val(e)},behavior:function(){var t=this;this._behavior(),this.$btnBack.bind("touchend",(function(){return t._blur({onBlur:function(){!t.LOADING&&t._go_back()}}),!1})),this.$btnSave.bind("touchend",(function(){return t._blur({onBlur:function(){t.NEED_TO_SAVE&&!t.LOADING&&t.save_api_key()}}),!1})),this.$inputIikoKey.on("keyup",(function(e){t._need2save(""!==t.$inputIikoKey.val())}))},save_api_key:function(){const e=function(e){var i=t.LNG.get(["-","<p>Связь ChefsMenu с платформой iiko успешно установлена.<br>Сейчас Панель Управления будет перезагружена.</p>"]);t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:i,btn_title:t.LNG.get("lng_close"),on_close:function(){e&&e.onClose&&e.onClose()}})},i=function(e){e=e||"<p>Что-то пошло не так. Попробуйте позже или обратитесь к Администратору Сервиса</p>";t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:e,btn_title:t.LNG.get("lng_close")})};let n=this.$inputIikoKey.val();if(!this.is_correct_input(n))return this._end_loading(),!1;this._now_loading(),this.save_the_key_asynq(n).then((t=>{console.log("result",t),e({onClose:()=>{location.reload()}})})).catch((t=>{t&&t.error&&("string"==typeof t.error||t.error instanceof String)?-1!==t.error.indexOf("illegal name")?i("<p>Вероятно API Key содержит недопустимые символы, проверьте правильность вашего ключа.</p>"):-1!==t.error.indexOf("unknown login")?i("<p>Такой API LOGIN в Iiko не найден. Проверьте правильность введенного ключа.</p>"):-1!==t.error.indexOf("unknown organization")?i("<p>API LOGIN правильный, но не найдена ни одна организация, соответствующая данному логину в Iiko.</p>"):-1!==t.error.indexOf("has not terminal groups")?i("<p>Не найдена ни одна терминальная группа. Терминалы необходимы для отправки и приема заказов</p>"):-1!==t.error.indexOf("has not actual terminals")?i("<p>Не найден ни один активный терминал. Терминалы необходимы для отправки и приема заказов</p>"):-1!==t.error.indexOf("has not menus")?i("<p>API LOGIN правильный, но к нему не прикреплено ни одно Внешнее меню в Iiko.</p>"):i():i(),setTimeout((()=>{this._end_loading()}),300)}))},save_the_key_asynq:function(e){return new Promise(((i,n)=>{var s={id_cafe:t.THE_CAFE.get().id,new_iiko_api_key:e};this.AJAX=$.ajax({url:"adm/lib/iiko/lib.save_cafe_iiko_api_key.php?callback=?",dataType:"jsonp",data:s,method:"POST",success:function(t){console.log("result",t),t&&!t.error?i(t):n(t)},error:function(t){console.log("err result",t),n(t)}})}))},is_correct_input:function(e){const i=t.THE_CAFE.get().iiko_api_key;var n=t.LNG.get(["-","Вы не можете заменить ключ на тот же"]);if(e==i)return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:n,btn_title:t.LNG.get("lng_close")}),!1;n=t.LNG.get(["","Слишком короткий ключ API."]);if(e.length>0&&e.length<3)return t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:n,btn_title:t.LNG.get("lng_close")}),!1;n=t.LNG.get(["-","Для имени допустимы только бувы латинского алфавита, цифры и тире. Имя должно начинаться с буквы или цифры."]);return!!/^[0-9a-zA-Z].[\-0-9a-zA-Z]*$/g.test(e)||(t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:n,btn_title:t.LNG.get("lng_close")}),!1)}},R={init:function(t){return this._init(t),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$btnSave=this.$view.find(".save"),this.$inputDelKey=this.$form.find("input[name=iiko-del-key]"),this.$btnIikoKey=this.$form.find("button[name=iiko-api-key]"),this.$btnIikoTablesUpdate=this.$form.find(".btn-iiko-tables-update"),this.$btnIikoGetQrcodes=this.$form.find(".btn-iiko-get-qrcodes"),this.$linkIikoQRCodeTablesHelp=this.$form.find("a[name=link-iiko-qrcode-tables]"),this.$general_information=this.$form.find(".iiko-general-information"),this.$extmenu_list=this.$form.find(".iiko-extmenu-list"),this.$tables_list=this.$form.find(".iiko-table-sections"),this.$terminals_list=this.$form.find(".iiko-terminals-sections"),this.SITE_URL=CFG.base_url,this.USER_EMAIL=CFG.user_email,this.IIKO_QRCODE_TABLES_URL="/link-iiko-qrcode_tables",this.update_content_once(),this.reset(),this.behavior(),this},update:function(){var e=this;this.reset(),this._update(),this._page_hide(),this._update_tabindex();const i=t.THE_CAFE.get(),n=i.iiko_api_key;this.$btnIikoKey.html(n);let s="",o=""!==i.iiko_organizations?JSON.parse(i.iiko_organizations):{};this.CURRENT_ORGANIZATION_ID=o.current_organization_id;for(let t in o.items){let e=o.items[t];s+=["<p data-organization-id='"+e.id+"'>","<strong>"+e.name+"</strong><br>",e.address,"</p>"].join("")}this.$general_information.html(s);let a=i.iiko_terminal_groups?JSON.parse(i.iiko_terminal_groups):{};this.CURRENT_TERMINAL_GROUP_ID=a.current_terminal_group_id,this.update_terminal_groups_list(a);let _=i.iiko_tables?JSON.parse(i.iiko_tables):[];this.update_tables_list(_),this.$extmenu_list.html("");const r=""!==i.iiko_extmenus?JSON.parse(i.iiko_extmenus):{},l=r.items;if(this.CURRENT_EXTMENU_ID=r.current_extmenu_id.toString(),l.length>0)for(let t in l)if(l.hasOwnProperty(t)){let e=l[t],i=$('<div class="std-form__radio-button" data-menu-id="'+e.id+'">'+e.name+"</div>");i.on("touchend",(t=>{this._blur({onBlur:()=>{this.LOADING||this.VIEW_SCROLLED||$(t.target).hasClass("checked")||($(t.target).siblings().removeClass("checked"),$(t.target).addClass("checked"),this.new_current_exmenu_id($(t.target).data("menu-id")))}}),t.originalEvent.cancelable&&t.preventDefault()})),this.CURRENT_EXTMENU_ID==e.id&&i.addClass("checked"),this.$extmenu_list.append(i)}this.$extmenu_list.find(""),setTimeout((function(){e._page_show()}),300)},new_current_exmenu_id:function(t){this.NEW_IIKO_EXTMENU_ID=t.toString(),this.check_if_need2save()},check_if_need2save:function(){let e=!1;return t.THE_CAFE.get(),this.NEW_IIKO_EXTMENU_ID!=this.CURRENT_EXTMENU_ID&&(e=!0),"delete"==this.$inputDelKey.val()&&(e=!0),this._need2save(e),e},reset:function(){this._reset(),this._need2save(!1),this._page_to_top(),this.$inputDelKey.val(""),this.NEW_IIKO_EXTMENU_ID=""},update_content_once:function(){this.$linkIikoQRCodeTablesHelp.attr({href:this.IIKO_QRCODE_TABLES_URL})},behavior:function(){var e=this;this._behavior(),this.$btnBack.bind("touchend",(t=>{this._blur({onBlur:()=>{!this.LOADING&&this._go_back()}}),t.originalEvent.cancelable&&t.preventDefault()})),this.$inputDelKey.on("keyup",(()=>{this.check_if_need2save()})),this.$btnSave.bind("touchend",(function(t){e._blur({onBlur:function(){e.NEED_TO_SAVE&&!e.LOADING&&e.check_if_need2save()&&e.save()}}),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnIikoTablesUpdate.bind("touchend",(t=>{this._blur({onBlur:()=>{this.LOADING||e.VIEW_SCROLLED||this.iiko_tables_update()}}),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnIikoGetQrcodes.bind("touchend",(i=>{this._blur({onBlur:()=>{this.LOADING||e.VIEW_SCROLLED||(t.VIEW_IIKO_QRCODE_WITH_TABLES.update(),t.VIEWS.setCurrent(t.VIEW_IIKO_QRCODE_WITH_TABLES.name))}}),i.originalEvent.cancelable&&i.preventDefault()}))},update_terminal_groups_list:function(t){console.log("terminal_groups",t);let e="";for(let i in t.items)if(t.items.hasOwnProperty(i)){let n=t.items[i],s=n.address?n.address:"не указан";e+=`<li><strong>${n.name}</strong> (адрес: ${s})</li>`}e&&this.$terminals_list.html(e)},update_tables_list:function(t){if(t&&t.length>0){let e="";for(let i in t)if(t.hasOwnProperty(i)){let n=t[i];e+="<li>"+n.section_name+": "+n.tables.length+" столов</li>"}this.$tables_list.html(e)}else this.$tables_list.html("<li>Не найдено. Обновите столы.</li>")},iiko_tables_update:function(){const e=function(e){t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:"<p>Столы успешно обновлены</p>",btn_title:t.LNG.get("lng_close"),on_close:function(){e&&e.onClose&&e.onClose()}})},i=()=>{t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:"<p>Не найдены зарегистрированные Терминалы. Проверьте настройки Iiko.</p>",btn_title:t.LNG.get("lng_close")})},n=()=>{t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:"<p>Не удалось сохранить информацию. Проблема на стороне ChefsMenu. Попробуйте позже.</p>",btn_title:t.LNG.get("lng_close")})},s=()=>{t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:"<p>Что-то пошло не так. Попробуйте позже или обратитесь к Администратору Сервиса</p>",btn_title:t.LNG.get("lng_close")})};this._now_loading(),this.iiko_tables_update_asynq().then((t=>{console.log("vars",t),this.update_tables_list(t),e(),setTimeout((()=>{this._end_loading()}),300)})).catch((t=>{"string"==typeof t||t instanceof String?-1!==t.indexOf("has not actual terminals")?i():-1!==t.indexOf("cant update cafe info")?n():s():s(),setTimeout((()=>{this._end_loading()}),300)}))},save:function(){if("delete"==this.$inputDelKey.val())this.remove_iiko_login();else{const e=t.THE_CAFE.get().iiko_current_extmenu_id.toString();if(this.NEW_IIKO_EXTMENU_ID==e)return!1;this.save_new_current_extmenu_id()}return!1},save_new_current_extmenu_id:function(){const e=this,i=function(){let e=t.LNG.get(["-","<p>Что-то пошло не так. Попробуйте позже или обратитесь к Администратору Сервиса</p>"]);t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:e,btn_title:t.LNG.get("lng_close")})},n=this.NEW_IIKO_EXTMENU_ID.toString();let s={id_cafe:t.THE_CAFE.get().id,extmenu_id:n};this._now_loading(),this.AJAX=$.ajax({url:"adm/lib/iiko/lib.save_iiko_current_extmenu_id.php?callback=?",dataType:"jsonp",data:s,method:"POST",success:function(t){t&&!t.error?(e._go_back(),setTimeout((function(){e._end_loading()}),300)):(i(),setTimeout((()=>{e._end_loading()}),300))},error:function(t){i(),setTimeout((()=>{e._end_loading()}),300)}})},remove_iiko_login:function(){const e=function(e){let i=t.LNG.get(["-","<p>Связь ChefsMenu с платформой iiko успешно удалена.<br>Сейчас Панель управления будет перезагружена.</p>"]);t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:i,btn_title:t.LNG.get("lng_close"),on_close:function(){e&&e.onClose&&e.onClose()}})},i=function(){let e=t.LNG.get(["-","<p>Что-то пошло не так. Попробуйте позже или обратитесь к Администратору Сервиса</p>"]);t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:e,btn_title:t.LNG.get("lng_close")})};t.VIEWS.modalConfirm({title:"Внимание!",ask:"<p>Вы отправляете специальное слово. Хотите удалить связь с iiko?</p>",action:()=>{this._now_loading(),this.remove_iiko_api_login_asynq().then((t=>{e({onClose:()=>{location.reload()}})})).catch((t=>{i(),setTimeout((()=>{this._end_loading()}),300)}))},cancel:()=>!1,buttons:[t.LNG.get("lng_ok"),t.LNG.get("lng_cancel")]})},remove_iiko_api_login_asynq:function(){return new Promise(((e,i)=>{let n={id_cafe:t.THE_CAFE.get().id};this.AJAX=$.ajax({url:"adm/lib/iiko/iiko.remove_iiko_api_key.php?callback=?",dataType:"jsonp",data:n,method:"POST",success:function(t){t&&!t.error?e(t):i(t.error)},error:function(t){i(t)}})}))},iiko_tables_update_asynq:function(){return new Promise(((e,i)=>{let n=t.THE_CAFE.get(),s=this.CURRENT_ORGANIZATION_ID;if(!s)return i("неизвестный id организации"),!1;let o={id_cafe:n.id,api_login:n.iiko_api_key,organizationId:s,terminalGroupId:this.CURRENT_TERMINAL_GROUP_ID};this.AJAX=$.ajax({url:"adm/lib/iiko/iiko.tables_update.php?callback=?",dataType:"jsonp",data:o,method:"POST",success:function(t){console.log("result",t),t&&!t.error?e(t):i(t.error)},error:function(t){console.log("result",t),i(t)}})}))}},G={init:function(t){return this._init(t),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$btnSave=this.$view.find(".save"),this.$msgListEmpty=this.$form.find(".list-iiko-modif-dictionary__is-empty"),this.$msgListContainer=this.$form.find(".list-iiko-modif-dictionary"),this.reset(),this.behavior(),this},update:function(){this._reset(),this._update(),this._page_hide(),this._update_tabindex(),this.update_content_async().then((t=>{console.log("vars",t),this._page_show(),this._end_loading()}))},reset:function(){this._reset(),this._need2save(!1),this._page_to_top()},update_content_async:function(){return new Promise(((t,e)=>{this._load_iiko_modif_async().then((e=>{console.log("ARR_MODIF",e),e.length?(this.$msgListEmpty.hide(),this.$msgListContainer.show(),this.build_modif_list(),setTimeout((()=>{t("ok")}),300)):(this.$msgListEmpty.show(),this.$msgListContainer.hide(),t("ok"))})).catch((t=>{e(t)}))}))},behavior:function(){this._behavior(),this.$btnBack.bind("touchend",(t=>(this._blur({onBlur:()=>{!this.LOADING&&this._go_back()}}),!1)))},build_modif_list:function(){},_load_iiko_modif_async:function(){return new Promise(((e,i)=>{const n={id_cafe:t.THE_CAFE.get().id};this._now_loading(),this.AJAX=$.ajax({url:"adm/lib/iiko/iiko.get_modif_dictionary.php?callback=?",data:n,method:"POST",dataType:"jsonp",success:t=>{console.log("result",t),t&&!t.error?e(t):i(t)},error:t=>{i(t)}})}))}},O={init:function(t){return this._init(t),this.$btnBack=this.$footer.find(".back, .close, .cancel"),this.$btnSend=this.$view.find(".send"),this.$list_of_tables=this.$form.find(".iiko-qrcode-list-of-table-sections"),this.NEED_TO_SAVE=!1,this.reset(),this.behavior(),this},update:function(){var e=this;this.reset(),this._update(),this._page_hide(),this._update_tabindex();const i=t.THE_CAFE.get();let n=i.iiko_tables?JSON.parse(i.iiko_tables):[];this.update_tables_list(n),setTimeout((function(){e._page_show()}),300)},update_tables_list:function(t){if(console.log("table_sections",t),this.$list_of_tables.html(""),t&&t.length>0){let e="";for(let i in t)if(t.hasOwnProperty(i)){let n=t[i],s=n.section_name,o=n.section_id,a=n.tables;if(console.log("section",n),a.length){e+=`<h2>${s}</h2>`;let t="";for(let e in a)if(a.hasOwnProperty(e)){let i=a[e],n=s+": "+i.name;t+=`<li class="std-form__radio-button" \n\t\t\t\t\t\t\t\t\t\tdata-table-name="${n}" \n\t\t\t\t\t\t\t\t\t\tdata-table-number="${i.number}" \n\t\t\t\t\t\t\t\t\t\tdata-table-id="${i.id}">\n\t\t\t\t\t\t\t\t\t\t${n}</li>`}e+=`<ul class="std-form__structure" \n\t\t\t\t\t\t\t\tdata-section-id="${o}" \n\t\t\t\t\t\t\t\tdata-section-name="${s}">${t}</ul>`}}this.$list_of_tables.html(e),this.$list_of_tables.find("li").each(((t,e)=>{$(e).on("touchend",(t=>{this.LOADING||this.VIEW_SCROLLED||($(e).toggleClass("checked"),this.check_need_to_save()),t.originalEvent.cancelable&&t.preventDefault()}))}))}else this.$list_of_tables.html("<p>Нет зарегистрированных столов. Вернитесь назад и обновите столы.</p>")},reset:function(){this._reset(),this._need2save(!1),this._page_to_top()},check_need_to_save:function(){let t=this.get_all_checked_tables().length;return this._need2save(t),this.NEED_TO_SAVE=t,t},get_all_checked_tables:function(){let t=[];return this.$list_of_tables.find("li").each(((e,i)=>{if($(i).hasClass("checked")){let e=$(i).data("table-name"),n=$(i).data("table-id"),s=$(i).data("table-number");t.push({id:n,name:e,number:s})}})),t},behavior:function(){this._behavior(),this.$btnBack.bind("touchend",(t=>{this._blur({onBlur:()=>{!this.LOADING&&this._go_back()}}),t.originalEvent.cancelable&&t.preventDefault()})),this.$btnSend.bind("touchend",(t=>{this._blur({onBlur:()=>{this.NEED_TO_SAVE&&!this.LOADING&&this.save()}}),t.originalEvent.cancelable&&t.preventDefault()}))},save:function(){const e=CFG.user_email,i=function(i){var n=`<p>QR-коды успешно отправлены на адрес администратора (${e}).</p>`;t.VIEWS.modalMessage({title:t.LNG.get("lng_attention"),message:n,btn_title:t.LNG.get("lng_close"),on_close:function(){i&&i.onClose&&i.onClose()}})},n=function(){t.VIEWS.modalMessage({title:t.LNG.get("lng_error"),message:"<p>Что-то пошло не так. Попробуйте позже или обратитесь к Администратору Сервиса</p>",btn_title:t.LNG.get("lng_close")})};let s=this.get_all_checked_tables();s.length>0?(this._now_loading(),this.send_qr_codes_to_email_asynq(s).then((t=>{console.log("vars"),i({onClose:()=>{this._go_back()}}),setTimeout((()=>{this._end_loading()}),300)})).catch((t=>{console.log("vars"),n(),setTimeout((()=>{this._end_loading()}),300)}))):console.log("Nothing to save",s)},send_qr_codes_to_email_asynq:function(e){return new Promise(((i,n)=>{let s=t.THE_CAFE.get();if(!e.length)return n("невозможно отправить пустой список"),!1;let o={id_cafe:s.id,user_email:CFG.user_email,arr_tables:e};this.AJAX=$.ajax({url:"adm/lib/iiko/iiko.send_qrcode_for_tables.php?callback=?",dataType:"jsonp",data:o,method:"POST",success:function(t){console.log("result",t),t&&!t.error?i(t):n(t.error)},error:function(t){console.log("result",t),n(t)}})}))}},y={init:function(t){return this.name=t.name,this.anim=t.anim,this.$view=$(t.template).clone(),this.CLASS_NAME="app-view-modal-container",this.$title=this.$view.find("."+this.CLASS_NAME+"__title"),this.$message=this.$view.find("."+this.CLASS_NAME+"__message"),this.$btn_title=this.$view.find(".close span"),this.update_lng(),this.behavior(),this},update_lng:function(e){(e=e||this.$view).find("[lang]").each((function(e){$(this).html(t.LNG.get($(this).attr("lang")))}))},update:function(t){var e=t.title||"Information",i=t.message||"The message",n=t.btn_title||"Close";this.$title.html(e),this.$message.html(i),this.$btn_title.html(n),this.DO_AFTER_CLOSE=t.on_close},behavior:function(){var e=this;this.$view.on("touchstart",(function(t){t.preventDefault()})),this.$view.find(".close").on("touchend",(function(i){return t.VIEWS.hideModalMessage(),e.DO_AFTER_CLOSE&&e.DO_AFTER_CLOSE(),!1})),this.$view.find(".close").on("click",(function(){e.update({title:"Ой!",message:"Панель Управления создана для работы с телефона или планшета.",btn_title:"Закрыть"})}))}},M={init:function(t){return this.name=t.name,this.anim=t.anim,this.$view=$(t.template).clone(),this.CLASS_NAME="app-view-confirm-container",this.$title=this.$view.find("."+this.CLASS_NAME+"__title"),this.$ask=this.$view.find("."+this.CLASS_NAME+"__message"),this.$btn_ok=this.$view.find(".ok span"),this.$btn_cancel=this.$view.find(".cancel span"),this.update_lng(),this.behavior(),this},update_lng:function(e){(e=e||this.$view).find("[lang]").each((function(e){$(this).html(t.LNG.get($(this).attr("lang")))}))},update:function(t){var e=t.title||"Information",i=t.ask||"The message";this.$title.html(e),this.$ask.html(i),t.buttons&&(this.$btn_ok.html(t.buttons[0]),this.$btn_cancel.html(t.buttons[1])),this.CONFIRM_ACTION=t.action||function(){}},behavior:function(){var e=this;this.$view.find(".ok").on("touchend",(function(i){return t.VIEWS.hideModalConfirm(),e.CONFIRM_ACTION(!0),!1})),this.$view.find(".cancel").on("touchend",(function(i){return t.VIEWS.hideModalConfirm(),e.CONFIRM_ACTION(!1),!1}))}},D={init:function(t){return this.name=t.name,this.anim=t.anim,this.$view=$(t.template).clone(),this.update_lng(),this.behavior(),this},update_lng:function(e){(e=e||this.$view).find("[lang]").each((function(e){$(this).html(t.LNG.get($(this).attr("lang")))}))},page_hide:function(){this.$page.addClass("hidden")},page_show:function(){this.$page.removeClass("hidden")},now_loading:function(){this.LOADING=!0,this.$view.addClass("now-loading")},end_loading:function(){this.LOADING=!1,this.$view.removeClass("now-loading")},update_title:function(t){this.$viewTitleText.html(t)},need2save:function(t){this.NEED_TO_SAVE=t,t?this.$view.addClass("need-to-save"):this.$view.removeClass("need-to-save")},update:function(e,i,n){if(i&&this.$view.find(".view-title").html(i),n&&this.$view.find(".menu-title").html(n),e){var s=this.$view.find(".actions .table").html(""),o=$('<div class="tr"><span class="td button">{action}</span></div>');$.each(e,(function(e,i){console.log("param",i);var n=i[0],a=i[1],_=o.clone().find(".button").html(n).end().on("touchend",(function(e){return a(),t.VIEWS.hideActionSheet(),!1}));i[2]&&_.addClass(i[2]),s.append(_)}))}},behavior:function(){this.$view.find(".cancel, .view-content").on("touchend",(function(e){return t.VIEWS.hideActionSheet(),!1}))}},V={init:function(){return this.TOKEN=!1,this.ORGANIZATION_ID=!1,this.TERMINAL_GROUP_ID=!1,this.ARR_MENU_IDS=[],this.PRICE_CATEGORIES=null,this.CURRENT_MENU=0,this.NOW_LOADING=!1,this},load_extmenu_asynq:function(e){return new Promise(((i,n)=>{if(this.NOW_LOADING)return void n("Идет загрузка меню, попробуйте позже");this.NOW_LOADING=!0;let s=t.THE_CAFE.get().iiko_extmenus;s=!!s&&JSON.parse(s),(!s||!s.current_extmenu_id)&&n("--cant find current extmenu id"),s.current_extmenu_id,this.get_token_asynq().then((t=>{this.TOKEN=t,this.get_menu_by_id_asynq(e).then((t=>{this.NOW_LOADING=!1,i([t.menu,t["menu-hash"],t["need-to-update"]])})).catch((t=>{this.NOW_LOADING=!1,n(t)}))})).catch((t=>{console.log("err get token",t),n(t)}))}))},get_token_asynq:function(){return new Promise(((e,i)=>{let n=t.THE_CAFE.get(),s=this.get_token_localy();if(s)return void e(s);const o={id_cafe:n.id};$.ajax({url:"./adm/lib/iiko/get_token_for_cafe.php?callback=?",data:o,dataType:"jsonp",method:"POST",error:t=>{i(t)}}).then((t=>{t&&t.token?(s=t.token,this.save_token_localy(s),e(s)):i(t)}))}))},get_token_localy:function(){var e=t._IIKO_TOKEN,i=t._IIKO_TOKEN_DATE;if(e&&i){var n=((new Date).getTime()-i)/36e5;return console.log("duration",n),!n||n>.5?(console.log("token too old, and will be get new"),!1):e}return console.log("unknown token, will be get new"),!1},save_token_localy:function(e){t._IIKO_TOKEN=e,t._IIKO_TOKEN_DATE=(new Date).getTime()},get_menu_by_id_asynq:function(e){return new Promise(((i,n)=>{const s=t.THE_CAFE.get(),o={token:this.TOKEN,id_cafe:s.id,externalMenuId:e,currentExtmenuHash:s.iiko_current_extmenu_hash};$.ajax({url:"./adm/lib/iiko/get_menu_v2_by_id.php?callback=?",data:o,dataType:"jsonp",method:"POST",error:t=>{n(t)}}).then((t=>{i(t)&&!t.error?i[t]:n[t]}))}))}},W={init:function(t){return this.NEW_MENU=t.newMenu,this.ID_CAFE=t.id_cafe,this.roughMenuHash=t.roughMenuHash,this.start_update({onReady:function(e){console.log("res",e),t.onReady&&t.onReady("ok")},onError:function(e){t.onError&&t.onError(e)}}),this},start_update:function(t){var e={id_cafe:this.ID_CAFE,new_menu:this.NEW_MENU,rough_menu_hash:this.roughMenuHash},i="cant upgrading to menu from iiko";this.AJAX=$.ajax({url:"adm/lib/iiko/iiko.upgrade_to_menu_from_iiko.php?callback=?",dataType:"jsonp",data:e,method:"POST",success:function(e){e.error?(console.log(i),t.onError&&t.onError(e)):t.onReady&&t.onReady(e)},error:function(e){console.log(e),console.log(i),t.onError&&t.onError(i)}})}};return t.LNG=e,t.CURRENCY=n,t.MENU_ICONS=i,t.THE_CAFE=s,t.VIEWS=h,t.TABINDEX=o,t.DEVICE=a,t.MENU=_,t.ITEMS=r,t.INPUTS_LENGTH=l,t.IIKO_LOADER=V,t.IIKO_EXT_MENU_PARSER={parse:function(t){const e={id:t.id,name:t.name,categories:{},description:t.description};var i=t.itemCategories;for(var n in i){var s={id:i[n].id,name:i[n].name,items:{}};e.categories[s.id]=s;var o=i[n].items;for(var a in o){for(var _={id:o[a].itemId,name:o[a].name,description:o[a].description,measureUnit:o[a].measureUnit,sizes:[],imageUrl:"",modifiers:[],orderItemType:o[a].orderItemType,sku:o[a].sku},r=[],l=o[a].itemSizes,h=0;h<l.length;h++){var c=l[h];if(r.push({sizeCode:c.sizeCode,sizeId:c.sizeId,sizeName:c.sizeName,isDefault:c.isDefault,portionWeightGrams:c.portionWeightGrams,nutritionPerHundredGrams:c.nutritionPerHundredGrams,price:c.prices[0].price}),c.buttonImageUrl&&!_.imageUrl&&(_.imageUrl=c.buttonImageUrl),!_.modifiers.length&&c.itemModifierGroups&&c.itemModifierGroups.length){var d=c.itemModifierGroups,u=[];for(n=0;n<d.length;n++){for(var g={modifierGroupId:d[n].itemGroupId,name:d[n].name,restrictions:d[n].restrictions,items:[]},m=0;m<d[n].items.length;m++){var f=d[n].items[m];g.items.push({modifierId:f.itemId,name:f.name,description:f.description,portionWeightGrams:f.portionWeightGrams,restrictions:f.restrictions,nutritionPerHundredGrams:f.nutritionPerHundredGrams,price:f.prices[0].price})}u.push(g)}_.modifiers=u}}_.sizes=r,s.items[_.id]=_}}return e}},t.IIKO_UPDATER=W,t.VIEW_ALL_MENU=$.extend(d,c),t.VIEW_ALL_ITEMS=$.extend(u,c),t.VIEW_EDIT_MENU=$.extend(m,c),t.VIEW_EDIT_ITEM=$.extend(f,c),t.VIEW_GET_CONTRACT=$.extend(v,c),t.VIEW_CUSTOMIZE_ALL=$.extend(b,c),t.VIEW_ITEM_IMAGE_CHANGE=$.extend(E,c),t.VIEW_CUSTOMIZING_CAFE=$.extend(I,c),t.VIEW_CUSTOMIZING_CART=$.extend(A,c),t.VIEW_CUSTOMIZE_INTERFACE=$.extend(w,c),t.VIEW_CAFE_DESCRIPTION=$.extend(N,c),t.VIEW_MAIN_HELP=$.extend(p,c),t.VIEW_REPLACING_PARENT_SECTION=$.extend(T,c),t.VIEW_CAFE_LINK=$.extend(k,c),t.VIEW_CHANGE_PASSWORD=$.extend(L,c),t.VIEW_CHANGE_SUBDOMAIN=$.extend(S,c),t.VIEW_IIKO_ADDING_API_KEY=$.extend(C,c),t.VIEW_IIKO_CUSTOMIZATION=$.extend(R,c),t.VIEW_IIKO_MODIF_DICTIONARY=$.extend(G,c),t.VIEW_IIKO_QRCODE_WITH_TABLES=$.extend(O,c),t.VIEW_MODAL_MESSAGE=y,t.VIEW_MODAL_CONFIRM=M,t.VIEW_ACTION_SHEET=D,t.PARAMS={},function(){$((function(){window.onkeydown=t=>{"Tab"==t.key&&(console.log("tab!!!!"),t.preventDefault())},e.init(CFG.user_lang),i.init({LNG:e}),l.init(),n.init({THE_CAFE:s}),s.init(),o.init(),t.DEVICE.init(),t.MENU.init(),t.ITEMS.init(),h.init({viewsParent:"#the-app-views"}),h.addView(d.init({name:"all-menu-with-repos",template:"#templates .view-all-menu"})),h.addView(m.init({name:"view-edit-menu",template:"#templates .view-edit-menu",anim:"zoomOut"})),h.addView(b.init({name:"view-customize-all",template:"#templates .view-customize-all",anim:"zoomOut"})),h.addView(I.init({name:"view-customizing-cafe",template:"#templates .view-customizing-cafe",anim:"animLeft"})),h.addView(A.init({name:"view-customizing-cart",template:"#templates .view-customizing-cart",anim:"animLeft"})),h.addView(N.init({name:"view-cafe-description",template:"#templates .view-cafe-description",anim:"animLeft"})),h.addView(L.init({name:"view-change-password",template:"#templates .view-change-password",anim:"animLeft"})),h.addView(S.init({name:"view-change-subdomain",template:"#templates .view-change-subdomain",anim:"animLeft"})),h.addView(C.init({name:"view-iiko-adding-api-key",template:"#templates .view-iiko-adding-api-key",anim:"animLeft"})),h.addView(R.init({name:"view-iiko-customization",template:"#templates .view-iiko-customization",anim:"animLeft"})),h.addView(G.init({name:"view-iiko-modif-dictionary",template:"#templates .view-iiko-modif-dictionary",anim:"animLeft"})),h.addView(O.init({name:"view-iiko-qrcode-with-tables",template:"#templates .view-iiko-qrcode-with-tables",anim:"animLeft"})),h.addView(k.init({name:"view-cafe-link",template:"#templates .view-cafe-link",anim:"animLeft"})),h.addView(w.init({name:"view-customize-interface",template:"#templates .view-customize-interface",anim:"animLeft"})),h.addView(u.init({name:"all-items",template:"#templates .view-all-items",template_item:"#templates .item-slide-template-4 .item"})),h.addView(f.init({name:"view-edit-item",template:"#templates .view-edit-item",anim:"zoomOut"})),h.addView(E.init({name:"view-item-image-change",template:"#templates .view-item-image-change",anim:"zoomOut"})),h.addView(T.init({name:"view-replacing-parent-section",template:"#templates .view-replacing-parent-section",anim:"animLeft"})),h.addView(v.init({name:"view-get-contract",template:"#templates .view-get-contract",anim:"animLeft"})),h.addView(p.init({name:"view-main-help",template:"#templates .view-main-help",anim:"zoomOut"})),h.addView(D.init({name:"view-action-sheet",template:"#templates .view-action-sheet"})),h.addView(M.init({name:"view-modal-confirm",template:"#templates .view-modal-confirm"})),h.addView(y.init({name:"view-modal-message",template:"#templates .view-modal-message"})),d.update(CFG.id_user),h.setCurrent(d.name)}))}}();
